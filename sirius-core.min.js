/*
 Sirius.js v0.8.5
  (c) 2014-2015 fntz
  license: MIT
*/
var Adapter,Sirius,VanillaJsAdapter,slice=[].slice,extend=function(a,b){function c(){this.constructor=a}for(var f in b)hasProp.call(b,f)&&(a[f]=b[f]);c.prototype=b.prototype;a.prototype=new c;a.__super__=b.prototype;return a},hasProp={}.hasOwnProperty;Sirius={VERSION:"0.8.5"};
Adapter=function(){function a(){}a.prototype.bind=function(b,c,a,e){};a.prototype.off=function(b,c,a,e){};a.prototype.fire=function(){3<=arguments.length&&slice.call(arguments,2)};a.prototype.get_property=function(){2<=arguments.length&&slice.call(arguments,1)};a.prototype.get_attr=function(b,c){};a.prototype.set_prop=function(b,c,a){};a.prototype.swap=function(b,c){};a.prototype.append=function(b,c){};a.prototype.prepend=function(b,c){};a.prototype.clear=function(b){};a.prototype.set_attr=function(b,
c,a){};a.prototype.all=function(b){return"object"===typeof b&&1===b.nodeType||9===b.nodeType?b:document.querySelectorAll(b)};a.prototype.get=function(b){return document.querySelector(b)};a.prototype.state=function(b){};return a}();
VanillaJsAdapter=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}extend(b,a);b.prototype._get_element_from_selector=function(b){if("object"===typeof b&&1===b.nodeType)return b;var c=this.all(b);if(0===c.length)throw Error("Selector `"+b+"` not found");return c[0]};b.prototype.bind=function(b,a,e,d){var c,f;if(null===a||a===b)b.addEventListener(e,d);else if("object"===typeof a&&1===a.nodeType)a.addEventListener(e,d);else for(b=this.all(a),a=c=0,f=b.length;0<=f?c<f:c>f;a=
0<=f?++c:--c)b.item(a).addEventListener(e,d)};b.prototype.off=function(b,a,e,d){var c,f;if(null===a||a===b)b.removeEventListener(e,d);else for(b=this.all(a),a=c=0,f=b.length;0<=f?c<f:c>f;a=0<=f?++c:--c)b.item(a).removeEventListener(e,d)};b.prototype.fire=function(){var b=arguments[1];var a=3<=arguments.length?slice.call(arguments,2):[];var e=document.createEvent("CustomEvent");e.initCustomEvent(b,!1,!0,a);document.dispatchEvent(e)};b.prototype.get_property=function(b,a){var c;var d=b.target;var f=
[];var g=0;for(c=a.length;g<c;g++){var h=a[g];f.push(this.get_attr(d,h))}return f};b.prototype.get_attr=function(b,a){var c=this._get_element_from_selector(b);var d=c.getAttribute(a);return null==d?c[a]:d};b.prototype.swap=function(b,a){var c=this._get_element_from_selector(b);var d=c.tagName;"INPUT"===d||"TEXTAREA"===d||"SELECT"===d?c.value=a:c.textContent=a};b.prototype.set_attr=function(b,a,e){this._get_element_from_selector(b).setAttribute(a,e)};b.prototype.set_prop=function(b,a,e){this._get_element_from_selector(b).setAttribute(a,
e)};b.prototype.append=function(b,a){var c=this._get_element_from_selector(b);c.textContent+=a};b.prototype.prepend=function(b,a){var c=this._get_element_from_selector(b);c.textContent=a+c.textContent};b.prototype.clear=function(b){b=this._get_element_from_selector(b);var a=b.tagName;"INPUT"===a||"TEXTAREA"===a?b.value="":b.textContent=""};b.prototype.text=function(b){b=this._get_element_from_selector(b);var a=b.tagName;return"INPUT"===a||"TEXTAREA"===a||"SELECT"===a?b.value:b.innerText?b.innerText:
b.textContent};b.prototype.get_state=function(b){return this._get_element_from_selector(b).checked};return b}(Adapter);
Sirius.Logger=function(){function a(b,a,f){var c;var d=Sirius.Logger.Filters;var k=0;for(c=d.length;k<c;k++){var g=d[k];this[Sirius.Utils.underscore(g).toLowerCase()]=g}var h=Sirius.Logger.Levels;g=function(c){return function(e){return c[e]=function(c,g){if(b){if(!g)return f(e.toUpperCase(),c);if(-1!==a.indexOf(g)||null==g||-1===d.indexOf(g))return c="["+g.toUpperCase()+"] "+c,f(e.toUpperCase(),c)}}}}(this);var p=0;for(k=h.length;p<k;p++)c=h[p],g(c)}a.Levels=["debug","info","warn","error"];a.Filters=
"BaseModel Binding Collection View Routing Application Redirect Validation Transformer".split(" ");return a}();Sirius.Internal={};Sirius.Promise=function(){function a(b){this.value=b;this.fn=function(){}}a.prototype.and_then=function(b){return null!=this.value?b(this.value):this.fn=b};a.prototype.set_value=function(b){this.value=b;return this.fn(b)};return a}();
Sirius.Utils=function(){function a(){}a.is_function=function(b){return"[object Function]"===Object.prototype.toString.call(b)};a.is_string=function(b){return"[object String]"===Object.prototype.toString.call(b)};a.is_array=function(b){return"[object Array]"===Object.prototype.toString.call(b)};a.is_object=function(b){return null!==b&&"object"===typeof b};a.camelize=function(b){return b.charAt(0).toUpperCase()+b.slice(1)};a.underscore=function(b){return b.replace(/([A-Z])/g,"_$1").replace(/^_/,"").toLowerCase()};
a.ie_version=function(){var b=window.navigator.userAgent;var a=b.indexOf("MSIE ");var f=b.indexOf("Trident/");return 0<a?parseInt(b.substring(a+5,b.indexOf(".",a)),10):0<f?(a=b.indexOf("rv:"),parseInt(b.substring(a+3,b.indexOf(".",a)),10)):0};a.is_ie9=function(){return 9===this.ie_version()};a.fn_name=function(b){if(this.is_function(b))return b.toString().match(/function ([^\(]+)/)[1];throw Error("Need function, given "+typeof b);};return a}();
Sirius.redirect=function(a){var b=Sirius.Application;b.logger.info("Redirect to "+a,b.logger.redirect);b.use_hash_routing_for_old_browsers&&!b.push_state_support&&(a=0===a.indexOf("#")?a:0===a.indexOf("/")?"#"+a:"#/"+a);if(0===a.indexOf("#")){if(b.push_state_support)return location.replace(a)}else if(b.push_state_support)return Sirius.Internal.RouteSystem.dispatch.call(null,{type:"redirect",target:{href:a}})};
Sirius.Internal.RoutePart=function(){function a(b){this.end=!0;this.start=null;this.parts=[];this.args=[];b=b.replace(/\/$/,"").split("/");""===b[0]&&(b[0]="#");"*"===b[b.length-1]&&(this.end=!1);this.parts=b.slice(0)}a.prototype.match=function(b){this.args=[];var a=b.replace(/\/$/,"").split("/");""===a[0]&&(a[0]="#");if(a.length!==this.parts.length&&this.end||1<this.parts.length&&a.length<this.parts.length)return!1;var f=function(a){return 0===a.indexOf(":")};var e=function(a){return 0===a.indexOf("[")};
var d=function(a){return 0===a.indexOf("*")};var k=-1;for(b=[];10>k;){k++;var g=[this.parts[k],a[k]];var h=g[0];g=g[1];if(!h||!g)break;if(f(h))b.push(a[k]);else if(e(h)){h=new RegExp("^"+h+"$");if(!h.test(g))return!1;b.push(h.exec(g)[0])}else{if(d(h)){b=b.concat(a.slice(k));break}if(h!==g)return!1}}this.args=b;return!0};return a}();
Sirius.Internal.ControlFlow=function(){function a(a,c){null==c&&(c=function(a){return a});this.logger=Sirius.Application.get_logger();var b;if(!(b=a.controller))throw Error("Params must contain a Controller");var e=a.action;if(Sirius.Utils.is_string(e))var d=b[e];else if(Sirius.Utils.is_function(e))d=e;else throw d="Action must be string or function",this.logger.error("ControlFlow: "+d,this.logger.routing),Error(d);if(!d)throw d="action "+e+" not found in controller "+b,this.logger.error("ControlFlow: "+
d,this.logger.routing),Error(d);this.action=c(d);d=function(c,d){null==d&&(d=!1);var f=a[c];var g=b[c+"_"+e];var n=function(a){return Error(a+" action must be string or function")};if(Sirius.Utils.is_string(f)){g=b[f];if(!Sirius.Utils.is_function(g))throw n(Sirius.Utils.camelize(c));return g}if(Sirius.Utils.is_function(f))return f;if(f)throw n(Sirius.Utils.camelize(c));if(g){if(!Sirius.Utils.is_function(g))throw n(Sirius.Utils.camelize(c));return g}return d?null:function(){}};this.before=d("before");
this.after=d("after");this.guard=d("guard",!0);this.data=a.data||null;this.controller=b}a.prototype.handle_event=function(){var a;var c=arguments[0];var f=2<=arguments.length?slice.call(arguments,1):[];this.logger.debug("ControlFlow: Start event processing",this.logger.routing);if(c){var e=Sirius.Utils.is_array(this.data)?this.data:this.data?[this.data]:[];e=Sirius.Application.adapter.get_property(c,e);c=[].concat([],[c],e);c=(a=[]).concat.apply(a,[[],c].concat(slice.call(f)));if(this.guard){if(this.guard.apply(this.controller,
c))return this.before.apply(this.controller),this.action.apply(this.controller,c),this.after.apply(this.controller)}else return this.before.apply(this.controller),this.action.apply(this.controller,c),this.after.apply(this.controller)}else if(f=[].concat.apply([],f),this.guard){if(this.guard.apply(this.controller,f))return this.before.apply(this.controller),this.action.apply(this.controller,f),this.after.apply(this.controller)}else return this.before.apply(this.controller),this.action.apply(this.controller,
f),this.after.apply(this.controller)};a.prototype.tick=function(){this.logger.debug("ControlFlow: tick",this.logger.routing);if(this.guard){if(this.guard.apply(this.controller))return this.before.apply(this.controller),this.action.apply(this.controller),this.after.apply(this.controller)}else return this.before.apply(this.controller),this.action.apply(this.controller),this.after.apply(this.controller)};return a}();
Sirius.Internal.RouteSystem={_every:"every",_scheduler:"scheduler",_once:"once",_selector:"a:not([href^='#'])",_is_hash_route:function(a){return 0===a.toString().indexOf("#")},_is_404_route:function(a){return"404"===a.toString()},_is_plain_route:function(a){return 0===a.toString().indexOf("/")},_is_scheduler_command:function(a){return 0===a.lastIndexOf(this._scheduler)||0===a.lastIndexOf(this._once)||0===a.lastIndexOf(this._every)},_is_event_route:function(a){return!this._is_hash_route(a)&&!this._is_404_route(a)&&
!this._is_plain_route(a)&&!this._is_scheduler_command(a)},_get_time_unit:function(a,b){var c;if(c=b.match(/^(\d+)(ms|s|m)/)){var f=parseInt(c[1],10);c=c[2]||"s";return"ms"===c?f:"s"===c?1E3*f:6E4*f}throw Error("Bad time unit: "+b+" in "+a+", available units: 'ms', 's', 'm'");},_get_scheduler_params:function(a){var b=a.split(" ");var c="Define time unit for scheduler, for example: 'every 10s', given: "+a;if(1===b.length)throw Error(c);if(2===b.length)return c=Sirius.Internal.RouteSystem._get_time_unit(a,
b[1]),{delay:null,time:c};if(3===b.length)return c=Sirius.Internal.RouteSystem._get_time_unit(a,b[1]),a=Sirius.Internal.RouteSystem._get_time_unit(a,b[2]),{delay:c,time:a};throw Error(c);},_scheduler_register:function(a,b,c,f){var e;var d=this._every;var k=this._scheduler;var g=this._get_scheduler_params;var h=[];for(e in a)c=a[e],this._is_scheduler_command(e)&&h.push(function(a,c){var e=Sirius.Utils.is_function(c)?b(c):function(){return(new Sirius.Internal.ControlFlow(c,b)).tick()};var h=g(a);f.debug("Define scheduler for '"+
a+"' with "+JSON.stringify(h),f.routing);return 0===a.lastIndexOf(d)||0===a.lastIndexOf(k)?null===h.delay?setInterval(e,h.time):setTimeout(function(){return setInterval(e,h.time)},h.delay):null===h.delay?setTimeout(e,h.time):setTimeout(function(){return setTimeout(e,h.time)},h.delay)}(e,c));return h},_event_register:function(a,b,c,f){var e;var d=[];for(e in a){var k=a[e];this._is_event_route(e)&&d.push(function(a,d){var e=Sirius.Utils.is_function(d)?b(d):function(){var a=arguments[0];var c=2<=arguments.length?
slice.call(arguments,1):[];return(new Sirius.Internal.ControlFlow(d,b)).handle_event(a,c)};var g=a.match(/^([a-zA-Z:]+)(\s+)?(.*)?/);var h=g[1];g=g[3]||document;c.bind(document,g,h,e);return f.debug("RouteSystem: define event route: '"+h+"' for '"+g+"'",f.routing)}(e,k))}return d},_get_hash_routes:function(a,b,c,f){var e=[];for(d in a)if(c=a[d],this._is_hash_route(d)){f.info("RouteSystem: define hash route: '"+d+"'",f.routing);var d=new Sirius.Internal.RoutePart(d);c=Sirius.Utils.is_function(c)?b(c):
new Sirius.Internal.ControlFlow(c,b);e.push([d,c])}return e},_get_plain_routes:function(a,b,c,f){var e=[];for(d in a)if(c=a[d],this._is_plain_route(d)){f.debug("RouteSystem: define route: '"+d+"'",f.routing);var d=new Sirius.Internal.RoutePart(d);c=Sirius.Utils.is_function(c)?b(c):new Sirius.Internal.ControlFlow(c,b);e.push([d,c])}return e},create:function(a,b,c){var f;null==c&&(c=function(){});var e=Sirius.Application.get_logger();var d=f=window.location.hash;var k=b.old;var g=b.support;var h=b.ignore;
return Sirius.Application.get_adapter().and_then(function(b){return function(n){if(k&&!g){e.info("RouteSystem: Convert plain routing into hash routing",e.routing);var p=[];var q={};for(l in a){var y=a[l];b._is_hash_route(l)&&p.push(l);if(b._is_plain_route(l)){var l="#"+l;-1!==p.indexOf(l)&&e.warn("RouteSystem: Routes already defined '"+l+"' url",e.routing)}q[l]=y}a=q}var r=function(a){var b;var c=Sirius.Application.controller_wrapper;for(b in c){var d=c[b];this[b]=d}return a};b._event_register(a,
r,n,e);b._scheduler_register(a,r,n,e);var z=b._get_hash_routes(a,r,n,e);var w=b._get_plain_routes(a,r,n,e);var x=function(a){return a.preventDefault?a.preventDefault():a.returnValue=!1};var u=function(b){var c,k,p;f=d;var l=p=!1;e.info("RouteSystem: start processing route: '"+d+"'",e.routing);if("hashchange"===b.type){var v=z;d=window.location.hash;var m=window.location.origin;l=!0;g?history.pushState({href:d},""+d,m+"/"+d):history.replaceState({href:d},""+d,m+"/"+d)}else v=w,m=b.target.href,"popstate"!==
b.type&&g&&history.pushState({href:m},""+m,m),m=window.location.pathname,""===m&&(m="/"),d=m;var q=0;for(c=v.length;q<c;q++){var t=v[q];m=t[0];(k=m.match(d))&&!p&&(p=!0,t=t[1],t.handle_event?t.handle_event(null,m.args):t.apply(null,m.args))}p?(x(b),e.debug("RouteSystem: Url change to: "+d,e.routing),n.fire(document,"application:urlchange",d,f)):h?(l&&e.warn("Seems you ignore hash based urls: "+d),e.debug("ignore_not_matched_urls is enabled, url was not matched: '"+d+"'")):(e.warn("RouteSystem: route '"+
d+"' not found. Generate 404 event",e.routing),n.fire(document,"application:404",d,f),(l=a["404"]||a[404])&&(Sirius.Utils.is_function(l)?r(l)(d):(new Sirius.Internal.ControlFlow(l,r)).handle_event(null,d)),x(b))};b.dispatch=u;0!==w.length&&n.bind(document,b._selector,"click",u);window.onhashchange=u;g&&n.bind(window,null,"popstate",function(a){if(history&&null!=history.state&&void 0!==history.state.href&&0!==history.state.href.indexOf("#"))return u(a)});return c()}}(this))}};
Sirius.Application={log:!1,adapter:null,running:!1,route:{},start:!1,controller_wrapper:{redirect:Sirius.redirect},mix_logger_into_controller:!0,use_hash_routing_for_old_browsers:!0,ignore_not_matched_urls:!0,default_log_function:function(a,b){return console&&console.log?console.log(a+": "+b):alert("Not supported `console`. You should define own `logger` function for Sirius.Application")},log_filters:[],_wait:[],_messages_queue:[],get_logger:function(){var a;if(this.logger)return this.logger;var b=
Sirius.Logger.Levels;var c={};var f=this._messages_queue;var e=function(a){return c[a]=function(b,c){return f.push([a,b,c])}};var d=0;for(a=b.length;d<a;d++){var k=b[d];e(k)}a=Sirius.Logger.Filters;k=0;for(d=a.length;k<d;k++)e=a[k],c[Sirius.Utils.underscore(e).toLowerCase()]=e;return c},get_adapter:function(){if(null==this.adapter){var a=new Sirius.Promise;this._wait.push(a);return a}return new Sirius.Promise(this.adapter)},run:function(a){var b;null==a&&(a={});var c=function(b,c){return null!=a[b]?
a[b]:c};this.running=!0;this.log=a.log||this.log;this.adapter=a.adapter||new VanillaJsAdapter;this.route=a.route||this.route;this.mix_logger_into_controller=c("mix_logger_into_controller",this.mix_logger_into_controller);this.log_filters=a.log_filters||this.log_filters;this.ignore_not_matched_urls=c("ignore_not_matched_urls",this.ignore_not_matched_urls);if("all"===this.log_filters)this.log_filters=Sirius.Logger.Filters;else if(0<this.log_filters.length){var f=Sirius.Logger.Filters;var e=this.log_filters;
if("number"===typeof this.log_filters[0]){var d=e.sort()[e.length-1];var k=e.sort()[0];if(0>k)throw Error("Undefined index for log filters "+k);if(d>f.length)throw Error("Undefined index for log filters "+d);this.log_filters=e.map(function(a){return f[a]})}else if(d=this.log_filters.filter(function(a){return-1===f.indexOf(a)}),0!==d.length)throw Error("Check log filters given `"+e+"`. Allow "+f);}else this.log_filters=[];this.logger=new Sirius.Logger(this.log,this.log_filters,a.logger||this.default_log_function);
this.start=a.start||this.start;e=a.controller_wrapper||{};for(b in e)d=e[b],this.controller_wrapper[b]=d;this.hash_always_on_top=c("hash_always_on_top",this.hash_always_on_top);this.use_hash_routing_for_old_browsers=c("use_hash_routing_for_old_browsers",this.use_hash_routing_for_old_browsers);this.logger.info("Logger enabled? "+this.log,this.logger.application);this.logger.info("Log filters: "+this.log_filters,this.logger.application);this.logger.info("Adapter: "+Sirius.Utils.fn_name(this.adapter.constructor),
this.logger.application);this.logger.info("Use hash routing for old browsers: "+this.use_hash_routing_for_old_browsers,this.logger.application);this.logger.info("Current browser: "+navigator.userAgent,this.logger.application);this.logger.info("Ignore not matched urls: "+this.ignore_not_matched_urls,this.logger.application);this.push_state_support=history.pushState?!0:!1;this.logger.info("History pushState support: "+this.push_state_support,this.logger.application);!this.push_state_support&&this.use_hash_routing_for_old_browsers&&
this.logger.warn("You browser not support pushState, and you disable hash routing for old browser",this.logger.application);this.logger.info("Mix logger in controllers "+this.mix_logger_into_controller,this.logger.application);this.mix_logger_into_controller&&(this.controller_wrapper.logger&&this.logger.warn("Logger method already in `controller_wrapper`",this.logger.application),c=this.logger,this.controller_wrapper.logger={info:c.info,debug:c.debug,warn:c.warn,error:c.error});Sirius.Internal.RouteSystem.create(this.route,
{old:this.use_hash_routing_for_old_browsers,support:this.push_state_support,ignore:this.ignore_not_matched_urls},function(a){return function(){var b;var c=a._wait;var d=0;for(b=c.length;d<b;d++){var e=c[d];e.set_value(a.adapter)}a.adapter.fire(document,"application:run",new Date);c=a._messages_queue;var f=[];b=0;for(d=c.length;b<d;b++)e=c[b],f.push(a.logger[e[0]].call(null,e[1],e[2]));return f}}(this));if(this.start)return Sirius.redirect(this.start)}};
