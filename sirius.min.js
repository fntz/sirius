/*!
 *  Sirius.js v0.1.2
 *  (c) 2014 fntzr
 *  license: MIT
 */
;var Sirius,__slice=[].slice,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Sirius={VERSION:"0.1.2"};Sirius.redirect=function(a){return location.replace(a)};Sirius.Utils=(function(){function a(){}a.is_function=function(b){return Object.prototype.toString.call(b)==="[object Function]"};a.is_string=function(b){return Object.prototype.toString.call(b)==="[object String]"};a.is_array=function(b){return Object.prototype.toString.call(b)==="[object Array]"};a.camelize=function(b){return b.charAt(0).toUpperCase()+b.slice(1)};a.underscore=function(b){return b.replace(/([A-Z])/g,"_$1").replace(/^_/,"").toLowerCase()};return a})();Sirius.RoutePart=(function(){function a(b){var c;this.end=true;this.start=null;this.parts=[];this.args=[];c=b.replace(/\/$/,"").split("/");if(c[c.length-1]==="*"){this.end=false}this.parts=c.slice(0)}a.prototype.match=function(c){var k,l,f,j,m,d,e,g,b,h;this.args=[];g=c.replace(/\/$/,"").split("/");if((g.length!==this.parts.length)&&this.end){return false}if((this.parts.length>1)&&g.length<this.parts.length){return false}d=function(i){return i.indexOf(":")===0};e=function(i){return i.indexOf("[")===0};m=function(i){return i.indexOf("*")===0};j=-1;k=[];while(j<10){j++;h=[this.parts[j],g[j]],l=h[0],f=h[1];if(!l||!f){break}if(d(l)){k.push(g[j]);continue}if(e(l)){b=new RegExp("^"+l+"$");if(!b.test(f)){return false}k.push(b.exec(f)[0]);continue}if(m(l)){k=k.concat(g.slice(j));break}if(l!==f){return false}}this.args=k;return true};return a})();Sirius.ControlFlow=(function(){function a(e){var c,b,d;b=e.controller||(function(){throw new Error("Params must contain a Controller")})();c=e.action;this.action=(function(){if(Sirius.Utils.is_string(c)){return b[c]}else{if(Sirius.Utils.is_function(c)){return c}else{throw new Error("Action must be string or function")}}})();if(!Sirius.Utils.is_function(this.action)&&!Sirius.Utils.is_string(this.action)){throw new Error("Action must be string or function")}d=(function(f){return function(l,g){var j,h,m,i;if(g==null){g=false}m=e[l];h=b[""+l+"_"+c];j=function(k){return new Error(""+k+" action must be string or function")};if(Sirius.Utils.is_string(m)){i=b[m];if(!Sirius.Utils.is_function(i)){throw j(Sirius.Utils.camelize(l))}return i}else{if(Sirius.Utils.is_function(m)){return m}else{if(m){throw j(Sirius.Utils.camelize(l))}else{if(h){if(!Sirius.Utils.is_function(h)){throw j(Sirius.Utils.camelize(l))}return h}else{if(!g){return function(){}}else{return null}}}}}}})(this);this.before=d("before");this.after=d("after");this.guard=d("guard",true);this.data=e.data||null}a.prototype.handle_event=function(){var b,c,d,f;d=arguments[0],b=2<=arguments.length?__slice.call(arguments,1):[];if(d){c=Sirius.Utils.is_array(this.data)?this.data:this.data?[this.data]:[];c=Sirius.Application.adapter.get_property(d,c);f=[].concat([],[d],c);if(this.guard){if(this.guard.apply(null,f)){this.before();this.action.apply(null,f);return this.after()}}else{this.before();this.action.apply(null,f);return this.after()}}else{if(this.guard){if(this.guard.apply(null,b)){this.before();this.action.apply(null,b);return this.after()}}else{this.before();this.action.apply(null,b);return this.after()}}};return a})();Sirius.RouteSystem={create:function(a,d){var f,b,g,e,c;if(d==null){d=function(){}}g=e=window.location.hash;for(c in a){f=a[c];if(c.indexOf("#")!==0&&c.toString()!=="404"){(function(h){return(function(j,l){var m,k,i,n;k=Sirius.Utils.is_function(l)?l:function(o){return(new Sirius.ControlFlow(l)).handle_event(o)};n=j.match(/^([a-zA-Z:]+)(\s+)?(.*)?/);m=n[1];i=n[3]||document;return Sirius.Application.adapter.bind(i,m,k)})})(this)(c,f)}}b=(function(){var h;h=[];for(c in a){f=a[c];if(c.toString()!=="404"){h.push((function(i,j){i=new Sirius.RoutePart(i);j=Sirius.Utils.is_function(j)?j:new Sirius.ControlFlow(j);return[i,j]})(c,f))}}return h})();window.onhashchange=(function(h){return function(m){var k,p,i,n,o,l,j;e=g;g=window.location.hash;i=false;Sirius.Application.logger("Url change to: "+g);Sirius.Application.adapter.fire(document,"application:hashchange",g,e);o=function(q){var t,s,u;t=q[0];s=t.match(g);if(s&&!i){i=true;u=q[1];if(u.handle_event){u.handle_event(null,t.args)}else{u.apply(null,t.args)}}};for(l=0,j=b.length;l<j;l++){k=b[l];o(k)}if(!i){Sirius.Application.adapter.fire(document,"application:404",g,e);p=a["404"];if(p){n=new Sirius.ControlFlow(p);return n.handle_event(null,g)}}}})(this);return d()}};Sirius.Application={log:false,adapter:null,running:false,route:{},start:"#",logger:function(a){if(!this.log){return}if(window.console){return console.log(a)}else{return alert("Not supported `console`")}},run:function(a){var b;if(a==null){a={}}this.running=true;this.log=a.log||this.log;this.adapter=a.adapter||(function(){throw new Error("Specify adapter")})();this.route=a.route||this.route;this.logger=a.logger||this.logger;this.start=a.start||this.start;this.logger("Logger enabled? "+this.log);b=this.adapter.constructor.name;this.logger("Adapter: "+b);Sirius.RouteSystem.create(this.route,(function(c){return function(){return c.adapter.fire(document,"application:run",new Date())}})(this));if(this.start){return Sirius.redirect(this.start)}}};Sirius.BaseModel=(function(){a.attrs=[];a.has_many=[];a.has_one=[];a.belongs_to=[];a.to={};a.form_name=null;a.guid_for=null;a.validate={};a.prototype.attrs=function(){return this.constructor.attrs||[]};a.prototype.normal_name=function(){return Sirius.Utils.underscore(this.constructor.name)};a.prototype.has_many=function(){return this.constructor.has_many||[]};a.prototype.has_one=function(){return this.constructor.has_one||[]};a.prototype.belongs_to=function(){return this.constructor.belongs_to||[]};a.prototype.validators=function(){return this.constructor.validate};a.prototype.guid_for=function(){return this.constructor.guid_for};a.prototype.normalize_attrs=function(){var d,f,c,e,b;e=this.constructor.attrs;b=[];for(f=0,c=e.length;f<c;f++){d=e[f];b.push((function(g){if(typeof g==="object"){return Object.keys(g)[0]}else{return g}})(d))}return b};function a(m){var n,o,t,l,f,e,c,b,p,s,r,q,k,j,i,h,d;if(m==null){m={}}this._isValid=false;this.errors={};this.attributes=this.normalize_attrs();k=this.attrs();for(f=0,p=k.length;f<p;f++){n=k[f];if(typeof n==="object"){j=Object.keys(n),t=j[0];if(!t){throw new Error("Attributes should have a key and value")}this["_"+t]=n[t]}else{this["_"+n]=null}}i=this.has_many();for(e=0,s=i.length;e<s;e++){l=i[e];this["_"+l]=[];this.attributes.push(""+l);this._has_create(l)}h=this.has_one();for(c=0,r=h.length;c<r;c++){l=h[c];this["_"+l]=null;this.attributes.push(""+l);this._has_create(l,true)}if(Object.keys(m).length!==0){d=Object.keys(m);for(b=0,q=d.length;b<q;b++){n=d[b];this.set(n,m[n])}}if(o=this.guid_for()){this.set(o,this._generate_guid())}this.after_create()||function(){}}a.prototype._generate_guid=function(){var b;b=function(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)};return""+(b())+(b())+"-"+(b())+"-"+(b())+"-"+(b())+"-"+(b())+(b())+(b())};a.prototype._has_create=function(b,c){if(c==null){c=false}return this["add_"+b]=(function(d){return function(l){var k,h,j,g,n,f,m,e;e=l.constructor.name;m=d.normal_name();f=d.constructor.name;j=b.charAt(0).toUpperCase()+b.slice(1);if(e!==j){throw new Error("Expected "+j+", but given: "+e)}if(c){if(d.get(""+b)){throw new Error("Model "+j+" already exist for "+f)}d.set(""+b,l)}else{d.get(""+b).push(l)}k=((function(){var q,o,p,i;p=l.belongs_to();i=[];for(q=0,o=p.length;q<o;q++){g=p[q];if(g.model===m){i.push(g)}}return i})())[0];if(!k){throw new Error("Model "+e+" must contain '@belongs_to: [{model: "+m+", back: "+m+"_id]'")}if(!(h=k.back)){throw new Error("Define 'back' property for @belongs_to")}if(d.attributes.indexOf(h)===-1){throw new Error("Foreign key: '"+h+"' not contain in a '"+f+"' model")}n=""+m+"_"+h;if(l.attributes.indexOf(n)===-1){throw new Error("Define "+n+" in @attrs for '"+j+"' model")}return l.set(""+n,d.get(h))}})(this)};a.prototype.set=function(b,c){if(this.attributes.indexOf(b)===-1){throw new Error("Attribute '"+b+"' not found for "+(this.normal_name().toUpperCase())+" model")}return this["_"+b]=c};a.prototype.get=function(b){if(this.attributes.indexOf(b)===-1){throw new Error("Attribute '"+b+"' not found for "+(this.normal_name().toUpperCase())+" model")}return this["_"+b]};a.prototype.valid=function(){return this._isValid};a.prototype.validate=function(){var d,g,n,h,b,o,c,l,k,i,m,j,f;this.errors={};k=this.validators();for(n in k){l=k[n];d=this.get(n);for(c in l){o=l[c];h=(function(){switch(c){case"length":return new Sirius.LengthValidator();case"exclusion":return new Sirius.ExclusionValidator();case"inclusion":return new Sirius.InclusionValidator();case"format":return new Sirius.FormatValidator();case"numericality":return new Sirius.NumericalityValidator();case"presence":return new Sirius.PresenceValidator();case"validate_with":i=new Sirius.Validator();i.validate=o;i.msg=null;return i}})();b=h.validate(d,o);if(!b){g=typeof o==="object"?o.error||h.error_message():h.error_message();((m=this.errors)[j=""+n]!=null?m[j]:m[j]=[]).push(""+g)}}}return this._isValid=(f=Object.keys(this.errors).length===0)!=null?f:{"true":false}};a.prototype.save=function(c){var b;if(c==null){c=false}this.validate();b=this.constructor.name;if(c&&!this._isValid){throw new Error(""+b+" model not valid!")}if(this._isValid){return false}return true};a.prototype.to_json=function(h){var f,b,c,k,j,g,d,i,e;if(h==null){h=false}g={};e=this.attributes;for(d=0,i=e.length;d<i;d++){f=e[d];j=this.get(""+f);g[""+f]=(function(){var n,m,l;if(this.has_many().indexOf(f)>-1){l=[];for(n=0,m=j.length;n<m;n++){k=j[n];l.push(JSON.parse(k.to_json()))}return l}else{if(this.has_one().indexOf(f)>-1){return JSON.parse(j.to_json())}else{return j}}}).call(this)}if(h){c={};b=this.normal_name();c[b]=g;return JSON.stringify(c)}else{return JSON.stringify(g)}};a.prototype.to_html=function(){var d,b,g,c,i,j,f,h,e;f=this.constructor.to||{};i=(function(){var n,l,m,k;m=this.attributes;k=[];for(n=0,l=m.length;n<l;n++){g=m[n];e=this.get(g);c=f[g]||{};j=c.tag||"div";d=(function(){var o;o=[];for(b in c){h=c[b];if(b!=="tag"){o.push(""+b+" = '"+h+"'")}}return o})();d=d.length===0?"":" "+(d.join(" "));e=(function(){var q,o,p;if(this.has_many().indexOf(g)>-1){p=[];for(q=0,o=e.length;q<o;q++){h=e[q];p.push(h.to_html())}return p}else{if(this.has_one().indexOf(g)>-1){return e.to_html()}else{return e}}}).call(this);k.push("<"+j+d+">"+e+"</"+j+">")}return k}).call(this);return i.join("")};a.from_json=function(n,b){var g,l,k,c,f,j,h,d,i,e;if(b==null){b={}}c=new this;n=JSON.parse(n);l=[].concat(c.attrs(),c.has_many(),c.has_one());for(d=0,i=l.length;d<i;d++){g=l[d];if(typeof g==="object"){e=Object.keys(g),k=e[0];c.set(k,n[k]||g[k])}else{j=(function(){var q,p,m,o;if(c.has_many().indexOf(g)>-1){f=b[g];if(f){m=n[g];o=[];for(q=0,p=m.length;q<p;q++){h=m[q];o.push(f.from_json(JSON.stringify(h),b))}return o}else{return n[g]}}else{if(c.has_one().indexOf(g)>-1){f=b[g];if(f){return f.from_json(JSON.stringify(n[g]),b)}else{return n[g]}}else{return n[g]}}})();c.set(g,j||c.get(g))}}return c};a.from_html=function(b){var c;c=b||this.form_name||Sirius.Utils.underscore(this.name);return this.from_json(Sirius.Application.adapter.form_to_json(c))};a.prototype.compare=function(b){throw new Error("`compare` method must be overridden")};a.prototype.after_create=function(){};return a})();Sirius.Collection=(function(){function a(b,d,c){if(d==null){d=[]}if(c==null){c={every:0,on_add:this.on_add,on_remove:this.on_remove,remote:null}}if(b.__super__.constructor.name!=="BaseModel"){throw new Error("Collection must be used only with `BaseModel` inheritor")}this._array=[];this._klasses=d;this._type=b.name;this.on_add=c.on_add||this.on_add;this.on_remove=c.on_remove||this.on_add;if(c.remote){this.remote=(function(e){return function(){var j,i,f,k,h,g;f=c.remote();j=JSON.parse(f);if(Sirius.Utils.is_array(j)){if(j.length!==0){g=[];for(k=0,h=j.length;k<h;k++){i=j[k];g.push(e.push(b.from_json(JSON.stringify(i),e._klasses)))}return g}}else{return e.push(b.from_json(f,e._klasses))}}})(this)}this._timer=null;this._start_sync(c.every||0)}a.prototype._start_sync=function(b){if(b!==0){return this._timer=setInterval(this.remote,b)}};a.prototype.unsync=function(){if(this._timer){return clearInterval(this._timer)}};a.prototype.sync=function(b){return this._start_sync(b)};a.prototype.push=function(b){var c;c=b.constructor.name;if(this._type!==c){throw new Error("Require `"+this._type+"`, but given `"+b.constructor.name+"`")}this._array.push(b);return this.on_add(b)};a.prototype.add=function(b){return this.push(b)};a.prototype.remove=function(b){var c;c=this.index(b);if(c!==null){this._array.splice(c,1);return this.on_remove(b)}};a.prototype.index=function(b){var e,h,d,g,c,f;h=null;f=this._array;for(e=g=0,c=f.length;g<c;e=++g){d=f[e];if(d.compare(b)){h=e}}return h};a.prototype.find=function(b,c){return this.find_all(b,c)[0]||null};a.prototype.find_all=function(e,h){var d,g,c,f,b;f=this._array;b=[];for(g=0,c=f.length;g<c;g++){d=f[g];if(d.get(e)===h){b.push(d)}}return b};a.prototype.filter=function(e){var d,g,c,f,b;if(e==null){e=function(){}}f=this._array;b=[];for(g=0,c=f.length;g<c;g++){d=f[g];if(e.call(null,d)){b.push(d)}}return b};a.prototype.each=function(e){var d,g,c,f,b;if(e==null){e=function(){}}f=this._array;b=[];for(g=0,c=f.length;g<c;g++){d=f[g];b.push(e.call(d))}return b};a.prototype.first=function(){return this._array[0]};a.prototype.last=function(){return this._array[this._array.length-1]};a.prototype.all=function(){return this._array};a.prototype.size=function(){return this._array.length};a.prototype.on_remove=function(b){};a.prototype.on_add=function(b){};return a})();Sirius.Validator=(function(){function a(){this.msg=null}a.prototype.error_message=function(){return this.msg};return a})();Sirius.LengthValidator=(function(a){__extends(b,a);function b(){return b.__super__.constructor.apply(this,arguments)}b.prototype.validate=function(h,d){var f,g,c,e;c=d.max||Number.POSITIVE_INFINITY;e=d.min||Number.NEGATIVE_INFINITY;g=d.length;f=h.length;if(g){if(f===g){return true}else{this.msg="Required length: "+g+", given: "+f;return false}}else{if((f>=e)&&(f<=c)){return true}else{this.msg="Required length in range ["+e+".."+c+"], given: "+f;return false}}};return b})(Sirius.Validator);Sirius.ExclusionValidator=(function(a){__extends(b,a);function b(){return b.__super__.constructor.apply(this,arguments)}b.prototype.validate=function(e,d){var c;c=d.within||[];if(c.indexOf(e)===-1){return true}else{this.msg="Value "+e+" reserved";return false}};return b})(Sirius.Validator);Sirius.InclusionValidator=(function(a){__extends(b,a);function b(){return b.__super__.constructor.apply(this,arguments)}b.prototype.validate=function(e,d){var c;c=d.within||[];if(c.indexOf(e)>-1){return true}else{this.msg="Value "+e+" should be in range "+c;return false}};return b})(Sirius.Validator);Sirius.FormatValidator=(function(b){__extends(a,b);function a(){return a.__super__.constructor.apply(this,arguments)}a.prototype.validate=function(d,c){var e;e=c["with"]||(function(){throw new Error("format attribute required")})();if(e.test(d)){return true}else{this.msg="Value "+d+" not for current format";return false}};return a})(Sirius.Validator);Sirius.NumericalityValidator=(function(a){__extends(b,a);function b(){return b.__super__.constructor.apply(this,arguments)}b.prototype.validate=function(d,c){if(c==null){c={}}if(c.only_integers){if(/^\d+$/.test(d)){return true}else{this.msg="Only allows integer numbers";return false}}else{if(/^\d+(?:\.\d{1,})?$/.test(d)){return true}else{this.msg="Only allows numbers";return false}}};return b})(Sirius.Validator);Sirius.PresenceValidator=(function(a){__extends(b,a);function b(){return b.__super__.constructor.apply(this,arguments)}b.prototype.validate=function(d,c){if(c==null){c=true}if(d){return true}else{this.msg="Value required";return false}};return b})(Sirius.Validator);