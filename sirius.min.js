/*!
 *  Sirius.js v0.6.1
 *  (c) 2014 fntzr
 *  license: MIT
 */
;var Sirius,__slice=[].slice,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key)){child[key]=parent[key]}}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child},__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};Sirius={VERSION:"0.6.1"};if(!Object.prototype.watch){Object.defineProperty(Object.prototype,"watch",{enumerable:false,configurable:true,writable:false,value:function(prop,handler){var getter,newval,oldval,setter;oldval=this[prop];newval=oldval;getter=function(){return newval};setter=function(val){oldval=newval;return newval=handler.call(this,prop,oldval,val)};if(delete this[prop]){Object.defineProperty(this,prop,{get:getter,set:setter,enumerable:true,configurable:true})}}})}if(!Object.prototype.unwatch){Object.defineProperty(Object.prototype,"unwatch",{enumerable:false,configurable:true,writable:false,value:function(prop){var val;val=this[prop];delete this[prop];this[prop]=val}})}Sirius.Logger=(function(){Logger.Levels=["debug","info","warn","error"];function Logger(log_enabled,logger_function){var level,_fn,_i,_len,_ref;_ref=Sirius.Logger.Levels;_fn=(function(_this){return function(level){return _this[level]=function(msg){if(log_enabled){return logger_function(level.toUpperCase(),msg)}}}})(this);for(_i=0,_len=_ref.length;_i<_len;_i++){level=_ref[_i];_fn(level)}}return Logger})();Sirius.Promise=(function(){function Promise(value){this.value=value;this.fn=function(){}}Promise.prototype.and_then=function(fn){if(this.value!=null){return fn(this.value)}else{return this.fn=fn}};Promise.prototype.set_value=function(value){return this.fn(value)};return Promise})();Sirius.redirect=function(url){var app,origin;app=Sirius.Application;app.logger.info("Redirect to "+url);if(url.indexOf("#")===0){if(app.hash_always_on_top&&app.push_state_support){origin=window.location.origin;return history.replaceState({href:url},""+url,""+origin+"/"+url)}}else{if(app.push_state_support){return history.pushState({href:url},""+url,url)}}};Sirius.RoutePart=(function(){function RoutePart(route){var parts;this.end=true;this.start=null;this.parts=[];this.args=[];parts=route.replace(/\/$/,"").split("/");if(parts[0]===""){parts[0]="#"}if(parts[parts.length-1]==="*"){this.end=false}this.parts=parts.slice(0)}RoutePart.prototype.match=function(url){var args,cp,gp,i,is_end_part,is_named_part,is_regexp_part,parts,r,_ref;this.args=[];parts=url.replace(/\/$/,"").split("/");if(parts[0]===""){parts[0]="#"}if((parts.length!==this.parts.length)&&this.end){return false}if((this.parts.length>1)&&parts.length<this.parts.length){return false}is_named_part=function(part){return part.indexOf(":")===0};is_regexp_part=function(part){return part.indexOf("[")===0};is_end_part=function(part){return part.indexOf("*")===0};i=-1;args=[];while(i<10){i++;_ref=[this.parts[i],parts[i]],cp=_ref[0],gp=_ref[1];if(!cp||!gp){break}if(is_named_part(cp)){args.push(parts[i]);continue}if(is_regexp_part(cp)){r=new RegExp("^"+cp+"$");if(!r.test(gp)){return false}args.push(r.exec(gp)[0]);continue}if(is_end_part(cp)){args=args.concat(parts.slice(i));break}if(cp!==gp){return false}}this.args=args;return true};return RoutePart})();Sirius.ControlFlow=(function(){function ControlFlow(params,wrapper){var act,action,controller,extract,msg;if(wrapper==null){wrapper=function(x){return x}}this.logger=Sirius.Application.get_logger();controller=params.controller||(function(){throw new Error("Params must contain a Controller")})();act=params.action;action=(function(){if(Sirius.Utils.is_string(act)){return controller[act]}else{if(Sirius.Utils.is_function(act)){return act}else{msg="Action must be string or function";this.logger.error("ControlFlow: "+msg);throw new Error(msg)}}}).call(this);if(!action){msg="action "+act+" not found in controller "+controller;this.logger.error("ControlFlow: "+msg);throw new Error(msg)}this.action=wrapper(action);extract=(function(_this){return function(property,is_guard){var err,k,p,t;if(is_guard==null){is_guard=false}p=params[property];k=controller[""+property+"_"+act];err=function(a){return new Error(""+a+" action must be string or function")};if(Sirius.Utils.is_string(p)){t=controller[p];if(!Sirius.Utils.is_function(t)){throw err(Sirius.Utils.camelize(property))}return t}else{if(Sirius.Utils.is_function(p)){return p}else{if(p){throw err(Sirius.Utils.camelize(property))}else{if(k){if(!Sirius.Utils.is_function(k)){throw err(Sirius.Utils.camelize(property))}return k}else{if(!is_guard){return function(){}}else{return null}}}}}}})(this);this.before=extract("before");this.after=extract("after");this.guard=extract("guard",true);this.data=params.data||null}ControlFlow.prototype.handle_event=function(){var args,data,e,merge,_ref;e=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];this.logger.info("ControlFlow: Start event processing");if(e){data=Sirius.Utils.is_array(this.data)?this.data:this.data?[this.data]:[];data=Sirius.Application.adapter.get_property(e,data);merge=[].concat([],[e],data);merge=(_ref=[]).concat.apply(_ref,[[],merge].concat(__slice.call(args)));if(this.guard){if(this.guard.apply(null,merge)){this.before();this.action.apply(null,merge);return this.after()}}else{this.before();this.action.apply(null,merge);return this.after()}}else{args=[].concat.apply([],args);if(this.guard){if(this.guard.apply(null,args)){this.before();this.action.apply(null,args);return this.after()}}else{this.before();this.action.apply(null,args);return this.after()}}};return ControlFlow})();Sirius.RouteSystem={_selector:"a:not([href^='#'])",_hash_route:function(url){return url.toString().indexOf("#")===0},_404_route:function(url){return url.toString()==="404"},_plain_route:function(url){return url.toString().indexOf("/")===0},_event_route:function(url){return !this._hash_route(url)&&!this._404_route(url)&&!this._plain_route(url)},create:function(routes,setting,fn){var current,hash_on_top,logger,prev,push_state_support,redirect_to_hash;if(fn==null){fn=function(){}}logger=Sirius.Application.get_logger();current=prev=window.location.hash;hash_on_top=setting.top;redirect_to_hash=setting.old;push_state_support=setting.support;return Sirius.Application.get_adapter().and_then((function(_this){return function(adapter){var action,array_of_routes,dispatcher,href,link,links,new_href,plain_routes,route,url,urls,wrapper,_i,_len;if(redirect_to_hash&&!push_state_support){logger.info("RouteSystem: Convert plain routing into hash routing");urls=[];route={};for(url in routes){action=routes[url];if(_this._hash_route(url)){urls.push(url)}if(_this._plain_route(url)){url="#"+url;if(urls.indexOf(url)!==-1){logger.warn("RouteSystem: Routes already have '"+url+"' url")}}route[url]=action}routes=route}wrapper=function(fn){var key,value,_ref;_ref=Sirius.Application.controller_wrapper;for(key in _ref){value=_ref[key];this[key]=value}return fn};for(url in routes){action=routes[url];if(_this._event_route(url)){(function(url,action){var event_name,handler,selector,z;handler=Sirius.Utils.is_function(action)?wrapper(action):function(){var e,params;e=arguments[0],params=2<=arguments.length?__slice.call(arguments,1):[];return(new Sirius.ControlFlow(action,wrapper)).handle_event(e,params)};z=url.match(/^([a-zA-Z:]+)(\s+)?(.*)?/);event_name=z[1];selector=z[3]||document;adapter.bind(document,selector,event_name,handler);return logger.info("RouteSystem: define event route: '"+event_name+"' for '"+selector+"'")})(url,action)}}array_of_routes=(function(){var _results;_results=[];for(url in routes){action=routes[url];if(!(this._hash_route(url))){continue}logger.info("RouteSystem: define hash route: '"+url+"'");url=new Sirius.RoutePart(url);action=Sirius.Utils.is_function(action)?wrapper(action):new Sirius.ControlFlow(action,wrapper);_results.push([url,action])}return _results}).call(_this);plain_routes=(function(){var _results;_results=[];for(url in routes){action=routes[url];if(!(this._plain_route(url))){continue}logger.info("RouteSystem: define route: '"+url+"'");url=new Sirius.RoutePart(url);action=Sirius.Utils.is_function(action)?wrapper(action):new Sirius.ControlFlow(action,wrapper);_results.push([url,action])}return _results}).call(_this);dispatcher=function(e){var f,flow,href,origin,part,pathname,r,r404,result,route_array,_i,_len;prev=current;route_array=null;result=false;logger.info("RouteSystem: start processing route: '"+current+"'");if(e.type==="hashchange"){route_array=array_of_routes;current=window.location.hash;if(hash_on_top&&push_state_support){origin=window.location.origin;history.replaceState({href:current},""+current,""+origin+"/"+current)}}else{route_array=plain_routes;href=e.target.href;if(push_state_support){history.pushState({href:href},""+href,href)}pathname=window.location.pathname;if(pathname===""){pathname="/"}if(e.preventDefault){e.preventDefault()}else{e.returnValue=false}current=pathname}logger.info("RouteSystem: Url change to: "+current);adapter.fire(document,"application:urlchange",current,prev);for(_i=0,_len=route_array.length;_i<_len;_i++){part=route_array[_i];f=part[0];r=f.match(current);if(r&&!result){result=true;flow=part[1];if(flow.handle_event){flow.handle_event(null,f.args)}else{flow.apply(null,f.args)}return}}if(!result){logger.warn("RouteSystem: route '"+current+"' not found. Generate 404 event");adapter.fire(document,"application:404",current,prev);r404=routes["404"]||routes[404];if(r404){if(Sirius.Utils.is_function(r404)){wrapper(r404)(current)}else{(new Sirius.ControlFlow(r404,wrapper)).handle_event(null,current)}}}return false};if(redirect_to_hash&&!push_state_support){links=adapter.all(_this._selector);_this.logger("RouteSystem: Found "+links.length+" link. Convert href into hash based routing");for(_i=0,_len=links.length;_i<_len;_i++){link=links[_i];href=link.getAttribute("href");new_href=href.indexOf("/")===0?"#"+href:"#/"+href;_this.logger("RouteSystem: Convert '"+href+"' -> '"+new_href+"'");link.setAttribute("href",new_href)}}if(plain_routes.length!==0){adapter.bind(document,_this._selector,"click",dispatcher)}window.onhashchange=dispatcher;if(push_state_support){adapter.bind(window,null,"popstate",function(e){if(history&&history.state&&(history.state===null||history.state.href.indexOf("#")!==0)){return dispatcher(e)}})}return fn()}})(this))}};Sirius.Application={log:false,adapter:null,running:false,route:{},start:false,controller_wrapper:{redirect:Sirius.redirect},hash_always_on_top:true,use_hash_routing_for_old_browsers:true,default_log_function:function(level,msg){if(console&&console.log){return console.log(""+level+": "+msg)}else{return alert("Not supported `console`. You should define own `logger` function for Sirius.Application")}},_wait:[],_messages_queue:[],get_logger:function(){var l,lvls,o,q,_fn,_i,_len;if(!this.logger){lvls=Sirius.Logger.Levels;o={};q=this._messages_queue;_fn=function(l){return o[l]=function(msg){return q.push([l,msg])}};for(_i=0,_len=lvls.length;_i<_len;_i++){l=lvls[_i];_fn(l)}return o}else{return this.logger}},get_adapter:function(){var p;if(this.adapter==null){p=new Sirius.Promise();this._wait.push(p);return p}else{return new Sirius.Promise(this.adapter)}},run:function(options){var key,setting,value,_ref;if(options==null){options={}}this.running=true;this.log=options.log||this.log;this.adapter=options.adapter||(function(){throw new Error("Specify adapter")})();this.route=options.route||this.route;this.logger=new Sirius.Logger(this.log,options.logger||this.default_log_function);this.start=options.start||this.start;_ref=options.controller_wrapper||{};for(key in _ref){value=_ref[key];this.controller_wrapper[key]=value}this.hash_always_on_top=options.hash_always_on_top!=null?options.hash_always_on_top:this.hash_always_on_top;this.use_hash_routing_for_old_browsers=options.use_hash_routing_for_old_browsers!=null?options.use_hash_routing_for_old_browsers:this.use_hash_routing_for_old_browsers;this.logger.info("Application: Logger enabled? "+this.log);this.logger.info("Application: Adapter: "+(Sirius.Utils.fn_name(this.adapter.constructor)));this.logger.info("Application: Hash always on top: "+this.hash_always_on_top);this.logger.info("Application: Use hash routing for old browsers: "+this.use_hash_routing_for_old_browsers);this.logger.info("Application: Current browser: "+navigator.userAgent);this.push_state_support=history.pushState?true:false;this.logger.info("Application: History pushState support: "+this.push_state_support);if(!this.push_state_support&&this.use_hash_routing_for_old_browsers){this.logger.warn("Application: You browser not support pushState, and you disable hash routing for old browser")}setting={old:this.use_hash_routing_for_old_browsers,top:this.hash_always_on_top,support:this.push_state_support};Sirius.RouteSystem.create(this.route,setting,(function(_this){return function(){var message,p,_i,_j,_len,_len1,_ref1,_ref2,_results;_ref1=_this._wait;for(_i=0,_len=_ref1.length;_i<_len;_i++){p=_ref1[_i];p.set_value(_this.adapter)}_this.adapter.fire(document,"application:run",new Date());_ref2=_this._messages_queue;_results=[];for(_j=0,_len1=_ref2.length;_j<_len1;_j++){message=_ref2[_j];_results.push(_this.logger[message[0]].call(null,message[1]))}return _results}})(this));if(this.start){return Sirius.redirect(this.start)}}};Sirius.Utils=(function(){function Utils(){}Utils.is_function=function(a){return Object.prototype.toString.call(a)==="[object Function]"};Utils.is_string=function(a){return Object.prototype.toString.call(a)==="[object String]"};Utils.is_array=function(a){return Object.prototype.toString.call(a)==="[object Array]"};Utils.camelize=function(str){return str.charAt(0).toUpperCase()+str.slice(1)};Utils.underscore=function(str){return str.replace(/([A-Z])/g,"_$1").replace(/^_/,"").toLowerCase()};Utils.ie_version=function(){var msie,rv,trident,ua;ua=window.navigator.userAgent;msie=ua.indexOf("MSIE ");trident=ua.indexOf("Trident/");if(msie>0){return parseInt(ua.substring(msie+5,ua.indexOf(".",msie)),10)}if(trident>0){rv=ua.indexOf("rv:");return parseInt(ua.substring(rv+3,ua.indexOf(".",rv)),10)}return 0};Utils.fn_name=function(fn){if(this.is_function(fn)){return fn.toString().match(/function ([^\(]+)/)[1]}else{throw new Error("Need function, given "+(typeof fn))}};return Utils})();Sirius.Validator=(function(){function Validator(){this.logger=Sirius.Application.get_logger();this.msg=null}Validator.prototype.error_message=function(){return this.msg};return Validator})();Sirius.LengthValidator=(function(_super){__extends(LengthValidator,_super);function LengthValidator(){return LengthValidator.__super__.constructor.apply(this,arguments)}LengthValidator.prototype.validate=function(value,attributes){var actual_length,length,max,min;this.logger.info("LengthValidator: start validate '"+value+"'");if(value!=null){max=attributes.max||Number.POSITIVE_INFINITY;min=attributes.min||Number.NEGATIVE_INFINITY;length=attributes.length;actual_length=value.length;if(length){if(actual_length===length){return true}else{this.msg="Required length: "+length+", given: "+actual_length;return false}}else{if((actual_length>=min)&&(actual_length<=max)){return true}else{this.msg="Required length in range ["+min+".."+max+"], given: "+actual_length;return false}}}else{this.msg="Given null for LengthValidator";return false}};return LengthValidator})(Sirius.Validator);Sirius.ExclusionValidator=(function(_super){__extends(ExclusionValidator,_super);function ExclusionValidator(){return ExclusionValidator.__super__.constructor.apply(this,arguments)}ExclusionValidator.prototype.validate=function(value,attributes){var range;this.logger.info("ExclusionValidator: start validate '"+value+"'");range=attributes.within||[];if(range.indexOf(value)===-1){return true}else{this.msg="Value "+value+" reserved";return false}};return ExclusionValidator})(Sirius.Validator);Sirius.InclusionValidator=(function(_super){__extends(InclusionValidator,_super);function InclusionValidator(){return InclusionValidator.__super__.constructor.apply(this,arguments)}InclusionValidator.prototype.validate=function(value,attributes){var range;this.logger.info("InclusionValidator: start validate '"+value+"'");range=attributes.within||[];if(range.indexOf(value)>-1){return true}else{this.msg="Value "+value+" should be in range "+range;return false}};return InclusionValidator})(Sirius.Validator);Sirius.FormatValidator=(function(_super){__extends(FormatValidator,_super);function FormatValidator(){return FormatValidator.__super__.constructor.apply(this,arguments)}FormatValidator.prototype.validate=function(value,attributes){var format;this.logger.info("FormatValidator: start validate '"+value+"'");format=attributes["with"]||(function(){throw new Error("format attribute required")})();if(value!=null){if(format.test(value)){return true}else{this.msg="Value "+value+" not for current format";return false}}else{this.msg="Given null for Format";return false}};return FormatValidator})(Sirius.Validator);Sirius.NumericalityValidator=(function(_super){__extends(NumericalityValidator,_super);function NumericalityValidator(){return NumericalityValidator.__super__.constructor.apply(this,arguments)}NumericalityValidator.prototype.validate=function(value,attributes){if(attributes==null){attributes={}}this.logger.info("NumericalityValidator: start validate '"+value+"'");if(attributes.only_integers){if(/^\d+$/.test(value)){return true}else{this.msg="Only allows integer numbers";return false}}else{if(/^\d+(?:\.\d{1,})?$/.test(value)){return true}else{this.msg="Only allows numbers";return false}}};return NumericalityValidator})(Sirius.Validator);Sirius.PresenceValidator=(function(_super){__extends(PresenceValidator,_super);function PresenceValidator(){return PresenceValidator.__super__.constructor.apply(this,arguments)}PresenceValidator.prototype.validate=function(value,attributes){if(attributes==null){attributes=true}this.logger.info("PresenceValidator: start validate '"+value+"'");if(value){return true}else{this.msg="Value required";return false}};return PresenceValidator})(Sirius.Validator);Sirius.Observer=(function(){var MO,ONCHANGE_TAGS;Observer._observers=[];Observer.add_observer=function(new_observer){return[]};MO=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver||null;ONCHANGE_TAGS=["INPUT","TEXTAREA","SELECT"];function Observer(from_element,clb){var adapter;this.from_element=from_element;this.clb=clb!=null?clb:function(){};this._create=__bind(this._create,this);adapter=Sirius.Application.get_adapter();adapter.and_then(this._create)}Observer.prototype._create=function(adapter){var clb,cnf,current_value,elements,from,handler,logger,my_watch,observer,tag,type;logger=Sirius.Application.get_logger();clb=this.clb;from=this.from_element;tag=adapter.get_attr(from,"tagName");type=adapter.get_attr(from,"type");current_value=null;if(typeof from==="object"&&from.object&&from.prop){handler=function(prop,oldvalue,newvalue){var result;result={text:newvalue,previous:oldvalue};return clb(result)};my_watch=function(object,prop,handler){var index,n,namespaces,o,_i,_len;namespaces=prop.split(".");o=object;for(index=_i=0,_len=namespaces.length;_i<_len;index=++_i){n=namespaces[index];if(index<namespaces.length-1){o=object[n]}}return o.watch(namespaces[namespaces.length-1],handler)};return my_watch(from.object,from.prop,handler)}else{logger.info("Observer: for "+from);handler=function(e){var attr_name,new_attr,old_attr,result,txt;logger.info("Observer: Handler Function: given "+e.type+" event");result={text:null,attribute:null};if(["focusout","focusin"].indexOf(e.type)!==-1){return}txt=adapter.text(from);if(["input","selectionchange"].indexOf(e.type)!==-1&&txt===current_value){return}if(e.type==="input"||e.type==="childList"||e.type==="change"||e.type==="DOMNodeInserted"||e.type==="selectionchange"){result.text=txt;current_value=txt}if(e.type==="change"){result.state=adapter.get_state(from)}if(e.type==="attributes"){attr_name=e.attributeName;old_attr=e.oldValue||[];new_attr=adapter.get_attr(from,attr_name);result.text=new_attr;result.attribute=attr_name;result.previous=old_attr}if(e.type==="DOMAttrModified"){attr_name=e.originalEvent.attrName;old_attr=e.originalEvent.prevValue;new_attr=adapter.get_attr(from,attr_name);result.text=new_attr;result.attribute=attr_name;result.previous=old_attr}return clb(result)};if(ONCHANGE_TAGS.indexOf(tag)!==-1){if(type==="checkbox"||type==="radio"){logger.info("Observer: Get a "+type+" element");adapter.bind(document,this.from_element,"change",handler)}else{current_value=adapter.text(this.from_element);adapter.bind(document,this.from_element,"input",handler);if(Sirius.Utils.ie_version()===9){logger.warn("Observer: Hook for work with IE9 browser");adapter.bind(document,document,"selectionchange",handler)}}}if(MO){logger.info("Observer: MutationObserver support");observer=new MO(function(mutations){return mutations.forEach(handler)});cnf={childList:true,attributes:true,characterData:true,attributeOldValue:true,characterDataOldValue:true,subtree:false};if(Sirius.Utils.is_string(from)){elements=adapter.get(from);return observer.observe(elements,cnf)}else{return observer.observe(from,cnf)}}else{logger.warn("Observer: MutationObserver not support");logger.info("Observer: Use Deprecated events for observe");adapter.bind(document,this.from_element,"DOMNodeInserted",handler);adapter.bind(document,this.from_element,"DOMNodeRemoved",handler);return adapter.bind(document,this.from_element,"DOMAttrModified",handler)}}};return Observer})();Sirius.BindHelper=(function(){function BindHelper(element,setting,is_bind_view_to_model){this.element=element;this.setting=setting;this.is_bind_view_to_model=is_bind_view_to_model!=null?is_bind_view_to_model:true;this.logger=Sirius.Application.get_logger()}BindHelper.prototype.extract=function(adapter,user_setting){var default_from,default_to,element,elements,from,is_bind_view_to_model,result,strategy,to,transform,_fn,_i,_len;if(user_setting==null){user_setting={}}elements=adapter.all(""+this.element+", "+this.element+" *");to=this.setting.to;from=this.setting.from;strategy=this.setting.strategy;transform=this.setting.transform;default_from=this.setting.default_from;default_to=this.setting.default_to;is_bind_view_to_model=this.is_bind_view_to_model;result=[];this.logger.info("BindHelper: to: "+to+", from: "+from);this.logger.info("BindHelper: strategy: "+strategy);this.logger.info("BindHelper: transform: "+transform);this.logger.info("BindHelper: default from: "+default_from);this.logger.info("BindHelper: default to: "+default_to);_fn=function(element){var r,tmp_from,tmp_strategy,tmp_to,tmp_transform;tmp_to=adapter.get_attr(element,to)||default_to;tmp_from=adapter.get_attr(element,from)||default_from;tmp_strategy=adapter.get_attr(element,strategy)||"swap";tmp_transform=adapter.get_attr(element,transform);r={to:tmp_to,from:tmp_from,strategy:tmp_strategy,transform:tmp_transform,element:element};if(is_bind_view_to_model){if(tmp_to){return result.push(r)}}else{if(tmp_from){return result.push(r)}}};for(_i=0,_len=elements.length;_i<_len;_i++){element=elements[_i];_fn(element)}return result};BindHelper.transform=function(name,setting){var error,logger,msg;if(setting==null){setting={}}error=function(name){return"Transform method '"+name+"' not found in setting"};logger=Sirius.Application.get_logger();if(Sirius.Utils.is_function(setting.transform)){if(name){msg=error(name);logger.error("BindHelper: "+msg);throw new Error(msg)}else{return setting.transform}}else{if(setting.transform[name]!=null){return setting.transform[name]}else{msg=error(name);logger.error("BindHelper: "+msg);throw new Error(msg)}}};return BindHelper})();Sirius.View=(function(){View.prototype.name=function(){return"View"};View._Strategies=[];function View(element,clb){var strategy,_fn,_i,_len,_ref;this.element=element;if(clb==null){clb=function(txt){return txt}}this.logger=Sirius.Application.get_logger();this._result_fn=(function(_this){return function(){var args;args=1<=arguments.length?__slice.call(arguments,0):[];return clb.apply.apply(clb,[null].concat(__slice.call(args)))}})(this);this.logger.info("View: Create a new View for "+this.element);_ref=this.constructor._Strategies;_fn=(function(_this){return function(strategy){var name,render,transform;name=strategy[0];_this.logger.info("View: Define "+name+" strategy");transform=strategy[1];render=strategy[2];return _this[name]=function(attribute){var result;if(attribute==null){attribute="text"}result=_this._result;element=_this.element;_this.logger.info("View: Start processing strategy for "+element);return Sirius.Application.get_adapter().and_then(function(adapter){var oldvalue,res;oldvalue=attribute==="text"?adapter.text(element):adapter.get_attr(element,attribute);res=transform(oldvalue,result);return render(adapter,element,res,attribute)})}}})(this);for(_i=0,_len=_ref.length;_i<_len;_i++){strategy=_ref[_i];_fn(strategy)}}View.prototype.render=function(){var args;args=1<=arguments.length?__slice.call(arguments,0):[];this.logger.info("View: Call render for "+args);this._result=this._result_fn(args);return this};View.prototype.on=function(){var custom_event_name,event_name,handler,params,selector;selector=arguments[0],event_name=arguments[1],custom_event_name=arguments[2],params=4<=arguments.length?__slice.call(arguments,3):[];selector=selector===this.element?selector:""+this.element+" "+selector;this.logger.info("View: Bind event for "+selector+", event name: "+event_name+", will be called : "+custom_event_name);handler=function(e){return Sirius.Application.get_adapter().and_then((function(_this){return function(adapter){var _ref;return(_ref=adapter.fire).call.apply(_ref,[null,document,custom_event_name,e].concat(__slice.call(params)))}})(this))};Sirius.Application.get_adapter().and_then((function(_this){return function(adapter){return adapter.bind(document,selector,event_name,handler)}})(this));return null};View.is_valid_strategy=function(s){return this._Strategies.filter(function(arr){return arr[0]===s}).length!==0};View.prototype.bind=function(){var args,extra,klass,setting;klass=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];setting=args[0]||{};extra=args[1]||{};this.logger.info("View: Call bind for "+klass);if(klass){if(klass.name&&klass.name()==="View"){this._bind_view(klass,setting)}else{if((typeof klass==="object")&&Sirius.Utils.is_string(setting)){this._bind_prop(klass,setting,extra)}else{if(Sirius.Utils.is_string(klass)){this.bind(new Sirius.View(klass,setting))}else{this._bind_model(klass,setting)}}}}return this};View.prototype._bind_model=function(model,setting){this.logger.info("View: Bind "+this.element+" and model: "+(Sirius.Utils.fn_name(model.constructor)));return Sirius.Application.get_adapter().and_then((function(_this){return function(adapter){var element,elements,model_name,_i,_len,_results;setting.transform=setting.transform!=null?(_this.logger.info("View: 'transform' method not found. Use default transform method."),setting.transform):function(x){return x};elements=new Sirius.BindHelper(_this.element,{to:"data-bind-to",from:"data-bind-from",strategy:"data-bind-strategy",transform:"data-bind-transform",default_from:null}).extract(adapter,setting);model_name=Sirius.Utils.fn_name(model.constructor);_results=[];for(_i=0,_len=elements.length;_i<_len;_i++){element=elements[_i];_results.push((function(element){var clb,transform;if(model.get_attributes().indexOf(element.to)===-1){throw new Error("Error attribute '"+element.to+"' not exist in model class '"+model_name+"'")}transform=Sirius.BindHelper.transform(element.transform,setting);clb=(function(_this){return function(result){if((result.text!=null)&&!element.from){model.set(element.to,transform(result.text))}if(element.from===result.attribute){model.set(element.to,transform(result.text))}if(element.from==="checked"){return model.set(element.to,result.state)}}})(this);return new Sirius.Observer(element.element,clb)})(element))}return _results}})(this))};View.prototype._bind_prop=function(object,prop,setting){var clb,strategy,to,transform,view;if(setting==null){setting={}}this.logger.info("View: Bind '"+this.element+"' and object "+object+" with property: "+prop);to=setting.to||"text";strategy=setting.strategy||"swap";transform=setting.transform||function(x){return x};view=this;clb=function(result){var txt;txt=transform(result.text);return view.render(txt)[strategy](to)};return new Sirius.Observer({object:object,prop:prop},clb)};View.prototype._bind_view=function(view,setting){var clb,current,from,strategy,to;this.logger.info("View: Bind '"+this.element+"' with '"+view.element+"'");to=setting.to||"text";from=setting.from||"text";this.logger.info("View: for '"+view.element+"' use to: '"+to+"' and from: '"+from+"'");strategy=setting.strategy||"swap";current=this.element;clb=function(result){var txt;txt=result.text;return view.render(txt)[strategy](to)};return new Sirius.Observer(current,clb)};View.prototype.bind2=function(klass){this.bind(klass);if(klass.bind&&Sirius.Utils.is_function(klass.bind)){return klass.bind(this)}};View.register_strategy=function(name,object){var logger,msg,render,transform;if(object==null){object={}}logger=Sirius.Application.get_logger();logger.info("View: Register new Strategy "+name);transform=object.transform;render=object.render;if(!Sirius.Utils.is_function(transform)){msg="Strategy must be Function, but "+(typeof transform)+" given.";logger.error("View: "+msg);throw new Error(msg)}if(!Sirius.Utils.is_function(render)){msg="Strategy must be Function, but "+(typeof render)+" given.";logger.error("View: "+msg);throw new Error(msg)}if(!Sirius.Utils.is_string(name)){msg="Strategy name must be String, but "+(typeof name)+" given.";logger.error("View: "+msg);throw new Error(msg)}this._Strategies.push([name,transform,render]);return null};return View})();Sirius.View.register_strategy("swap",{transform:function(oldvalue,newvalue){return""+newvalue},render:function(adapter,element,result,attribute){if(attribute==="text"){return adapter.swap(element,result)}else{return adapter.set_attr(element,attribute,result)}}});Sirius.View.register_strategy("append",{transform:function(oldvalue,newvalue){return""+oldvalue+newvalue},render:function(adapter,element,result,attribute){if(attribute==="text"){return adapter.append(element,result)}else{return adapter.set_attr(element,attribute,result)}}});Sirius.View.register_strategy("prepend",{transform:function(oldvalue,newvalue){return""+newvalue+oldvalue},render:function(adapter,element,result,attribute){if(attribute==="text"){return adapter.prepend(element,result)}else{return adapter.set_attr(element,attribute,result)}}});Sirius.View.register_strategy("clear",{transform:function(oldvalue,newvalue){return""},render:function(adapter,element,result,attribute){return adapter.clear(element)}});Sirius.BaseModel=(function(){BaseModel._Validators=[];BaseModel.attrs=[];BaseModel.has_many=[];BaseModel.has_one=[];BaseModel.belongs_to=[];BaseModel.guid_for=null;BaseModel.validate={};BaseModel.prototype.attrs=function(){return this.constructor.attrs||[]};BaseModel.prototype.__name="BaseModel";BaseModel.prototype.normal_name=function(){return Sirius.Utils.underscore(this.constructor.name)};BaseModel.prototype.has_many=function(){return this.constructor.has_many||[]};BaseModel.prototype.has_one=function(){return this.constructor.has_one||[]};BaseModel.prototype.belongs_to=function(){return this.constructor.belongs_to||[]};BaseModel.prototype.validators=function(){return this.constructor.validate};BaseModel.prototype.guid_for=function(){return this.constructor.guid_for};BaseModel.prototype.normalize_attrs=function(){var a,_i,_len,_ref,_results;_ref=this.constructor.attrs;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){a=_ref[_i];_results.push((function(a){if(typeof a==="object"){return Object.keys(a)[0]}else{return a}})(a))}return _results};function BaseModel(obj){var attr,g,key,klass,msg,name,validator,validator_name,value,_i,_j,_k,_l,_len,_len1,_len2,_len3,_ref,_ref1,_ref2,_ref3,_ref4,_ref5;if(obj==null){obj={}}this.logger=Sirius.Application.get_logger();this._is_valid=false;this.callbacks=[];this.errors={};this.attributes=this.normalize_attrs();name=Sirius.Utils.fn_name(this.constructor);this.errors={};_ref=this.attrs();for(_i=0,_len=_ref.length;_i<_len;_i++){attr=_ref[_i];this.logger.info("BaseModel: define '"+attr+"' attribute for '"+name+"'");if(typeof attr==="object"){_ref1=Object.keys(attr),key=_ref1[0];if(!key){msg="Attributes should have a key and value";this.logger.error("BaseModel: "+msg);throw new Error(msg)}this["_"+key]=attr[key];this._gen_method_name_for_attribute(key)}else{this._gen_method_name_for_attribute(attr);this["_"+attr]=null}}_ref2=this.has_many();for(_j=0,_len1=_ref2.length;_j<_len1;_j++){klass=_ref2[_j];this.logger.info("BaseModel: has many attribute: "+klass);this["_"+klass]=[];this.attributes.push(""+klass);this._has_create(klass);this._gen_method_name_for_attribute(klass,true)}_ref3=this.has_one();for(_k=0,_len2=_ref3.length;_k<_len2;_k++){klass=_ref3[_k];this.logger.info("BaseModel: has one attribute: "+klass);this["_"+klass]=null;this.attributes.push(""+klass);this._has_create(klass,true);this._gen_method_name_for_attribute(klass,true)}if(Object.keys(obj).length!==0){_ref4=Object.keys(obj);for(_l=0,_len3=_ref4.length;_l<_len3;_l++){attr=_ref4[_l];this.set(attr,obj[attr])}}if(g=this.guid_for()){this.set(g,this._generate_guid())}this._registered_validators=this.constructor._Validators;this._registered_validators_keys=this._registered_validators.map(function(arr){return arr[0]});this._model_validators=this.validators();_ref5=this._model_validators;for(key in _ref5){value=_ref5[key];this.errors[key]={};for(validator_name in value){validator=value[validator_name];if(this._registered_validators_keys.indexOf(validator_name)===-1&&validator_name!=="validate_with"){throw new Error("Unregistered validator: "+validator_name)}this.errors[key][validator_name]=""}}this.after_create()||function(){}}BaseModel.prototype._gen_method_name_for_attribute=function(attribute,when_has_attribute){var normalize_name;if(when_has_attribute==null){when_has_attribute=false}normalize_name=Sirius.Utils.underscore(attribute);if(Object.keys(this).indexOf(normalize_name)!==-1){throw new Error("Method "+normalize_name+" already exist")}return this[normalize_name]=(function(_this){return function(value){if(value!=null){if(when_has_attribute){return _this["add_"+attribute](value)}else{return _this.set(attribute,value)}}else{return _this.get(attribute)}}})(this)};BaseModel.prototype._generate_guid=function(){var s4;s4=function(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)};return""+(s4())+(s4())+"-"+(s4())+"-"+(s4())+"-"+(s4())+"-"+(s4())+(s4())+(s4())};BaseModel.prototype._has_create=function(klass,is_one){if(is_one==null){is_one=false}return this["add_"+klass]=(function(_this){return function(z){var b_model,back,expected,i,key,m_name,me,name;name=z.constructor.name;me=_this.normal_name();m_name=_this.constructor.name;expected=klass.charAt(0).toUpperCase()+klass.slice(1);if(name!==expected){throw new Error("Expected "+expected+", but given: "+name)}if(is_one){if(_this.get(""+klass)){throw new Error("Model "+expected+" already exist for "+m_name)}_this.set(""+klass,z)}else{_this.get(""+klass).push(z)}b_model=((function(){var _i,_len,_ref,_results;_ref=z.belongs_to();_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){i=_ref[_i];if(i.model===me){_results.push(i)}}return _results})())[0];if(!b_model){throw new Error("Model "+name+" must contain '@belongs_to: [{model: "+me+", back: "+me+"_id]'")}if(!(back=b_model.back)){throw new Error("Define 'back' property for @belongs_to")}if(_this.attributes.indexOf(back)===-1){throw new Error("Foreign key: '"+back+"' not contain in a '"+m_name+"' model")}key=(b_model.compose||function(model,back){return""+model+"_"+back})(me,back);if(z.attributes.indexOf(key)===-1){throw new Error("Define "+key+" in @attrs for '"+expected+"' model")}return z.set(""+key,_this.get(back))}})(this)};BaseModel.prototype.get_attributes=function(){return this.attributes};BaseModel.prototype.set=function(attr,value){var clb,_i,_len,_ref,_results;if(this.attributes.indexOf(attr)===-1){throw new Error("Attribute '"+attr+"' not found for "+(this.normal_name().toUpperCase())+" model")}this["_"+attr]=value;this.validate(attr);_ref=this.callbacks;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){clb=_ref[_i];_results.push(clb.apply(null,[attr,value]))}return _results};BaseModel.prototype.get=function(attr){if(this.attributes.indexOf(attr)===-1){throw new Error("Attribute '"+attr+"' not found for "+(this.normal_name().toUpperCase())+" model")}return this["_"+attr]};BaseModel.prototype.is_valid=function(){return this._is_valid};BaseModel.prototype.validate=function(field){var k,key,v,value,_ref,_results;if(field==null){field=null}Object.keys(this._model_validators||{}).filter((function(_this){return function(key){if(field!=null){return key===field}else{return true}}})(this)).map((function(_this){return function(key){var current_value,klass,result,validator_key,validator_value,value,z,_results;current_value=_this.get(key);value=_this._model_validators[key];_results=[];for(validator_key in value){validator_value=value[validator_key];klass=validator_key==="validate_with"?(z=new Sirius.Validator(),z.validate=validator_value,z.msg=null,z):(z=_this._registered_validators.filter(function(arr){return arr[0]===validator_key})[0][1],new z());result=klass.validate(current_value,validator_value);if(!result){_results.push(_this.errors[key][validator_key]=klass.error_message())}else{_results.push(_this.errors[key][validator_key]="")}}return _results}})(this));_ref=this.errors;_results=[];for(key in _ref){value=_ref[key];_results.push((function(){var _results1;_results1=[];for(k in value){v=value[k];if(v!==""){_results1.push(this._is_valid=true)}}return _results1}).call(this))}return _results};BaseModel.prototype.get_errors=function(attr){var key,result,value,_ref;if(attr==null){attr=null}if(this.attributes.indexOf(attr)===-1&&attr!==null){throw new Error("Attribute '"+attr+"' not found for "+(this.normal_name().toUpperCase())+" model")}if(attr!=null){result=[];_ref=this.errors[attr];for(key in _ref){value=_ref[key];if(value!==""){result.push(value)}}return result}else{return this.errors}};BaseModel.prototype.save=function(exception){var name;if(exception==null){exception=false}this.validate();name=this.constructor.name;if(exception&&!this._is_valid){throw new Error(""+name+" model not valid!")}if(this._is_valid){return false}return true};BaseModel.prototype.to_json=function(root){var attr,name,o,v,value,z,_i,_len,_ref;if(root==null){root=false}z={};_ref=this.attributes;for(_i=0,_len=_ref.length;_i<_len;_i++){attr=_ref[_i];value=this.get(""+attr);z[""+attr]=(function(){var _j,_len1,_results;if(this.has_many().indexOf(attr)>-1){_results=[];for(_j=0,_len1=value.length;_j<_len1;_j++){v=value[_j];_results.push(JSON.parse(v.to_json()))}return _results}else{if(this.has_one().indexOf(attr)>-1){return JSON.parse(value.to_json())}else{return value}}}).call(this)}if(root){o={};name=this.normal_name();o[name]=z;return JSON.stringify(o)}else{return JSON.stringify(z)}};BaseModel.from_json=function(json,models){var attr,attrs,key,m,model,value,z,_i,_len,_ref;if(models==null){models={}}m=new this;json=JSON.parse(json);attrs=[].concat(m.attrs(),m.has_many(),m.has_one());for(_i=0,_len=attrs.length;_i<_len;_i++){attr=attrs[_i];if(typeof attr==="object"){_ref=Object.keys(attr),key=_ref[0];m.set(key,json[key]||attr[key])}else{value=(function(){var _j,_len1,_ref1,_results;if(m.has_many().indexOf(attr)>-1){model=models[attr];if(model){_ref1=json[attr];_results=[];for(_j=0,_len1=_ref1.length;_j<_len1;_j++){z=_ref1[_j];_results.push(model.from_json(JSON.stringify(z),models))}return _results}else{return json[attr]}}else{if(m.has_one().indexOf(attr)>-1){model=models[attr];if(model){return model.from_json(JSON.stringify(json[attr]),models)}else{return json[attr]}}else{return json[attr]}}})();m.set(attr,value||m.get(attr))}}return m};BaseModel.prototype.compare=function(other){throw new Error("`compare` method must be overridden")};BaseModel.prototype.after_create=function(){};BaseModel.prototype.clone=function(){return this.constructor.from_json(this.to_json())};BaseModel.prototype.bind=function(view,object_setting){var callbacks,current_model,msg;if(object_setting==null){object_setting={}}current_model=this;if(!(view.name&&view.name()==="View")){msg="`bind` only work with Sirius.View";this.logger.error(msg);throw new Error(msg)}this.logger.info("BaseModel: bind with "+view.element);object_setting.transform=object_setting.transform!=null?object_setting.transform:function(t){return t};callbacks=this.callbacks;return Sirius.Application.get_adapter().and_then((function(_this){return function(adapter){var attributes,current,element,elements,_i,_len,_results;current=view.element;elements=new Sirius.BindHelper(current,{to:"data-bind-view-to",from:"data-bind-view-from",strategy:"data-bind-view-strategy",transform:"data-bind-view-transform",default_from:null,default_to:"text"},false).extract(adapter,object_setting);attributes=_this.attributes;_results=[];for(_i=0,_len=elements.length;_i<_len;_i++){element=elements[_i];_results.push((function(element){var clb,from,strategy,transform;if(element.view==null){element.view=new Sirius.View(element.element)}transform=Sirius.BindHelper.transform(element.transform,object_setting);strategy=element.strategy;if(!Sirius.View.is_valid_strategy(strategy)){throw new Error("Strategy "+strategy+" not valid")}if(attributes.indexOf(element.from)!==-1){clb=function(attr,value){var current_value,tag,type;if(attr===element.from){if(element.to==="text"){tag=adapter.get_attr(element.element,"tagName");type=adapter.get_attr(element.element,"type");if(type==="checkbox"||type==="radio"){current_value=adapter.get_attr(element.element,"value");if(current_value===value){adapter.set_prop(element.element,"checked",true)}}if(tag==="OPTION"){current_value=adapter.get_attr(element.element,"value");if(current_value===value){return adapter.set_prop(element.element,"selected",true)}}else{return element.view.render(transform(value))[strategy](element.to)}}else{return element.view.render(transform(value))[strategy](element.to)}}};return callbacks.push(clb)}else{from=element.from;if(from.indexOf("errors")!==0){throw"For binding errors, need pass property as 'errors.attr.validator'"}return element.view.bind(current_model.errors,from.split(".").slice(1).join("."),{to:element.to,strategy:strategy,transform:transform})}})(element))}return _results}})(this))};BaseModel.prototype.bind2=function(klass){this.bind(klass);if(klass.name&&klass.name()==="View"){if(klass.bind&&Sirius.Utils.is_function(klass.bind)){return klass.bind(this)}else{return new Error("For double-sided binding need bind method, but it not found in "+klass)}}else{return new Error("BaseModel#bind2 work only with Sirius.View")}};BaseModel.register_validator=function(name,klass){var logger;logger=Sirius.Application.get_logger();logger.info("BaseModel: register validator: "+name);this._Validators.push([name,klass]);return null};return BaseModel})();Sirius.BaseModel.register_validator("length",Sirius.LengthValidator);Sirius.BaseModel.register_validator("exclusion",Sirius.ExclusionValidator);Sirius.BaseModel.register_validator("inclusion",Sirius.InclusionValidator);Sirius.BaseModel.register_validator("format",Sirius.FormatValidator);Sirius.BaseModel.register_validator("numericality",Sirius.NumericalityValidator);Sirius.BaseModel.register_validator("presence",Sirius.PresenceValidator);Sirius.Collection=(function(){function Collection(){var args,clb,klass,klasses,options;klass=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];if(klass.__super__.__name!=="BaseModel"){throw new Error("Collection must be used only with `BaseModel` inheritor")}this._array=[];this.logger=Sirius.Application.get_logger();klasses=[];options={};if(args.length===1){if(Sirius.Utils.is_array(args[0])){klasses=args[0]}else{options=args[0]}}if(args.length===2){klasses=args[0];options=args[1]}this._klasses=klasses;this._klass=klass;this._type=Sirius.Utils.fn_name(klass);this.length=0;clb=function(x){return x};this.on_add=options.on_add||clb;this.on_remove=options.on_push||clb;if(options.remote){this.remote=(function(_this){return function(){var json,model,result,_i,_len,_results;result=options.remote();json=JSON.parse(result);if(Sirius.Utils.is_array(json)){if(json.length!==0){_results=[];for(_i=0,_len=json.length;_i<_len;_i++){model=json[_i];_results.push(_this.push(klass.from_json(JSON.stringify(model),_this._klasses)))}return _results}}else{return _this.push(klass.from_json(result,_this._klasses))}}})(this)}this._timer=null;this._start_sync(options.every||0)}Collection.prototype._start_sync=function(every){if(every!==0){this.logger.info("Collection: start synchronization");this._timer=setInterval(this.remote,every)}};Collection.prototype.unsync=function(){if(this._timer){this.logger.info("Collection: end synchronization");clearInterval(this._timer)}};Collection.prototype.sync=function(every){return this._start_sync(every)};Collection.prototype.push=function(model){return this.add(model)};Collection.prototype.add=function(model){this._add(model);this.on_add(model)};Collection.prototype._add=function(model){var msg,type;type=Sirius.Utils.fn_name(model.constructor);if(this._type!==type){msg="Require `"+this._type+"`, but given `"+type+"`";this.logger.error("Collection: "+msg);throw new Error(msg)}this._array.push(model);return this.length++};Collection.prototype.remove=function(other){var inx;inx=this.index(other);if(inx!==null){this._array.splice(inx,1);this.on_remove(other)}};Collection.prototype.index=function(other){var i,inx,model,_i,_len,_ref;inx=null;_ref=this._array;for(i=_i=0,_len=_ref.length;_i<_len;i=++_i){model=_ref[i];if(model.compare(other)){inx=i}}return inx};Collection.prototype.find=function(key,value){return this.find_all(key,value)[0]||null};Collection.prototype.find_all=function(key,value){var model,_i,_len,_ref,_results;_ref=this._array;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){model=_ref[_i];if(model.get(key)===value){_results.push(model)}}return _results};Collection.prototype.filter=function(fn){var model,_i,_len,_ref,_results;if(fn==null){fn=function(){}}_ref=this._array;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){model=_ref[_i];if(fn.call(null,model)){_results.push(model)}}return _results};Collection.prototype.each=function(fn){var model,_i,_len,_ref,_results;if(fn==null){fn=function(){}}_ref=this._array;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){model=_ref[_i];_results.push(fn.call(model))}return _results};Collection.prototype.first=function(){return this._array[0]};Collection.prototype.last=function(){return this._array[this._array.length-1]};Collection.prototype.all=function(){return this._array};Collection.prototype.clear=function(){this.length=0;return this._array=[]};Collection.prototype.size=function(){return this._array.length};Collection.prototype.from_json=function(json){var j,jj,_i,_len;j=JSON.stringify(json);if(Sirius.Utils.is_array(j)){for(_i=0,_len=j.length;_i<_len;_i++){jj=j[_i];this._array.push(this._klass.from_json(jj));this.length++}}else{this._array.push(this._klass.from_json(json));this.length++}return this};Collection.prototype.to_json=function(){var e,z;z=(function(){var _i,_len,_ref,_results;_ref=this._array;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){e=_ref[_i];_results.push(e.to_json())}return _results}).call(this);return JSON.parse(JSON.stringify(z))};return Collection})();