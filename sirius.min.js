/*!
 *  Sirius.js v0.8.5
 *  (c) 2014-2015 fntz
 *  license: MIT
 */
;var ComputedField,Sirius,slice=[].slice,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key)){child[key]=parent[key]}}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty,bind=function(fn,me){return function(){return fn.apply(me,arguments)}};Sirius={VERSION:"0.8.5"};if(!Object.prototype.watch){Object.defineProperty(Object.prototype,"watch",{enumerable:false,configurable:true,writable:false,value:function(prop,handler){var getter,newval,oldval,setter;oldval=this[prop];newval=oldval;getter=function(){return newval};setter=function(val){oldval=newval;return newval=handler(prop,oldval,val)};if(delete this[prop]){Object.defineProperty(this,prop,{get:getter,set:setter,enumerable:true,configurable:true})}}})}if(!Object.prototype.unwatch){Object.defineProperty(Object.prototype,"unwatch",{enumerable:false,configurable:true,writable:false,value:function(prop){var val;val=this[prop];delete this[prop];this[prop]=val}})}Sirius.Logger=(function(){Logger.Levels=["debug","info","warn","error"];Logger.Filters=["BaseModel","Binding","Collection","View","Routing","Application","Redirect","Validation"];function Logger(log_enabled,filters,logger_function){var f,fn1,len,len1,level,pre_filters,ref,u,w;pre_filters=Sirius.Logger.Filters;for(u=0,len=pre_filters.length;u<len;u++){f=pre_filters[u];this[Sirius.Utils.underscore(f).toLowerCase()]=f}ref=Sirius.Logger.Levels;fn1=(function(_this){return function(level){return _this[level]=function(msg,location){if(log_enabled){if(!location){return logger_function(level.toUpperCase(),msg)}else{if(filters.indexOf(location)!==-1||((location==null)||pre_filters.indexOf(location)===-1)){msg="["+(location.toUpperCase())+"] "+msg;return logger_function(level.toUpperCase(),msg)}}}}}})(this);for(w=0,len1=ref.length;w<len1;w++){level=ref[w];fn1(level)}}return Logger})();Sirius.Promise=(function(){function Promise(value1){this.value=value1;this.fn=function(){}}Promise.prototype.and_then=function(fn){if(this.value!=null){return fn(this.value)}else{return this.fn=fn}};Promise.prototype.set_value=function(value){return this.fn(value)};return Promise})();Sirius.Utils=(function(){function Utils(){}Utils.is_function=function(a){return Object.prototype.toString.call(a)==="[object Function]"};Utils.is_string=function(a){return Object.prototype.toString.call(a)==="[object String]"};Utils.is_array=function(a){return Object.prototype.toString.call(a)==="[object Array]"};Utils.is_object=function(a){return a!==null&&typeof a==="object"};Utils.camelize=function(str){return str.charAt(0).toUpperCase()+str.slice(1)};Utils.underscore=function(str){return str.replace(/([A-Z])/g,"_$1").replace(/^_/,"").toLowerCase()};Utils.ie_version=function(){var msie,rv,trident,ua;ua=window.navigator.userAgent;msie=ua.indexOf("MSIE ");trident=ua.indexOf("Trident/");if(msie>0){return parseInt(ua.substring(msie+5,ua.indexOf(".",msie)),10)}if(trident>0){rv=ua.indexOf("rv:");return parseInt(ua.substring(rv+3,ua.indexOf(".",rv)),10)}return 0};Utils.fn_name=function(fn){if(this.is_function(fn)){return fn.toString().match(/function ([^\(]+)/)[1]}else{throw new Error("Need function, given "+(typeof fn))}};return Utils})();Sirius.redirect=function(url){var app;app=Sirius.Application;app.logger.info("Redirect to "+url,app.logger.redirect);if(app.use_hash_routing_for_old_browsers&&!app.push_state_support){url=url.indexOf("#")===0?url:url.indexOf("/")===0?"#"+url:"#/"+url}if(url.indexOf("#")===0){if(app.push_state_support){return location.replace(url)}}else{if(app.push_state_support){return Sirius.RouteSystem.dispatch.call(null,{type:"redirect",target:{href:url}})}}};Sirius.RoutePart=(function(){function RoutePart(route){var parts;this.end=true;this.start=null;this.parts=[];this.args=[];parts=route.replace(/\/$/,"").split("/");if(parts[0]===""){parts[0]="#"}if(parts[parts.length-1]==="*"){this.end=false}this.parts=parts.slice(0)}RoutePart.prototype.match=function(url){var args,cp,gp,i,is_end_part,is_named_part,is_regexp_part,parts,r,ref;this.args=[];parts=url.replace(/\/$/,"").split("/");if(parts[0]===""){parts[0]="#"}if((parts.length!==this.parts.length)&&this.end){return false}if((this.parts.length>1)&&parts.length<this.parts.length){return false}is_named_part=function(part){return part.indexOf(":")===0};is_regexp_part=function(part){return part.indexOf("[")===0};is_end_part=function(part){return part.indexOf("*")===0};i=-1;args=[];while(i<10){i++;ref=[this.parts[i],parts[i]],cp=ref[0],gp=ref[1];if(!cp||!gp){break}if(is_named_part(cp)){args.push(parts[i]);continue}if(is_regexp_part(cp)){r=new RegExp("^"+cp+"$");if(!r.test(gp)){return false}args.push(r.exec(gp)[0]);continue}if(is_end_part(cp)){args=args.concat(parts.slice(i));break}if(cp!==gp){return false}}this.args=args;return true};return RoutePart})();Sirius.ControlFlow=(function(){function ControlFlow(params,wrapper){var act,action,controller,extract,msg;if(wrapper==null){wrapper=function(x){return x}}this.logger=Sirius.Application.get_logger();controller=params.controller||(function(){throw new Error("Params must contain a Controller")})();act=params.action;action=(function(){if(Sirius.Utils.is_string(act)){return controller[act]}else{if(Sirius.Utils.is_function(act)){return act}else{msg="Action must be string or function";this.logger.error("ControlFlow: "+msg,this.logger.routing);throw new Error(msg)}}}).call(this);if(!action){msg="action "+act+" not found in controller "+controller;this.logger.error("ControlFlow: "+msg,this.logger.routing);throw new Error(msg)}this.action=wrapper(action);extract=function(property,is_guard){var err,k,p,t;if(is_guard==null){is_guard=false}p=params[property];k=controller[property+"_"+act];err=function(a){return new Error(a+" action must be string or function")};if(Sirius.Utils.is_string(p)){t=controller[p];if(!Sirius.Utils.is_function(t)){throw err(Sirius.Utils.camelize(property))}return t}else{if(Sirius.Utils.is_function(p)){return p}else{if(p){throw err(Sirius.Utils.camelize(property))}else{if(k){if(!Sirius.Utils.is_function(k)){throw err(Sirius.Utils.camelize(property))}return k}else{if(!is_guard){return function(){}}else{return null}}}}}};this.before=extract("before");this.after=extract("after");this.guard=extract("guard",true);this.data=params.data||null;this.controller=controller;return}ControlFlow.prototype.handle_event=function(){var args,data,e,merge,ref,result;e=arguments[0],args=2<=arguments.length?slice.call(arguments,1):[];this.logger.info("ControlFlow: Start event processing",this.logger.routing);if(e){data=Sirius.Utils.is_array(this.data)?this.data:this.data?[this.data]:[];result=Sirius.Application.adapter.get_property(e,data);merge=[].concat([],[e],result);merge=(ref=[]).concat.apply(ref,[[],merge].concat(slice.call(args)));if(this.guard){if(this.guard.apply(this.controller,merge)){this.before.apply(this.controller);this.action.apply(this.controller,merge);return this.after.apply(this.controller)}}else{this.before.apply(this.controller);this.action.apply(this.controller,merge);return this.after.apply(this.controller)}}else{args=[].concat.apply([],args);if(this.guard){if(this.guard.apply(this.controller,args)){this.before.apply(this.controller);this.action.apply(this.controller,args);return this.after.apply(this.controller)}}else{this.before.apply(this.controller);this.action.apply(this.controller,args);return this.after.apply(this.controller)}}};return ControlFlow})();Sirius.RouteSystem={_selector:"a:not([href^='#'])",_hash_selector:"a[href^='#']",_hash_route:function(url){return url.toString().indexOf("#")===0},_404_route:function(url){return url.toString()==="404"},_plain_route:function(url){return url.toString().indexOf("/")===0},_event_route:function(url){return !this._hash_route(url)&&!this._404_route(url)&&!this._plain_route(url)},_event_register:function(routes,wrapper,adapter,logger){var action,results,url;results=[];for(url in routes){action=routes[url];if(this._event_route(url)){results.push((function(url,action){var event_name,handler,selector,z;handler=Sirius.Utils.is_function(action)?wrapper(action):function(){var e,params;e=arguments[0],params=2<=arguments.length?slice.call(arguments,1):[];return(new Sirius.ControlFlow(action,wrapper)).handle_event(e,params)};z=url.match(/^([a-zA-Z:]+)(\s+)?(.*)?/);event_name=z[1];selector=z[3]||document;adapter.bind(document,selector,event_name,handler);return logger.info("RouteSystem: define event route: '"+event_name+"' for '"+selector+"'",logger.routing)})(url,action))}}return results},_get_hash_routes:function(routes,wrapper,adapter,logger){var action,results,url;results=[];for(url in routes){action=routes[url];if(!(this._hash_route(url))){continue}logger.info("RouteSystem: define hash route: '"+url+"'",logger.routing);url=new Sirius.RoutePart(url);action=Sirius.Utils.is_function(action)?wrapper(action):new Sirius.ControlFlow(action,wrapper);results.push([url,action])}return results},_get_plain_routes:function(routes,wrapper,adapter,logger){var action,results,url;results=[];for(url in routes){action=routes[url];if(!(this._plain_route(url))){continue}logger.info("RouteSystem: define route: '"+url+"'",logger.routing);url=new Sirius.RoutePart(url);action=Sirius.Utils.is_function(action)?wrapper(action):new Sirius.ControlFlow(action,wrapper);results.push([url,action])}return results},create:function(routes,setting,fn){var current,hash_on_top,logger,prev,push_state_support,redirect_to_hash;if(fn==null){fn=function(){}}logger=Sirius.Application.get_logger();current=prev=window.location.hash;hash_on_top=setting.top;redirect_to_hash=setting.old;push_state_support=setting.support;return Sirius.Application.get_adapter().and_then((function(_this){return function(adapter){var action,array_of_routes,dispatcher,href,len,link,links,new_href,plain_routes,route,u,url,urls,wrapper;if(redirect_to_hash&&!push_state_support){logger.info("RouteSystem: Convert plain routing into hash routing",logger.routing);urls=[];route={};for(url in routes){action=routes[url];if(_this._hash_route(url)){urls.push(url)}if(_this._plain_route(url)){url="#"+url;if(urls.indexOf(url)!==-1){logger.warn("RouteSystem: Routes already have '"+url+"' url",logger.routing)}}route[url]=action}routes=route}wrapper=function(fn){var key,ref,value;ref=Sirius.Application.controller_wrapper;for(key in ref){value=ref[key];this[key]=value}return fn};_this._event_register(routes,wrapper,adapter,logger);array_of_routes=_this._get_hash_routes(routes,wrapper,adapter,logger);plain_routes=_this._get_plain_routes(routes,wrapper,adapter,logger);dispatcher=function(e){var f,flow,href,len,origin,part,pathname,r,r404,result,route_array,u;prev=current;route_array=[];result=false;logger.info("RouteSystem: start processing route: '"+current+"'",logger.routing);if(e.type==="hashchange"){route_array=array_of_routes;current=window.location.hash;origin=window.location.origin;if(push_state_support){history.pushState({href:current},""+current,origin+"/"+current)}else{history.replaceState({href:current},""+current,origin+"/"+current)}}else{route_array=plain_routes;href=e.target.href;if(e.type!=="popstate"){if(push_state_support){history.pushState({href:href},""+href,href)}}pathname=window.location.pathname;if(pathname===""){pathname="/"}if(e.preventDefault){e.preventDefault()}else{e.returnValue=false}current=pathname}for(u=0,len=route_array.length;u<len;u++){part=route_array[u];f=part[0];r=f.match(current);if(r&&!result){result=true;flow=part[1];if(flow.handle_event){flow.handle_event(null,f.args)}else{flow.apply(null,f.args)}}}if(!result){logger.warn("RouteSystem: route '"+current+"' not found. Generate 404 event",logger.routing);adapter.fire(document,"application:404",current,prev);r404=routes["404"]||routes[404];if(r404){if(Sirius.Utils.is_function(r404)){wrapper(r404)(current)}else{(new Sirius.ControlFlow(r404,wrapper)).handle_event(null,current)}}return}logger.info("RouteSystem: Url change to: "+current,logger.routing);adapter.fire(document,"application:urlchange",current,prev)};_this.dispatch=dispatcher;links=adapter.all(_this._selector);if(redirect_to_hash&&!push_state_support){logger.info("RouteSystem: Found "+links.length+" link. Convert href into hash based routing",logger.routing);for(u=0,len=links.length;u<len;u++){link=links[u];href=link.getAttribute("href");if(href.indexOf("http")===-1){new_href=href.indexOf("/")===0?"#"+href:"#/"+href;logger.info("RouteSystem: Convert '"+href+"' -> '"+new_href+"'",logger.routing);link.setAttribute("href",new_href)}}}if(plain_routes.length!==0){adapter.bind(document,_this._selector,"click",dispatcher)}window.onhashchange=dispatcher;if(push_state_support){adapter.bind(window,null,"popstate",function(e){if(history&&(history.state!=null)){if(history.state.href!==void 0){if(history.state.href.indexOf("#")!==0){return dispatcher(e)}}}})}if(array_of_routes.length!==0&&plain_routes.length!==0){logger.warn("RouteSystem: Seems you use plain routing and hashbased routing at the same time",logger.routing)}return fn()}})(this))}};Sirius.Application={log:false,adapter:null,running:false,route:{},start:false,controller_wrapper:{redirect:Sirius.redirect},mix_logger_into_controller:true,hash_always_on_top:true,use_hash_routing_for_old_browsers:true,default_log_function:function(level,msg){if(console&&console.log){return console.log(level+": "+msg)}else{return alert("Not supported `console`. You should define own `logger` function for Sirius.Application")}},log_filters:[],_wait:[],_messages_queue:[],get_logger:function(){var f,fn1,l,len,len1,lvls,o,q,ref,u,w;if(!this.logger){lvls=Sirius.Logger.Levels;o={};q=this._messages_queue;fn1=function(l){return o[l]=function(msg,location){return q.push([l,msg,location])}};for(u=0,len=lvls.length;u<len;u++){l=lvls[u];fn1(l)}ref=Sirius.Logger.Filters;for(w=0,len1=ref.length;w<len1;w++){f=ref[w];o[Sirius.Utils.underscore(f).toLowerCase()]=f}return o}else{return this.logger}},get_adapter:function(){var p;if(this.adapter==null){p=new Sirius.Promise();this._wait.push(p);return p}else{return new Sirius.Promise(this.adapter)}},run:function(options){var key,l,lf,max,min,ref,setting,user_filter,value,xs;if(options==null){options={}}this.running=true;this.log=options.log||this.log;this.adapter=options.adapter||(function(){throw new Error("Specify adapter")})();this.route=options.route||this.route;this.mix_logger_into_controller=options.mix_logger_into_controller||this.mix_logger_into_controller;this.log_filters=options.log_filters||this.log_filters;if(this.log_filters.length>0){lf=Sirius.Logger.Filters;user_filter=this.log_filters;if(typeof this.log_filters[0]==="number"){max=user_filter.sort()[user_filter.length-1];min=user_filter.sort()[0];if(min<0){throw new Error("Undefined index for log filters "+min)}if(max>lf.length){throw new Error("Undefined index for log filters "+max)}this.log_filters=user_filter.map(function(index){return lf[index]})}else{xs=this.log_filters.filter(function(x){return lf.indexOf(x)===-1});if(xs.length!==0){throw new Error("Check log filters given `"+user_filter+"`. Allow "+lf)}}}else{this.log_filters=[]}this.logger=new Sirius.Logger(this.log,this.log_filters,options.logger||this.default_log_function);this.start=options.start||this.start;ref=options.controller_wrapper||{};for(key in ref){value=ref[key];this.controller_wrapper[key]=value}this.hash_always_on_top=options.hash_always_on_top!=null?options.hash_always_on_top:this.hash_always_on_top;this.use_hash_routing_for_old_browsers=options.use_hash_routing_for_old_browsers!=null?options.use_hash_routing_for_old_browsers:this.use_hash_routing_for_old_browsers;this.logger.info("Logger enabled? "+this.log,this.logger.application);this.logger.info("Log filters: "+this.log_filters,this.logger.application);this.logger.info("Adapter: "+(Sirius.Utils.fn_name(this.adapter.constructor)),this.logger.application);this.logger.info("Hash always on top: "+this.hash_always_on_top,this.logger.application);this.logger.info("Use hash routing for old browsers: "+this.use_hash_routing_for_old_browsers,this.logger.application);this.logger.info("Current browser: "+navigator.userAgent,this.logger.application);this.push_state_support=history.pushState?true:false;this.logger.info("History pushState support: "+this.push_state_support,this.logger.application);if(!this.push_state_support&&this.use_hash_routing_for_old_browsers){this.logger.warn("You browser not support pushState, and you disable hash routing for old browser",this.logger.application)}this.logger.info("Mix logger in controllers "+this.mix_logger_into_controller,this.logger.application);if(this.mix_logger_into_controller){if(this.controller_wrapper.logger){this.logger.warn("Logger method already in `controller_wrapper`",this.logger.application)}l=this.logger;this.controller_wrapper.logger={info:l.info,debug:l.debug,warn:l.warn,error:l.error}}setting={old:this.use_hash_routing_for_old_browsers,top:this.hash_always_on_top,support:this.push_state_support};Sirius.RouteSystem.create(this.route,setting,(function(_this){return function(){var len,len1,message,p,ref1,ref2,results,u,w;ref1=_this._wait;for(u=0,len=ref1.length;u<len;u++){p=ref1[u];p.set_value(_this.adapter)}_this.adapter.fire(document,"application:run",new Date());ref2=_this._messages_queue;results=[];for(w=0,len1=ref2.length;w<len1;w++){message=ref2[w];results.push(_this.logger[message[0]].call(null,message[1],message[2]))}return results}})(this));if(this.start){return Sirius.redirect(this.start)}}};Sirius.Validator=(function(){function Validator(){this.logger=Sirius.Application.get_logger();this.msg=null}Validator.prototype.error_message=function(){return this.msg};return Validator})();Sirius.LengthValidator=(function(superClass){extend(LengthValidator,superClass);function LengthValidator(){return LengthValidator.__super__.constructor.apply(this,arguments)}LengthValidator.prototype.validate=function(value,attributes){var actual_length,length,max,min;this.logger.info("LengthValidator: start validate '"+value+"'",this.logger.validation);if(value!=null){max=attributes.max||Number.POSITIVE_INFINITY;min=attributes.min||Number.NEGATIVE_INFINITY;length=attributes.length;actual_length=value.length;if(length){if(actual_length===length){return true}else{this.msg="Required length: "+length+", given: "+actual_length;return false}}else{if((actual_length>=min)&&(actual_length<=max)){return true}else{this.msg="Required length in range [0.."+max+"], given: "+actual_length;return false}}}else{this.msg="Given null for LengthValidator";return false}};return LengthValidator})(Sirius.Validator);Sirius.ExclusionValidator=(function(superClass){extend(ExclusionValidator,superClass);function ExclusionValidator(){return ExclusionValidator.__super__.constructor.apply(this,arguments)}ExclusionValidator.prototype.validate=function(value,attributes){var range;this.logger.info("ExclusionValidator: start validate '"+value+"'",this.logger.validation);range=attributes.within||[];if(range.indexOf(value)===-1){return true}else{this.msg="Value "+value+" reserved";return false}};return ExclusionValidator})(Sirius.Validator);Sirius.InclusionValidator=(function(superClass){extend(InclusionValidator,superClass);function InclusionValidator(){return InclusionValidator.__super__.constructor.apply(this,arguments)}InclusionValidator.prototype.validate=function(value,attributes){var range;this.logger.info("InclusionValidator: start validate '"+value+"'",this.logger.validation);range=attributes.within||[];if(range.indexOf(value)>-1){return true}else{this.msg="Value "+value+" should be in range "+range;return false}};return InclusionValidator})(Sirius.Validator);Sirius.FormatValidator=(function(superClass){extend(FormatValidator,superClass);function FormatValidator(){return FormatValidator.__super__.constructor.apply(this,arguments)}FormatValidator.prototype.validate=function(value,attributes){var format;this.logger.info("FormatValidator: start validate '"+value+"'",this.logger.validation);format=attributes["with"]||(function(){throw new Error("format attribute required")})();if(value!=null){if(format.test(value)){return true}else{this.msg="Value "+value+" not for current format";return false}}else{this.msg="Given null for Format";return false}};return FormatValidator})(Sirius.Validator);Sirius.NumericalityValidator=(function(superClass){extend(NumericalityValidator,superClass);function NumericalityValidator(){return NumericalityValidator.__super__.constructor.apply(this,arguments)}NumericalityValidator.prototype.validate=function(value,attributes){if(attributes==null){attributes={}}this.logger.info("NumericalityValidator: start validate '"+value+"'",this.logger.validation);if(attributes.only_integers){if(/^\d+$/.test(value)){return true}else{this.msg="Only allows integer numbers";return false}}else{if(/^\d+(?:\.\d{1,})?$/.test(value)){return true}else{this.msg="Only allows numbers";return false}}};return NumericalityValidator})(Sirius.Validator);Sirius.PresenceValidator=(function(superClass){extend(PresenceValidator,superClass);function PresenceValidator(){return PresenceValidator.__super__.constructor.apply(this,arguments)}PresenceValidator.prototype.validate=function(value,attributes){if(attributes==null){attributes=true}this.logger.info("PresenceValidator: start validate '"+value+"'",this.logger.validation);if(value){return true}else{this.msg="Value required";return false}};return PresenceValidator})(Sirius.Validator);Sirius.Observer=(function(){var MO,ONCHANGE_TAGS;Observer._observers=[];Observer.add_observer=function(new_observer){return[]};Observer._clbs={};MO=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver||null;ONCHANGE_TAGS=["INPUT","TEXTAREA","SELECT"];function Observer(from_element,clb1){var adapter;this.from_element=from_element;this.clb=clb1!=null?clb1:function(){};this._create=bind(this._create,this);adapter=Sirius.Application.get_adapter();adapter.and_then(this._create)}Observer.prototype._create=function(adapter){var clb,clbs,cnf,current_prop,current_value,elements,from,handler,logger,my_watch,observer,tag,type;logger=Sirius.Application.get_logger();clb=this.clb;from=this.from_element;current_value=null;if(typeof from==="object"&&from.object&&from.prop){logger.info("Observer: for "+from.object,logger.binding);current_prop=from.prop.split(".").join("-");if(this.constructor._clbs[current_prop]!=null){this.constructor._clbs[current_prop].push([from.object,clb])}else{this.constructor._clbs[current_prop]=[[from.object,clb]]}clbs=this.constructor._clbs;handler=function(prop,oldvalue,newvalue){var result;result={text:newvalue,previous:oldvalue};clbs[current_prop].filter(function(a){return a[0]===from.object}).forEach(function(a){return a[1].call(null,result)});return newvalue};my_watch=function(object,prop,handler){var index,len,n,namespaces,o,u;namespaces=prop.split(".");o=object;for(index=u=0,len=namespaces.length;u<len;index=++u){n=namespaces[index];if(index<namespaces.length-1){o=object[n]}}o.watch(namespaces[namespaces.length-1],handler)};my_watch(from.object,from.prop,handler)}else{tag=adapter.get_attr(from,"tagName");type=adapter.get_attr(from,"type");logger.info("for "+from,logger.binding);handler=function(e){var attr_name,new_attr,old_attr,result,txt;logger.info("Handler Function: given "+e.type+" event",logger.binding);result={text:null,attribute:null};if(["focusout","focusin"].indexOf(e.type)!==-1){return}txt=adapter.text(from);if(["input","selectionchange"].indexOf(e.type)!==-1&&txt===current_value){return}if(e.type==="input"||e.type==="childList"||e.type==="change"||e.type==="DOMNodeInserted"||e.type==="selectionchange"){result.text=txt;current_value=txt}if(e.type==="change"){result.state=adapter.get_state(from)}if(e.type==="attributes"){attr_name=e.attributeName;old_attr=e.oldValue||[];new_attr=adapter.get_attr(from,attr_name);result.text=new_attr;result.attribute=attr_name;result.previous=old_attr}if(e.type==="DOMAttrModified"){attr_name=e.originalEvent.attrName;old_attr=e.originalEvent.prevValue;new_attr=adapter.get_attr(from,attr_name);result.text=new_attr;result.attribute=attr_name;result.previous=old_attr}return clb(result)};if(ONCHANGE_TAGS.indexOf(tag)!==-1){if(type==="checkbox"||type==="radio"||tag==="OPTION"){logger.info("Get a "+type+" & "+tag+" element",logger.binding);adapter.bind(document,this.from_element,"change",handler)}else{current_value=adapter.text(this.from_element);adapter.bind(document,this.from_element,"input",handler);if(Sirius.Utils.ie_version()===9){logger.warn("Hook for work with IE9 browser",logger.binding);adapter.bind(document,document,"selectionchange",handler)}}return}if(MO){logger.info("MutationObserver support",logger.binding);observer=new MO(function(mutations){return mutations.forEach(handler)});cnf={childList:true,attributes:true,characterData:true,attributeOldValue:true,characterDataOldValue:true,subtree:false};if(Sirius.Utils.is_string(from)){elements=adapter.get(from);return observer.observe(elements,cnf)}else{return observer.observe(from,cnf)}}else{logger.warn("MutationObserver not support",logger.binding);logger.info("Use Deprecated events for observe",logger.binding);adapter.bind(document,this.from_element,"DOMNodeInserted",handler);return adapter.bind(document,this.from_element,"DOMAttrModified",handler)}}};return Observer})();Sirius.BindHelper=(function(){function BindHelper(element1,is_bind_view_to_model1){this.element=element1;this.is_bind_view_to_model=is_bind_view_to_model1!=null?is_bind_view_to_model1:true;this.logger=Sirius.Application.get_logger()}BindHelper.prototype.extract=function(adapter,user_setting){var default_from,default_to,element,elements,fn1,is_bind_view_to_model,keys,len,logger,result,top,u,unwrap;if(user_setting==null){user_setting={}}is_bind_view_to_model=this.is_bind_view_to_model;result=[];default_from=null;default_to=is_bind_view_to_model?null:"text";this.logger.info("BindHelper: default from: "+default_from,this.logger.binding);this.logger.info("BindHelper: default to: "+default_to,this.logger.binding);element=this.element;keys=Object.keys(user_setting);keys.forEach(function(k){if(!Sirius.Utils.is_object(user_setting[k])){this.logger.error("DEPRECATED: seems `user_setting`: '"+tmp_a+"' in "+(Object.keys(user_setting))+" contain non object");this.logger.error("Html data-bind-* removed");throw new Error("Define setting for binding with javascript object")}});elements=[];Object.keys(user_setting).map(function(selector){var len,realElement,results,tag,type,u,x,z;realElement=selector===element?element:element+" "+selector;tag=adapter.get_attr(realElement,"tagName");type=adapter.get_attr(realElement,"type");if(tag==="OPTION"||type==="checkbox"||type==="radio"){z=adapter.all(realElement);results=[];for(u=0,len=z.length;u<len;u++){x=z[u];results.push(elements.push([x,selector]))}return results}else{return elements.push([adapter.get(realElement),selector])}});logger=this.logger;top=element;elements.forEach(function(elem){var key,msg;if(elem[0]==null){msg="Element '"+elem[1]+"' not found. Check please.";logger.error(msg,logger.binding);throw new Error(msg)}key=user_setting[elem[1]];if(key==null){msg="BindHelper: Not found keys for binding for '"+key+"' element";logger.error(msg,logger.binding);throw new Error(msg)}});unwrap=function(element,key){var elem,tmp_from,tmp_original,tmp_strategy,tmp_to,tmp_transform;tmp_to=key.to||default_to;tmp_from=key.from||default_from;tmp_strategy=key.strategy||"swap";tmp_transform=key.transform;tmp_original=top===element[1]?""+top:top+" "+element[1];elem=element[0];return{to:tmp_to,from:tmp_from,strategy:tmp_strategy,transform:tmp_transform,element:elem,selector:tmp_original}};fn1=function(element){var key,r;key=user_setting[element[1]];if(Sirius.Utils.is_array(key)){return key.forEach(function(key){var r;r=unwrap(element,key);return result.push(r)})}else{r=unwrap(element,key);if(is_bind_view_to_model){if(r.to){return result.push(r)}}else{if(r.from){return result.push(r)}}}};for(u=0,len=elements.length;u<len;u++){element=elements[u];fn1(element)}return result};return BindHelper})();Sirius.View=(function(){var EventHandlerParams;View.prototype.name=function(){return"View"};View._Strategies=[];View._Cache=[];EventHandlerParams=(function(){function EventHandlerParams(selector1,event_name1,custom_event_name1){this.selector=selector1;this.event_name=event_name1;this.custom_event_name=custom_event_name1}EventHandlerParams.prototype.eq=function(another){return this.selector===another.selector&&this.event_name===another.event_name&&this.custom_event_name.toString===another.custom_event_name.toString};return EventHandlerParams})();function View(element1,clb1){var clb,element,fn1,len,ref,strategy,u,view;this.element=element1;this.clb=clb1!=null?clb1:function(txt){return txt};element=this.element;clb=this.clb;view=Sirius.View._Cache.filter(function(v){return v.element===element&&(""+v.clb)===(""+clb)});if(view.length!==0){return view[0]}this._cache_event_handlers=[];this.logger=Sirius.Application.get_logger();this._result_fn=function(){var args;args=1<=arguments.length?slice.call(arguments,0):[];return clb.apply.apply(clb,[null].concat(slice.call(args)))};this.logger.info("Create a new View for "+this.element,this.logger.view);ref=this.constructor._Strategies;fn1=(function(_this){return function(strategy){var name,render,transform;name=strategy[0];_this.logger.info("Define "+name+" strategy",_this.logger.view);transform=strategy[1];render=strategy[2];return _this[name]=function(attribute){var result;if(attribute==null){attribute="text"}result=_this._result;element=_this.element;_this.logger.info("Start processing strategy for "+element,_this.logger.view);return Sirius.Application.get_adapter().and_then(function(adapter){var oldvalue,res;oldvalue=attribute==="text"?adapter.text(element):adapter.get_attr(element,attribute);res=transform(oldvalue,result);return render(adapter,element,res,attribute)})}}})(this);for(u=0,len=ref.length;u<len;u++){strategy=ref[u];fn1(strategy)}Sirius.View._Cache.push(this);this}View.prototype.render=function(){var args;args=1<=arguments.length?slice.call(arguments,0):[];this.logger.info("Call render for "+args,this.logger.view);this._result=this._result_fn(args);return this};View.prototype.zoom=function(selector){var v;v=new Sirius.View(this.element+" "+selector);v._result=this._result;return v};View.prototype.on=function(){var current,custom_event_name,event_name,f,handler,idx,is_present,params,selector,tmp,type;selector=arguments[0],event_name=arguments[1],custom_event_name=arguments[2],params=4<=arguments.length?slice.call(arguments,3):[];selector=selector===this.element?selector:this.element+" "+selector;type=(function(){if(Sirius.Utils.is_string(custom_event_name)){return 0}else{if(Sirius.Utils.is_function(custom_event_name)){return 1}else{throw new Error("View: 'custom_event_name' must be string or function, "+(typeof custom_event_name)+" given")}}})();current=new EventHandlerParams(selector,event_name,custom_event_name);is_present=this._cache_event_handlers.filter(function(x){return x.eq(current)});if(is_present.length===0){this.logger.info("Bind event for "+selector+", event name: "+event_name+", will be called : "+custom_event_name,this.logger.view);if(type===0){handler=function(e){return Sirius.Application.get_adapter().and_then(function(adapter){var ref;return(ref=adapter.fire).call.apply(ref,[null,document,custom_event_name,e].concat(slice.call(params)))})};Sirius.Application.get_adapter().and_then(function(adapter){return adapter.bind(document,selector,event_name,handler)});tmp=new EventHandlerParams(selector,event_name,handler);this._cache_event_handlers.push(tmp)}else{Sirius.Application.get_adapter().and_then(function(adapter){return adapter.bind(document,selector,event_name,custom_event_name)});this._cache_event_handlers.push(current)}}else{f=is_present.shift();idx=this._cache_event_handlers.indexOf(f);if(idx>-1){this._cache_event_handlers.splice(idx,1)}this._cache_event_handlers.push(current);Sirius.Application.get_adapter().and_then(function(adapter){adapter.off(document,selector,event_name,f.custom_event_name);f=null;return adapter.bind(document,selector,event_name,custom_event_name)})}};View.is_valid_strategy=function(s){return this._Strategies.filter(function(arr){return arr[0]===s}).length!==0};View.prototype.bind=function(){var args,extra,klass,setting;klass=arguments[0],args=2<=arguments.length?slice.call(arguments,1):[];setting=args[0]||{};extra=args[1]||{};this.logger.info("View: Call bind for "+klass,this.logger.view);if(klass){if((typeof klass==="object")&&Sirius.Utils.is_string(setting)){this._bind_prop(klass,setting,extra)}else{if(klass.name&&klass.name()==="View"){this._bind_view(klass,setting)}else{if(Sirius.Utils.is_string(klass)){this.bind(new Sirius.View(klass,setting))}else{this._bind_model(klass,setting)}}}}return this};View.prototype._bind_model=function(model,setting){var logger;this.logger.info("Bind "+this.element+" and model: "+(Sirius.Utils.fn_name(model.constructor)),this.logger.view);logger=this.logger;return Sirius.Application.get_adapter().and_then((function(_this){return function(adapter){var element,elements,len,model_name,results,t,u;t=Object.keys(setting).map(function(key){return Sirius.Utils.is_function(setting[key])});if(t.length===0){logger.info("View: Bind: setting empty",logger.view);setting.transform=setting.transform!=null?setting.transform:(logger.info("View: 'transform' method not found. Use default transform method.",logger.view),function(x){return x})}else{Object.keys(setting).map(function(key){if(setting[key]["transform"]==null){logger.info("View: define default transform method for '"+key+"'",logger.view);return setting[key]["transform"]=function(x){return x}}})}elements=new Sirius.BindHelper(_this.element).extract(adapter,setting);model_name=Sirius.Utils.fn_name(model.constructor);results=[];for(u=0,len=elements.length;u<len;u++){element=elements[u];results.push((function(element){var clb,state,transform,txt;if(model.get_attributes().indexOf(element.to)===-1){throw new Error("Error attribute '"+element.to+"' not exist in model class '"+model_name+"'")}transform=element.transform;clb=function(result){var actual_attribute,nms,o,selector,state,type,value;nms=element.element;type=adapter.get_attr(nms,"type");selector=element.selector;state=result.state;value=adapter.get_attr(nms,"value");actual_attribute=model.get(element.to);if((result.text!=null)&&(!element.from||element.from==="text")){model.set(element.to,transform(result.text));return}if(element.from===result.attribute){model.set(element.to,transform(result.text));return}if(element.from==="checked"){if(value.length===0){throw new Error("value attribute for "+selector+" is empty, check please")}if(type==="radio"){if(Sirius.Utils.is_object(actual_attribute)){logger.info("attribute "+element.to+" is object, change property "+value+" to "+state,logger.view);o={};o[value]=state;return model.set(element.to,o)}else{if(state===true){throw new Error("For bind radio '"+selector+"' need define attribute '"+element.to+"' in model as object")}}}else{if(type==="checkbox"){if(Sirius.Utils.is_object(actual_attribute)){logger.info("attribute "+element.to+" is object, change property "+value+" to "+state,logger.view);o={};o[value]=state;return model.set(element.to,o)}else{throw new Error("For bind checkbox '"+selector+"' need define attribute '"+element.to+"' in model as object")}}else{return model.set(element.to,result.state)}}}};new Sirius.Observer(element.element,clb);if(!element.from||element.from==="text"){txt=adapter.text(element.element);if(txt&&txt.length>0){return clb({text:txt})}}else{if(element.from==="checked"){state=adapter.get_state(element.element);return clb({state:state})}else{txt=adapter.get_attr(element.element,element.from);if(txt&&txt.length>0){return clb({text:txt,attribute:element.from})}}}})(element))}return results}})(this))};View.prototype._bind_prop=function(object,prop,setting){var clb,strategy,to,transform,view;if(setting==null){setting={}}this.logger.info("View: Bind '"+this.element+"' and object "+object+" with property: "+prop,this.logger.view);to=setting.to||"text";strategy=setting.strategy||"swap";transform=setting.transform||function(x){return x};view=this;clb=function(result){var txt;txt=transform(result.text);return view.render(txt)[strategy](to)};new Sirius.Observer({object:object,prop:prop},clb)};View.prototype._bind_view=function(view,setting){var clb,current,from,strategy,to;this.logger.info("Bind '"+this.element+"' with '"+view.element+"'",this.logger.view);to=setting.to||"text";from=setting.from||"text";strategy=setting.strategy||"swap";this.logger.info("for '"+view.element+"' use to: '"+to+"' and from: '"+from+"', strategy: "+strategy,this.logger.view);current=this.element;clb=function(result){var txt;txt=result.text;return view.render(txt)[strategy](to)};return new Sirius.Observer(current,clb)};View.prototype.bind2=function(klass,setting){if(setting==null){setting={}}this.bind(klass,setting.model||{});if(klass.bind&&Sirius.Utils.is_function(klass.bind)){return klass.bind(this,setting.view||{})}};View.register_strategy=function(name,object){var logger,msg,render,transform;if(object==null){object={}}logger=Sirius.Application.get_logger();logger.info("View: Register new Strategy "+name,logger.view);transform=object.transform;render=object.render;if(!Sirius.Utils.is_function(transform)){msg="Strategy must be Function, but "+(typeof transform)+" given.";logger.error("View: "+msg,logger.view);throw new Error(msg)}if(!Sirius.Utils.is_function(render)){msg="Strategy must be Function, but "+(typeof render)+" given.";logger.error("View: "+msg,logger.view);throw new Error(msg)}if(!Sirius.Utils.is_string(name)){msg="Strategy name must be String, but "+(typeof name)+" given.";logger.error("View: "+msg,logger.view);throw new Error(msg)}this._Strategies.push([name,transform,render]);return null};return View})();Sirius.View.register_strategy("swap",{transform:function(oldvalue,newvalue){return""+newvalue},render:function(adapter,element,result,attribute){var r;if(attribute==="text"){return adapter.swap(element,result)}else{if(attribute==="checked"){r=Sirius.Utils.is_string(result)?result==="true"?true:false:!!result;return adapter.set_prop(element,"checked",r)}else{return adapter.set_attr(element,attribute,result)}}}});Sirius.View.register_strategy("append",{transform:function(oldvalue,newvalue){return newvalue},render:function(adapter,element,result,attribute){var tag;tag=adapter.get_attr(element,"tagName");if(tag==="INPUT"||tag==="TEXTAREA"||tag==="SELECT"){throw new Error("'append' strategy not work for `input` or `textarea` or `select` elements")}if(attribute==="text"){return adapter.append(element,result)}else{throw new Error("Strategy 'append' only work for 'text' content, not for '"+attribute+"'")}}});Sirius.View.register_strategy("prepend",{transform:function(oldvalue,newvalue){return newvalue},render:function(adapter,element,result,attribute){var tag;tag=adapter.get_attr(element,"tagName");if(tag==="INPUT"||tag==="TEXTAREA"||tag==="SELECT"){throw new Error("'prepend' strategy not work for `input` or `textarea` or `select` elements")}if(attribute==="text"){return adapter.prepend(element,result)}else{throw new Error("Strategy 'prepend' only work for 'text' content, not for '"+attribute+"'")}}});Sirius.View.register_strategy("clear",{transform:function(oldvalue,newvalue){return""},render:function(adapter,element,result,attribute){return adapter.clear(element)}});ComputedField=(function(){function ComputedField(main,fields1,fn1){this.main=main;this.fields=fields1;this.fn=fn1!=null?fn1:null;this._count=this.fields.length;this._values=[]}ComputedField.prototype.get_fields=function(){return this.fields};ComputedField.prototype.complete=function(field,value){var o,v;o={};o[field]=value;v=this._values.map(function(f){return Object.keys(f)[0]});if(v.indexOf(field)===-1){this._values.push(o);if(this.is_full()){return this._result()}else{return null}}else{return null}};ComputedField.prototype.field_name=function(){return this.main};ComputedField.prototype.remove=function(field){return delete this._values[field]};ComputedField.prototype._result=function(){var args,v;v=this._values;args=this.fields.map(function(f){return(v.filter(function(vv){return vv[f]}))[0][f]});if(this.fn===null){return args.join(" ")}else{return this.fn.apply(null,args)}};ComputedField.prototype.is_full=function(){return this._values.length===this._count};return ComputedField})();Sirius.BaseModel=(function(){BaseModel._Validators=[];BaseModel.attrs=[];BaseModel.skip=false;BaseModel.has_many=[];BaseModel.has_one=[];BaseModel.belongs_to=[];BaseModel.guid_for=null;BaseModel.validate={};BaseModel.comp=function(){var _tmp,args,base,base1,base2,deps,field,fn,full,length,r,ref,uniq,xs;args=1<=arguments.length?slice.call(arguments,0):[];(base=this.prototype)._cmp||(base._cmp=[]);(base1=this.prototype)._cmp_fields||(base1._cmp_fields=[]);(base2=this.prototype)._cmp_refs||(base2._cmp_refs={});if(args.length===0){throw new Exception("Compute field is empty")}if(args.length===2){throw new Exception("For computed fields need more fields")}field=args[0];length=args.length;ref=Sirius.Utils.is_function(args[length-1])?(fn=args[length-1],[args.slice(1,length-1),args.slice(1,length-1),fn]):[args.slice(1),args.slice(1),null],deps=ref[0],xs=ref[1],fn=ref[2];full=[field].concat(deps);uniq=full.filter(function(e,i,a){return a.indexOf(e)===i});if(uniq.length!==full.length){throw new Error("Seems your calculated fields are not unique: ["+full+"]")}_tmp=this.attrs.concat(this.prototype._cmp_fields);deps.forEach(function(f){if(_tmp.indexOf(f)===-1){throw new Error("Field is '"+f+"' not found, for '"+field+"'")}});if(this.prototype._cmp_fields.length>0){r=deps.filter((function(_this){return function(f){return _this.prototype._cmp_refs[f]&&_this.prototype._cmp_refs[f].indexOf(field)!==-1}})(this));if(r.length>0){throw new Error("Cyclic references detected in '"+field+"' field")}}Sirius.Application.get_logger().info("Define compute field '"+field+"' <- '["+deps+"]'",Sirius.Application.get_logger().base_model);this.prototype._cmp_refs[field]=deps;this.prototype._cmp_fields.push(field);return this.prototype._cmp.push(new ComputedField(field,xs,fn))};BaseModel.prototype.attrs=function(){return(this.constructor.attrs||[]).concat(this.constructor.prototype._cmp_fields)};BaseModel.prototype.__name="BaseModel";BaseModel.prototype.normal_name=function(){return Sirius.Utils.underscore(this.constructor.name)};BaseModel.prototype.has_many=function(){return this.constructor.has_many||[]};BaseModel.prototype.has_one=function(){return this.constructor.has_one||[]};BaseModel.prototype.belongs_to=function(){return this.constructor.belongs_to||[]};BaseModel.prototype.validators=function(){return this.constructor.validate};BaseModel.prototype.guid_for=function(){return this.constructor.guid_for};BaseModel.prototype._compute=function(field,value){var self;self=this;return this.constructor.prototype._cmp.forEach(function(cf){var r;if(cf.get_fields().indexOf(field)!==-1){r=cf.complete(field,value);if(cf.is_full()){return self._set(cf.field_name(),r)}}})};BaseModel.prototype.normalize_attrs=function(){var a,len,ref,results,u;ref=this.attrs();results=[];for(u=0,len=ref.length;u<len;u++){a=ref[u];results.push((function(a){if(Sirius.Utils.is_object(a)){return Object.keys(a)[0]}else{return a}})(a))}return results};function BaseModel(obj){var aa,attr,attributes,attrs0,base,base1,g,key,klass,len,len1,len2,len3,msg,name,oldvalue,ref,ref1,ref2,ref3,ref4,skip,u,validator,validator_name,value,w,y;if(obj==null){obj={}}(base=this.constructor.prototype)._cmp||(base._cmp=[]);(base1=this.constructor.prototype)._cmp_fields||(base1._cmp_fields=[]);this.logger=Sirius.Application.get_logger();this.callbacks=[];this.errors={};this.attributes=this.normalize_attrs();name=Sirius.Utils.fn_name(this.constructor);this.errors={};this._is_valid_attr={};attrs0=this.attrs();for(u=0,len=attrs0.length;u<len;u++){attr=attrs0[u];this.logger.info("define '"+(JSON.stringify(attr))+"' attribute for '"+name+"'",this.logger.base_model);if(Sirius.Utils.is_object(attr)){ref=Object.keys(attr),key=ref[0];if(!key){msg="Attributes should have a key and value";this.logger.error(""+msg,this.logger.base_model);throw new Error(msg)}this["_"+key]=attr[key];this._gen_method_name_for_attribute(key)}else{this._gen_method_name_for_attribute(attr);this["_"+attr]=null}}ref1=this.has_many();for(w=0,len1=ref1.length;w<len1;w++){klass=ref1[w];this.logger.info("BaseModel: has many attribute: "+klass,this.logger.base_model);this["_"+klass]=[];this.attributes.push(""+klass);this._has_create(klass);this._gen_method_name_for_attribute(klass,true)}ref2=this.has_one();for(y=0,len2=ref2.length;y<len2;y++){klass=ref2[y];this.logger.info("BaseModel: has one attribute: "+klass,this.logger.base_model);this["_"+klass]=null;this.attributes.push(""+klass);this._has_create(klass,true);this._gen_method_name_for_attribute(klass,true)}skip=this.constructor.skip;attributes=this.attributes;if(Object.keys(obj).length!==0){ref3=Object.keys(obj);for(aa=0,len3=ref3.length;aa<len3;aa++){attr=ref3[aa];if(!(attributes.indexOf(attr)===-1&&skip)){this._attribute_present(attr);oldvalue=this["_"+attr];this["_"+attr]=obj[attr];this._call_callbacks(attr,obj[attr],oldvalue)}}}if(g=this.guid_for()){this.set(g,this._generate_guid())}this._registered_validators=this.constructor._Validators;this._registered_validators_keys=this._registered_validators.map(function(arr){return arr[0]});this._model_validators=this.validators();ref4=this._model_validators;for(key in ref4){value=ref4[key];this.errors[key]={};this._is_valid_attr[key]=false;for(validator_name in value){validator=value[validator_name];if(this._registered_validators_keys.indexOf(validator_name)===-1&&validator_name!=="validate_with"){throw new Error("Unregistered validator: "+validator_name)}this.errors[key][validator_name]=""}}this.after_create()}BaseModel.prototype._gen_method_name_for_attribute=function(attribute,when_has_attribute){var normalize_name;if(when_has_attribute==null){when_has_attribute=false}normalize_name=Sirius.Utils.underscore(attribute);if(Object.keys(this).indexOf(normalize_name)!==-1){throw new Error("Method "+normalize_name+" already exist")}return this[normalize_name]=(function(_this){return function(value){if(value!=null){if(when_has_attribute){return _this["add_"+attribute](value)}else{return _this.set(attribute,value)}}else{return _this.get(attribute)}}})(this)};BaseModel.prototype._generate_guid=function(){var s4;s4=function(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)};return""+(s4())+(s4())+"-"+(s4())+"-"+(s4())+"-"+(s4())+"-"+(s4())+(s4())+(s4())};BaseModel.prototype._has_create=function(klass,is_one){if(is_one==null){is_one=false}return this["add_"+klass]=(function(_this){return function(z){var b_model,back,expected,i,key,m_name,me,name;name=z.constructor.name;me=_this.normal_name();m_name=_this.constructor.name;expected=klass.charAt(0).toUpperCase()+klass.slice(1);if(name!==expected){throw new Error("Expected "+expected+", but given: "+name)}if(is_one){if(_this.get(""+klass)){throw new Error("Model "+expected+" already exist for "+m_name)}_this.set(""+klass,z)}else{_this.get(""+klass).push(z)}b_model=((function(){var len,ref,results,u;ref=z.belongs_to();results=[];for(u=0,len=ref.length;u<len;u++){i=ref[u];if(i.model===me){results.push(i)}}return results})())[0];if(!b_model){throw new Error("Model "+name+" must contain '@belongs_to: [{model: "+me+", back: "+me+"_id]'")}if(!(back=b_model.back)){throw new Error("Define 'back' property for @belongs_to")}if(_this.attributes.indexOf(back)===-1){throw new Error("Foreign key: '"+back+"' not contain in a '"+m_name+"' model")}key=(b_model.compose||function(model,back){return model+"_"+back})(me,back);if(z.attributes.indexOf(key)===-1){throw new Error("Define "+key+" in @attrs for '"+expected+"' model")}return z.set(""+key,_this.get(back))}})(this)};BaseModel.prototype.get_attributes=function(){return this.attributes};BaseModel.prototype._is_computed_attribute=function(attr){if(this.constructor.prototype._cmp_fields.indexOf(attr)!==-1){return true}else{return false}};BaseModel.prototype._attribute_present=function(attr){if(this.attributes.indexOf(attr)===-1){throw new Error("Attribute '"+attr+"' not found for "+(this.normal_name().toUpperCase())+" model")}};BaseModel.prototype._call_callbacks=function(attr,value,oldvalue){var clb,len,ref,u;ref=this.callbacks;for(u=0,len=ref.length;u<len;u++){clb=ref[u];if(clb[0]===attr){clb[1].apply(null,[attr,value,oldvalue])}}return this.after_update(attr,value,oldvalue)};BaseModel.prototype.set=function(attr,value){if(this._is_computed_attribute(attr)){throw new Error("Impossible set computed attribute "+attr+" for "+(this.normal_name().toUpperCase()))}return this._set(attr,value)};BaseModel.prototype._set=function(attr,value){var k,oldvalue,v;this._attribute_present(attr);oldvalue=this["_"+attr];if(Sirius.Utils.is_object(oldvalue)){if(!Sirius.Utils.is_object(value)){throw new Error("Attribute '"+attr+"' is object, but value '"+value+"' not object.")}for(k in value){v=value[k];oldvalue[k]=v}}else{this["_"+attr]=value}this.validate(attr);this._compute(attr,value);return this._call_callbacks(attr,value,oldvalue)};BaseModel.prototype.get=function(attr){this._attribute_present(attr);return this["_"+attr]};BaseModel.prototype.reset=function(){var args,attr,attrs,key,len,u;args=1<=arguments.length?slice.call(arguments,0):[];attrs=this.attributes;for(u=0,len=args.length;u<len;u++){attr=args[u];if(attrs.indexOf(attr)===-1){throw new Error("Attribute '"+attr+"' not found for "+(this.normal_name().toUpperCase())+" model")}key="_"+attr;if(typeof this[key]==="number"){this[key]=0}if(Sirius.Utils.is_string(this[key])){this[key]=""}if(Sirius.Utils.is_array(this[key])){this[key]=[]}if(this.errors[key]!=null){this.errors[key]={}}}};BaseModel.prototype.is_valid=function(){return Object.keys(this._is_valid_attr).filter((function(_this){return function(key){return !_this._is_valid_attr[key]}})(this)).length===0};BaseModel.prototype.validate=function(field){if(field==null){field=null}Object.keys(this._model_validators||{}).filter(function(key){if(field!=null){return key===field}else{return true}}).map((function(_this){return function(key){var current_value,klass,result,results,validator_key,validator_value,value,z;current_value=_this.get(key);value=_this._model_validators[key];results=[];for(validator_key in value){validator_value=value[validator_key];klass=validator_key==="validate_with"?(z=new Sirius.Validator(),z.validate=validator_value,z.msg=null,z):(z=_this._registered_validators.filter(function(arr){return arr[0]===validator_key})[0][1],new z());result=klass.validate(current_value,validator_value);if(!result){_this.errors[key][validator_key]=klass.error_message();results.push(_this._is_valid_attr[key]=false)}else{_this.errors[key][validator_key]="";results.push(_this._is_valid_attr[key]=true)}}return results}})(this))};BaseModel.prototype.get_errors=function(attr){var key,ref,result,value;if(attr==null){attr=null}if(this.attributes.indexOf(attr)===-1&&attr!==null){throw new Error("Attribute '"+attr+"' not found for "+(this.normal_name().toUpperCase())+" model")}if(attr!=null){result=[];ref=this.errors[attr];for(key in ref){value=ref[key];if(value!==""){result.push(value)}}return result}else{return this.errors}};BaseModel.prototype.set_error=function(error,txt){var keys;keys=error.split(".");if(keys.length!==2){throw new Error("Error must be pass as 'attr.validator' like 'name.length'")}this.errors[keys[0]][keys[1]]=txt;return this._is_valid_attr[keys[0]]=false};BaseModel.prototype.save=function(exception){var name;if(exception==null){exception=false}this.validate();name=this.constructor.name;if(exception&&!this.is_valid()){throw new Error(name+" model not valid!")}if(this.is_valid()){return false}return true};BaseModel.prototype.to_json=function(){var args,attr,len,ref,u,v,value,z;args=1<=arguments.length?slice.call(arguments,0):[];z={};ref=this.attributes;for(u=0,len=ref.length;u<len;u++){attr=ref[u];if(!(args.indexOf(attr)===-1)){continue}value=this.get(""+attr);z[""+attr]=(function(){var len1,results,w;if(this.has_many().indexOf(attr)>-1){results=[];for(w=0,len1=value.length;w<len1;w++){v=value[w];results.push(JSON.parse(v.to_json()))}return results}else{if(this.has_one().indexOf(attr)>-1){return JSON.parse(value.to_json())}else{return value}}}).call(this)}return JSON.stringify(z)};BaseModel.from_json=function(json,models){var attr,attrs,key,len,m,model,ref,u,value,z;if(models==null){models={}}m=new this;json=JSON.parse(json);attrs=[].concat(m.attrs(),m.has_many(),m.has_one());for(u=0,len=attrs.length;u<len;u++){attr=attrs[u];if(typeof attr==="object"){ref=Object.keys(attr),key=ref[0];m.set(key,json[key]||attr[key])}else{value=(function(){var len1,ref1,results,w;if(m.has_many().indexOf(attr)>-1){model=models[attr];if(model){ref1=json[attr];results=[];for(w=0,len1=ref1.length;w<len1;w++){z=ref1[w];results.push(model.from_json(JSON.stringify(z),models))}return results}else{return json[attr]}}else{if(m.has_one().indexOf(attr)>-1){model=models[attr];if(model){return model.from_json(JSON.stringify(json[attr]),models)}else{return json[attr]}}else{return json[attr]}}})();m.set(attr,value||m.get(attr))}}return m};BaseModel.prototype.compare=function(other){throw new Error("`compare` method must be overridden")};BaseModel.prototype.after_create=function(){};BaseModel.prototype.after_update=function(attribute,newvalue,oldvalue){};BaseModel.prototype.clone=function(){return this.constructor.from_json(this.to_json())};BaseModel.prototype.bind=function(view,object_setting){var callbacks,current_model,errors,logger,msg;if(object_setting==null){object_setting={}}current_model=this;if(!(view.name&&view.name()==="View")){msg="Sirius.BaseModel#bind only work with Sirius.View";this.logger.error(msg,this.logger.base_model);throw new Error(msg)}this.logger.info("Bind with "+view.element,this.logger.base_model);Object.keys(object_setting).map((function(_this){return function(key){var i,ref,results,u;if(Sirius.Utils.is_array(object_setting[key])){results=[];for(i=u=0,ref=object_setting[key].length;0<=ref?u<ref:u>ref;i=0<=ref?++u:--u){if(object_setting[key][i]["transform"]==null){_this.logger.info("bind define default transform method for '"+key+"'",_this.logger.base_model);results.push(object_setting[key][i]["transform"]=function(x){return x})}else{results.push(void 0)}}return results}else{if(object_setting[key]["transform"]==null){_this.logger.info("bind define default transform method for '"+key+"'",_this.logger.base_model)}return object_setting[key]["transform"]=function(x){return x}}}})(this));callbacks=this.callbacks;errors=this.errors;logger=this.logger;return Sirius.Application.get_adapter().and_then((function(_this){return function(adapter){var attr,attributes,current,element,elements,fn1,len,len1,ref,results,self,u,w;current=view.element;elements=new Sirius.BindHelper(current,false).extract(adapter,object_setting);attributes=_this.attributes;self=_this;fn1=function(element){var clb,from,key,prop,strategy,transform;if(element.view==null){element.view=new Sirius.View(element.element)}strategy=element.strategy;transform=element.transform;if(!Sirius.View.is_valid_strategy(strategy)){logger.error("Not valid strategy: '"+strategy+"'",logger.base_model);throw new Error("Strategy "+strategy+" not valid")}if(attributes.indexOf(element.from)!==-1){clb=function(attr,value,oldvalue){var current_value,k,result,results,tag,type,v;result=element.transform(value);tag=adapter.get_attr(element.element,"tagName");type=adapter.get_attr(element.element,"type");if(element.to==="text"&&tag!=="SELECT"&&(["checkbox","radio"].indexOf(type)===-1)){if(adapter.text(element.element)===result){return}}else{if(adapter.get_attr(element.element,element.to)===result){return}}if(attr===element.from){if(element.to==="text"){if(tag==="OPTION"){current_value=adapter.get_attr(element.element,"value");if(current_value===value){return adapter.set_prop(element.element,"selected",true)}}else{return element.view.render(result)[strategy](element.to)}}else{if(element.to==="checked"){current_value=adapter.get_attr(element.element,"value");if(value[current_value]!=null){if(value[current_value]===true){adapter.set_prop(element.element,"checked",true)}else{adapter.set_prop(element.element,"checked",false)}if(type==="radio"){results=[];for(k in oldvalue){v=oldvalue[k];if(current_value!==k){results.push(self["_"+attr][k]=false)}}return results}}}else{return element.view.render(result)[strategy](element.to)}}}};return callbacks.push([element.from,clb])}else{from=element.from;if(from.indexOf("errors")!==0){throw new Error("BaseModel for bind errors need pass 'errors.attr.validator' like: 'errors.name.length'")}prop=from.split(".");logger.info("bind '"+element.from+"' for model",logger.base_model);if(prop.length===3){return element.view.bind(current_model.errors,prop.slice(1).join("."),{to:element.to,strategy:strategy,transform:transform})}else{if(prop.length===2){key=prop[1];return Object.keys(errors[key]).forEach(function(validator_name){return element.view.bind(current_model.errors,key+"."+validator_name,{to:element.to,strategy:strategy,transform:transform})})}else{throw new Error("Impossible bind '"+from+"' with model")}}}};for(u=0,len=elements.length;u<len;u++){element=elements[u];fn1(element)}ref=_this.attributes;results=[];for(w=0,len1=ref.length;w<len1;w++){attr=ref[w];if(_this.get(attr)!==null){results.push(_this.set(attr,_this.get(attr)))}}return results}})(this))};BaseModel.prototype.bind2=function(klass){this.bind(klass);if(klass.name&&klass.name()==="View"){if(klass.bind&&Sirius.Utils.is_function(klass.bind)){return klass.bind(this)}else{return new Error("For double-sided binding need bind method, but it not found in "+klass)}}else{return new Error("BaseModel#bind2 work only with Sirius.View")}};BaseModel.define_model=function(setting){var Tmp,k,predefined_attributes,v;predefined_attributes=["attrs","has_many","has_one","belongs_to","guid_for","validate"];Tmp=(function(superClass){extend(Tmp,superClass);function Tmp(){return Tmp.__super__.constructor.apply(this,arguments)}Tmp.attrs=setting.attrs||[];Tmp.has_many=setting.has_many||[];Tmp.has_one=setting.has_one||[];Tmp.belongs_to=setting.belongs_to||[];Tmp.guid_for=setting.guid_for||null;Tmp.validate=setting.validate||{};return Tmp})(Sirius.BaseModel);for(k in setting){v=setting[k];if(predefined_attributes.indexOf(k)===-1){Tmp.prototype[k]=v}}return Tmp};BaseModel.register_validator=function(name,klass){var logger;logger=Sirius.Application.get_logger();logger.info("register validator: "+name,logger.base_model);this._Validators.push([name,klass]);return null};return BaseModel})();Sirius.BaseModel.register_validator("length",Sirius.LengthValidator);Sirius.BaseModel.register_validator("exclusion",Sirius.ExclusionValidator);Sirius.BaseModel.register_validator("inclusion",Sirius.InclusionValidator);Sirius.BaseModel.register_validator("format",Sirius.FormatValidator);Sirius.BaseModel.register_validator("numericality",Sirius.NumericalityValidator);Sirius.BaseModel.register_validator("presence",Sirius.PresenceValidator);Sirius.Collection=(function(){Collection._EVENTS=["add","remove","sync","unsync"];function Collection(){var args,attrs,e,klass,klasses,len,options,ref,u;klass=arguments[0],args=2<=arguments.length?slice.call(arguments,1):[];if(klass.__super__.__name!=="BaseModel"){throw new Error("Collection must be used only with `BaseModel` inheritor")}this._array=[];this.logger=Sirius.Application.get_logger();klasses=[];options={};if(args.length===1){if(Sirius.Utils.is_array(args[0])){klasses=args[0]}else{options=args[0]}}if(args.length===2){klasses=args[0];options=args[1]}this._klasses=klasses;this._klass=klass;this._type=Sirius.Utils.fn_name(klass);this._indexes=options.index||[];if(this._indexes.length>0){attrs=klass.prototype.attrs().map(function(attr){if(Sirius.Utils.is_object(attr)){return Object.keys(attr)[0]}else{return attr}});this._indexes.forEach(function(field){if(attrs.indexOf(field)===-1){throw new Error("Collection: field "+field+" from indexes: ["+this._indexes+"] not exist in "+this._type)}});this._indexes.forEach((function(_this){return function(field){_this.logger.info("create index for "+field+" field in "+_this._type,_this.logger.collection);return _this["index_"+field]={}}})(this))}this._subscribers={};ref=this.constructor._EVENTS;for(u=0,len=ref.length;u<len;u++){e=ref[u];this._subscribers[e]=[]}this.length=0;if(options.remote){this.remote=(function(_this){return function(){var json,len1,model,result,results,w;result=options.remote();json=JSON.parse(result);if(Sirius.Utils.is_array(json)){if(json.length!==0){results=[];for(w=0,len1=json.length;w<len1;w++){model=json[w];results.push(_this.push(klass.from_json(JSON.stringify(model),_this._klasses)))}return results}}else{return _this.push(klass.from_json(result,_this._klasses))}}})(this)}this._timer=null;this._start_sync(options.every||0)}Collection.prototype._start_sync=function(every){if(every!==0){this.logger.info("start synchronization",this.logger.collection);this._timer=setInterval(this.remote,every);this._gen("sync")}};Collection.prototype.unsync=function(){if(this._timer){this.logger.info("Collection: end synchronization",this.logger.collection);clearInterval(this._timer);this._gen("unsync")}};Collection.prototype.sync=function(every){return this._start_sync(every)};Collection.prototype.push=function(model){return this.add(model)};Collection.prototype.add=function(model){this._add(model)};Collection.prototype._add=function(model){var msg,type;type=Sirius.Utils.fn_name(model.constructor);if(this._type!==type){msg="Require `"+this._type+"`, but given `"+type+"`";this.logger.error("Collection: "+msg,this.logger.collection);throw new Error(msg)}this._array.push(model);if(this._indexes.length>0){this._indexes.forEach((function(_this){return function(field){return _this["index_"+field][model.get(field)]=_this.length}})(this))}this.length++;return this._gen("add",model)};Collection.prototype.remove=function(other){var inx;inx=this.index(other);if(inx!==null){this._array.splice(inx,1);this._gen("remove",other);this.length--;if(this._indexes.length>0){this._indexes.forEach((function(_this){return function(field){var fields;delete _this["index_"+field][other.get(field)];fields=Object.keys(_this["index_"+field]);return fields.filter(function(x){return _this["index_"+field][x]>inx}).map(function(x){var z;z=_this["index_"+field][x];return _this["index_"+field][x]=z-1})}})(this))}}};Collection.prototype.index=function(other){var i,inx,len,model,ref,u;inx=null;ref=this._array;for(i=u=0,len=ref.length;u<len;i=++u){model=ref[i];if(model.compare(other)){inx=i}}return inx};Collection.prototype.find=function(key,value){return this.find_all(key,value)[0]||null};Collection.prototype.find_all=function(key,value){var len,model,ref,results,u;if(this._indexes.length>0&&this._indexes.indexOf(key)!==-1){return[this._array[this["index_"+key][value]]]}else{ref=this._array;results=[];for(u=0,len=ref.length;u<len;u++){model=ref[u];if(model.get(key)===value){results.push(model)}}return results}};Collection.prototype.filter=function(fn){var len,model,ref,results,u;if(fn==null){fn=function(){}}ref=this._array;results=[];for(u=0,len=ref.length;u<len;u++){model=ref[u];if(fn.call(null,model)){results.push(model)}}return results};Collection.prototype.each=function(fn){var len,model,ref,results,u;if(fn==null){fn=function(){}}ref=this._array;results=[];for(u=0,len=ref.length;u<len;u++){model=ref[u];results.push(fn.call(model))}return results};Collection.prototype.first=function(){return this._array[0]};Collection.prototype.last=function(){return this._array[this._array.length-1]};Collection.prototype.all=function(){return this._array};Collection.prototype.clear=function(){this.length=0;this._array=[];if(this._indexes.length>0){return this._indexes.forEach((function(_this){return function(field){return _this["index_"+field]={}}})(this))}};Collection.prototype.map=function(f){return this.collect(f)};Collection.prototype.collect=function(f){return this._array.map(f)};Collection.prototype.takeFirst=function(f){var e,len,ref,result,u;result=null;ref=this._array;for(u=0,len=ref.length;u<len;u++){e=ref[u];if(f(e)){result=e;break}}return result};Collection.prototype.size=function(){return this._array.length};Collection.prototype.from_json=function(json){var j,jj,len,u;j=JSON.stringify(json);if(Sirius.Utils.is_array(j)){for(u=0,len=j.length;u<len;u++){jj=j[u];this._array.push(this._klass.from_json(jj));this.length++}}else{this._array.push(this._klass.from_json(json));this.length++}return this};Collection.prototype.to_json=function(){var e,z;z=(function(){var len,ref,results,u;ref=this._array;results=[];for(u=0,len=ref.length;u<len;u++){e=ref[u];results.push(e.to_json())}return results}).call(this);return JSON.parse(JSON.stringify(z))};Collection.prototype.subscribe=function(event,fn_or_event){if(this.constructor._EVENTS.indexOf(event)===-1){throw new Error("For 'subscribe' method available only ["+this.constructor._EVENTS+"], but given '"+event+"'")}if(Sirius.Utils.is_string(fn_or_event)||Sirius.Utils.is_function(fn_or_event)){this.logger.info("Collection: Add new subscriber for '"+event+"' event",this.logger.collection);this._subscribers[event].push(fn_or_event)}else{throw new Error("Second parameter for 'subscribe' method must be Function or String, but '"+(typeof fn_or_event)+"' given")}};Collection.prototype._gen=function(){var args,event,subscribers;event=arguments[0],args=2<=arguments.length?slice.call(arguments,1):[];subscribers=this._subscribers[event];return Sirius.Application.get_adapter().and_then(function(adapter){var len,results,subsriber,u;results=[];for(u=0,len=subscribers.length;u<len;u++){subsriber=subscribers[u];if(Sirius.Utils.is_string(subsriber)){results.push(adapter.fire.apply(adapter,[document,subsriber].concat(slice.call(args))))}else{results.push(subsriber.apply(null,args))}}return results})};return Collection})();