/*!
 *  Sirius.js v0.8.5
 *  (c) 2014-2015 fntz
 *  license: MIT
 */
;var c=function(m){console.log(m)};var ComputedField,Sirius,slice=[].slice,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key)){child[key]=parent[key]}}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty,bind=function(fn,me){return function(){return fn.apply(me,arguments)}};Sirius={VERSION:"0.8.5"};Sirius.Logger=(function(){Logger.Levels=["debug","info","warn","error"];Logger.Filters=["BaseModel","Binding","Collection","View","Routing","Application","Redirect","Validation","Transformer"];function Logger(log_enabled,filters,logger_function){var f,fn1,len,len1,level,n,pre_filters,ref,u;pre_filters=Sirius.Logger.Filters;for(n=0,len=pre_filters.length;n<len;n++){f=pre_filters[n];this[Sirius.Utils.underscore(f).toLowerCase()]=f}ref=Sirius.Logger.Levels;fn1=(function(_this){return function(level){return _this[level]=function(msg,location){if(log_enabled){if(!location){return logger_function(level.toUpperCase(),msg)}else{if(filters.indexOf(location)!==-1||((location==null)||pre_filters.indexOf(location)===-1)){msg="["+(location.toUpperCase())+"] "+msg;return logger_function(level.toUpperCase(),msg)}}}}}})(this);for(u=0,len1=ref.length;u<len1;u++){level=ref[u];fn1(level)}}return Logger})();Sirius.Internal={};Sirius.Promise=(function(){function Promise(value1){this.value=value1;this.fn=function(){}}Promise.prototype.and_then=function(fn){if(this.value!=null){return fn(this.value)}else{return this.fn=fn}};Promise.prototype.set_value=function(value){this.value=value;return this.fn(value)};return Promise})();Sirius.Utils=(function(){function Utils(){}Utils.is_function=function(a){return Object.prototype.toString.call(a)==="[object Function]"};Utils.is_string=function(a){return Object.prototype.toString.call(a)==="[object String]"};Utils.is_array=function(a){return Object.prototype.toString.call(a)==="[object Array]"};Utils.is_object=function(a){return a!==null&&typeof a==="object"};Utils.camelize=function(str){return str.charAt(0).toUpperCase()+str.slice(1)};Utils.underscore=function(str){return str.replace(/([A-Z])/g,"_$1").replace(/^_/,"").toLowerCase()};Utils.ie_version=function(){var msie,rv,trident,ua;ua=window.navigator.userAgent;msie=ua.indexOf("MSIE ");trident=ua.indexOf("Trident/");if(msie>0){return parseInt(ua.substring(msie+5,ua.indexOf(".",msie)),10)}if(trident>0){rv=ua.indexOf("rv:");return parseInt(ua.substring(rv+3,ua.indexOf(".",rv)),10)}return 0};Utils.is_ie9=function(){return this.ie_version()===9};Utils.fn_name=function(fn){if(this.is_function(fn)){return fn.toString().match(/function ([^\(]+)/)[1]}else{throw new Error("Need function, given "+(typeof fn))}};return Utils})();Sirius.redirect=function(url){var app;app=Sirius.Application;app.logger.info("Redirect to "+url,app.logger.redirect);if(app.use_hash_routing_for_old_browsers&&!app.push_state_support){url=url.indexOf("#")===0?url:url.indexOf("/")===0?"#"+url:"#/"+url}if(url.indexOf("#")===0){if(app.push_state_support){return location.replace(url)}}else{if(app.push_state_support){return Sirius.Internal.RouteSystem.dispatch.call(null,{type:"redirect",target:{href:url}})}}};Sirius.Internal.RoutePart=(function(){function RoutePart(route){var parts;this.end=true;this.start=null;this.parts=[];this.args=[];parts=route.replace(/\/$/,"").split("/");if(parts[0]===""){parts[0]="#"}if(parts[parts.length-1]==="*"){this.end=false}this.parts=parts.slice(0)}RoutePart.prototype.match=function(url){var args,cp,gp,i,is_end_part,is_named_part,is_regexp_part,parts,r,ref;this.args=[];parts=url.replace(/\/$/,"").split("/");if(parts[0]===""){parts[0]="#"}if((parts.length!==this.parts.length)&&this.end){return false}if((this.parts.length>1)&&parts.length<this.parts.length){return false}is_named_part=function(part){return part.indexOf(":")===0};is_regexp_part=function(part){return part.indexOf("[")===0};is_end_part=function(part){return part.indexOf("*")===0};i=-1;args=[];while(i<10){i++;ref=[this.parts[i],parts[i]],cp=ref[0],gp=ref[1];if(!cp||!gp){break}if(is_named_part(cp)){args.push(parts[i]);continue}if(is_regexp_part(cp)){r=new RegExp("^"+cp+"$");if(!r.test(gp)){return false}args.push(r.exec(gp)[0]);continue}if(is_end_part(cp)){args=args.concat(parts.slice(i));break}if(cp!==gp){return false}}this.args=args;return true};return RoutePart})();Sirius.Internal.ControlFlow=(function(){function ControlFlow(params,wrapper){var act,action,controller,extract,msg;if(wrapper==null){wrapper=function(x){return x}}this.logger=Sirius.Application.get_logger();controller=params.controller||(function(){throw new Error("Params must contain a Controller")})();act=params.action;action=(function(){if(Sirius.Utils.is_string(act)){return controller[act]}else{if(Sirius.Utils.is_function(act)){return act}else{msg="Action must be string or function";this.logger.error("ControlFlow: "+msg,this.logger.routing);throw new Error(msg)}}}).call(this);if(!action){msg="action "+act+" not found in controller "+controller;this.logger.error("ControlFlow: "+msg,this.logger.routing);throw new Error(msg)}this.action=wrapper(action);extract=function(property,is_guard){var err,k,p,t;if(is_guard==null){is_guard=false}p=params[property];k=controller[property+"_"+act];err=function(a){return new Error(a+" action must be string or function")};if(Sirius.Utils.is_string(p)){t=controller[p];if(!Sirius.Utils.is_function(t)){throw err(Sirius.Utils.camelize(property))}return t}else{if(Sirius.Utils.is_function(p)){return p}else{if(p){throw err(Sirius.Utils.camelize(property))}else{if(k){if(!Sirius.Utils.is_function(k)){throw err(Sirius.Utils.camelize(property))}return k}else{if(!is_guard){return function(){}}else{return null}}}}}};this.before=extract("before");this.after=extract("after");this.guard=extract("guard",true);this.data=params.data||null;this.controller=controller;return}ControlFlow.prototype.handle_event=function(){var args,data,e,merge,ref,result;e=arguments[0],args=2<=arguments.length?slice.call(arguments,1):[];this.logger.debug("ControlFlow: Start event processing",this.logger.routing);if(e){data=Sirius.Utils.is_array(this.data)?this.data:this.data?[this.data]:[];result=Sirius.Application.adapter.get_property(e,data);merge=[].concat([],[e],result);merge=(ref=[]).concat.apply(ref,[[],merge].concat(slice.call(args)));if(this.guard){if(this.guard.apply(this.controller,merge)){this.before.apply(this.controller);this.action.apply(this.controller,merge);return this.after.apply(this.controller)}}else{this.before.apply(this.controller);this.action.apply(this.controller,merge);return this.after.apply(this.controller)}}else{args=[].concat.apply([],args);if(this.guard){if(this.guard.apply(this.controller,args)){this.before.apply(this.controller);this.action.apply(this.controller,args);return this.after.apply(this.controller)}}else{this.before.apply(this.controller);this.action.apply(this.controller,args);return this.after.apply(this.controller)}}};ControlFlow.prototype.tick=function(){this.logger.debug("ControlFlow: tick",this.logger.routing);if(this.guard){if(this.guard.apply(this.controller)){this.before.apply(this.controller);this.action.apply(this.controller);return this.after.apply(this.controller)}}else{this.before.apply(this.controller);this.action.apply(this.controller);return this.after.apply(this.controller)}};return ControlFlow})();Sirius.Internal.RouteSystem={_every:"every",_scheduler:"scheduler",_once:"once",_selector:"a:not([href^='#'])",_is_hash_route:function(url){return url.toString().indexOf("#")===0},_is_404_route:function(url){return url.toString()==="404"},_is_plain_route:function(url){return url.toString().indexOf("/")===0},_is_scheduler_command:function(url){return url.lastIndexOf(this._scheduler)===0||url.lastIndexOf(this._once)===0||url.lastIndexOf(this._every)===0},_is_event_route:function(url){return !this._is_hash_route(url)&&!this._is_404_route(url)&&!this._is_plain_route(url)&&!this._is_scheduler_command(url)},_get_time_unit:function(url,unit){var num,result,t_unit;result=unit.match(/^(\d+)(ms|s|m)/);if(result){num=parseInt(result[1],10);t_unit=result[2]||"s";if(t_unit==="ms"){return num}else{if(t_unit==="s"){return num*1000}else{return num*60000}}}else{throw new Error("Bad time unit: "+unit+" in "+url+", available units: 'ms', 's', 'm'")}},_get_scheduler_params:function(url){var e,time_param,time_param1,xs;xs=url.split(" ");e="Define time unit for scheduler, for example: 'every 10s', given: "+url;if(xs.length===1){throw new Error(e)}else{if(xs.length===2){time_param=Sirius.Internal.RouteSystem._get_time_unit(url,xs[1]);return{delay:null,time:time_param}}else{if(xs.length===3){time_param=Sirius.Internal.RouteSystem._get_time_unit(url,xs[1]);time_param1=Sirius.Internal.RouteSystem._get_time_unit(url,xs[2]);return{delay:time_param,time:time_param1}}else{throw new Error(e)}}}},_scheduler_register:function(routes,wrapper,adapter,logger){var action,every,f,once,results,scheduler,url;every=this._every;scheduler=this._scheduler;once=this._once;f=this._get_scheduler_params;results=[];for(url in routes){action=routes[url];if(this._is_scheduler_command(url)){results.push((function(url,action){var handler,units;handler=Sirius.Utils.is_function(action)?wrapper(action):function(){return(new Sirius.Internal.ControlFlow(action,wrapper)).tick()};units=f(url);logger.debug("Define scheduler for '"+url+"' with "+(JSON.stringify(units)),logger.routing);if(url.lastIndexOf(every)===0||url.lastIndexOf(scheduler)===0){if(units.delay===null){return setInterval(handler,units.time)}else{return setTimeout(function(){return setInterval(handler,units.time)},units.delay)}}else{if(units.delay===null){return setTimeout(handler,units.time)}else{return setTimeout(function(){return setTimeout(handler,units.time)},units.delay)}}})(url,action))}}return results},_event_register:function(routes,wrapper,adapter,logger){var action,results,url;results=[];for(url in routes){action=routes[url];if(this._is_event_route(url)){results.push((function(url,action){var event_name,handler,selector,z;handler=Sirius.Utils.is_function(action)?wrapper(action):function(){var e,params;e=arguments[0],params=2<=arguments.length?slice.call(arguments,1):[];return(new Sirius.Internal.ControlFlow(action,wrapper)).handle_event(e,params)};z=url.match(/^([a-zA-Z:]+)(\s+)?(.*)?/);event_name=z[1];selector=z[3]||document;adapter.bind(document,selector,event_name,handler);return logger.debug("RouteSystem: define event route: '"+event_name+"' for '"+selector+"'",logger.routing)})(url,action))}}return results},_get_hash_routes:function(routes,wrapper,adapter,logger){var action,results,url;results=[];for(url in routes){action=routes[url];if(!(this._is_hash_route(url))){continue}logger.info("RouteSystem: define hash route: '"+url+"'",logger.routing);url=new Sirius.Internal.RoutePart(url);action=Sirius.Utils.is_function(action)?wrapper(action):new Sirius.Internal.ControlFlow(action,wrapper);results.push([url,action])}return results},_get_plain_routes:function(routes,wrapper,adapter,logger){var action,results,url;results=[];for(url in routes){action=routes[url];if(!(this._is_plain_route(url))){continue}logger.debug("RouteSystem: define route: '"+url+"'",logger.routing);url=new Sirius.Internal.RoutePart(url);action=Sirius.Utils.is_function(action)?wrapper(action):new Sirius.Internal.ControlFlow(action,wrapper);results.push([url,action])}return results},create:function(routes,setting,fn){var current,hash_on_top,logger,prev,push_state_support,redirect_to_hash;if(fn==null){fn=function(){}}logger=Sirius.Application.get_logger();current=prev=window.location.hash;hash_on_top=setting.top;redirect_to_hash=setting.old;push_state_support=setting.support;return Sirius.Application.get_adapter().and_then((function(_this){return function(adapter){var action,array_of_routes,dispatcher,plain_routes,route,url,urls,wrapper;if(redirect_to_hash&&!push_state_support){logger.info("RouteSystem: Convert plain routing into hash routing",logger.routing);urls=[];route={};for(url in routes){action=routes[url];if(_this._is_hash_route(url)){urls.push(url)}if(_this._is_plain_route(url)){url="#"+url;if(urls.indexOf(url)!==-1){logger.warn("RouteSystem: Routes already defined '"+url+"' url",logger.routing)}}route[url]=action}routes=route}wrapper=function(fn){var key,ref,value;ref=Sirius.Application.controller_wrapper;for(key in ref){value=ref[key];this[key]=value}return fn};_this._event_register(routes,wrapper,adapter,logger);_this._scheduler_register(routes,wrapper,adapter,logger);array_of_routes=_this._get_hash_routes(routes,wrapper,adapter,logger);plain_routes=_this._get_plain_routes(routes,wrapper,adapter,logger);dispatcher=function(e){var f,flow,href,len,n,origin,part,pathname,r,r404,result,route_array;prev=current;route_array=[];result=false;logger.info("RouteSystem: start processing route: '"+current+"'",logger.routing);if(e.type==="hashchange"){route_array=array_of_routes;current=window.location.hash;origin=window.location.origin;if(push_state_support){history.pushState({href:current},""+current,origin+"/"+current)}else{history.replaceState({href:current},""+current,origin+"/"+current)}}else{route_array=plain_routes;href=e.target.href;if(e.type!=="popstate"){if(push_state_support){history.pushState({href:href},""+href,href)}}pathname=window.location.pathname;if(pathname===""){pathname="/"}if(e.preventDefault){e.preventDefault()}else{e.returnValue=false}current=pathname}for(n=0,len=route_array.length;n<len;n++){part=route_array[n];f=part[0];r=f.match(current);if(r&&!result){result=true;flow=part[1];if(flow.handle_event){flow.handle_event(null,f.args)}else{flow.apply(null,f.args)}}}if(!result){logger.warn("RouteSystem: route '"+current+"' not found. Generate 404 event",logger.routing);adapter.fire(document,"application:404",current,prev);r404=routes["404"]||routes[404];if(r404){if(Sirius.Utils.is_function(r404)){wrapper(r404)(current)}else{(new Sirius.Internal.ControlFlow(r404,wrapper)).handle_event(null,current)}}return}logger.info("RouteSystem: Url change to: "+current,logger.routing);adapter.fire(document,"application:urlchange",current,prev)};_this.dispatch=dispatcher;if(plain_routes.length!==0){adapter.bind(document,_this._selector,"click",dispatcher)}window.onhashchange=dispatcher;if(push_state_support){adapter.bind(window,null,"popstate",function(e){if(history&&(history.state!=null)){if(history.state.href!==void 0){if(history.state.href.indexOf("#")!==0){return dispatcher(e)}}}})}if(array_of_routes.length!==0&&plain_routes.length!==0){logger.warn("RouteSystem: Seems you use plain routing and hashbased routing at the same time",logger.routing)}return fn()}})(this))}};Sirius.Application={log:false,adapter:null,running:false,route:{},start:false,controller_wrapper:{redirect:Sirius.redirect},mix_logger_into_controller:true,hash_always_on_top:true,use_hash_routing_for_old_browsers:true,default_log_function:function(level,msg){if(console&&console.log){return console.log(level+": "+msg)}else{return alert("Not supported `console`. You should define own `logger` function for Sirius.Application")}},log_filters:[],_wait:[],_messages_queue:[],get_logger:function(){var f,fn1,l,len,len1,lvls,n,o,q,ref,u;if(!this.logger){lvls=Sirius.Logger.Levels;o={};q=this._messages_queue;fn1=function(l){return o[l]=function(msg,location){return q.push([l,msg,location])}};for(n=0,len=lvls.length;n<len;n++){l=lvls[n];fn1(l)}ref=Sirius.Logger.Filters;for(u=0,len1=ref.length;u<len1;u++){f=ref[u];o[Sirius.Utils.underscore(f).toLowerCase()]=f}return o}else{return this.logger}},get_adapter:function(){var p;if(this.adapter==null){p=new Sirius.Promise();this._wait.push(p);return p}else{return new Sirius.Promise(this.adapter)}},run:function(options){var key,l,lf,max,min,ref,setting,user_filter,value,xs;if(options==null){options={}}this.running=true;this.log=options.log||this.log;this.adapter=options.adapter||(function(){throw new Error("Specify adapter")})();this.route=options.route||this.route;this.mix_logger_into_controller=options.mix_logger_into_controller||this.mix_logger_into_controller;this.log_filters=options.log_filters||this.log_filters;if(this.log_filters.length>0){lf=Sirius.Logger.Filters;user_filter=this.log_filters;if(typeof this.log_filters[0]==="number"){max=user_filter.sort()[user_filter.length-1];min=user_filter.sort()[0];if(min<0){throw new Error("Undefined index for log filters "+min)}if(max>lf.length){throw new Error("Undefined index for log filters "+max)}this.log_filters=user_filter.map(function(index){return lf[index]})}else{xs=this.log_filters.filter(function(x){return lf.indexOf(x)===-1});if(xs.length!==0){throw new Error("Check log filters given `"+user_filter+"`. Allow "+lf)}}}else{this.log_filters=[]}this.logger=new Sirius.Logger(this.log,this.log_filters,options.logger||this.default_log_function);this.start=options.start||this.start;ref=options.controller_wrapper||{};for(key in ref){value=ref[key];this.controller_wrapper[key]=value}this.hash_always_on_top=options.hash_always_on_top!=null?options.hash_always_on_top:this.hash_always_on_top;this.use_hash_routing_for_old_browsers=options.use_hash_routing_for_old_browsers!=null?options.use_hash_routing_for_old_browsers:this.use_hash_routing_for_old_browsers;this.logger.info("Logger enabled? "+this.log,this.logger.application);this.logger.info("Log filters: "+this.log_filters,this.logger.application);this.logger.info("Adapter: "+(Sirius.Utils.fn_name(this.adapter.constructor)),this.logger.application);this.logger.info("Hash always on top: "+this.hash_always_on_top,this.logger.application);this.logger.info("Use hash routing for old browsers: "+this.use_hash_routing_for_old_browsers,this.logger.application);this.logger.info("Current browser: "+navigator.userAgent,this.logger.application);this.push_state_support=history.pushState?true:false;this.logger.info("History pushState support: "+this.push_state_support,this.logger.application);if(!this.push_state_support&&this.use_hash_routing_for_old_browsers){this.logger.warn("You browser not support pushState, and you disable hash routing for old browser",this.logger.application)}this.logger.info("Mix logger in controllers "+this.mix_logger_into_controller,this.logger.application);if(this.mix_logger_into_controller){if(this.controller_wrapper.logger){this.logger.warn("Logger method already in `controller_wrapper`",this.logger.application)}l=this.logger;this.controller_wrapper.logger={info:l.info,debug:l.debug,warn:l.warn,error:l.error}}setting={old:this.use_hash_routing_for_old_browsers,top:this.hash_always_on_top,support:this.push_state_support};Sirius.Internal.RouteSystem.create(this.route,setting,(function(_this){return function(){var len,len1,message,n,p,ref1,ref2,results,u;ref1=_this._wait;for(n=0,len=ref1.length;n<len;n++){p=ref1[n];p.set_value(_this.adapter)}_this.adapter.fire(document,"application:run",new Date());ref2=_this._messages_queue;results=[];for(u=0,len1=ref2.length;u<len1;u++){message=ref2[u];results.push(_this.logger[message[0]].call(null,message[1],message[2]))}return results}})(this));if(this.start){return Sirius.redirect(this.start)}}};Sirius.Validator=(function(){function Validator(){this.logger=Sirius.Application.get_logger();this.msg=null}Validator.prototype.error_message=function(){return this.msg};return Validator})();Sirius.LengthValidator=(function(superClass){extend(LengthValidator,superClass);function LengthValidator(){return LengthValidator.__super__.constructor.apply(this,arguments)}LengthValidator.prototype.validate=function(value,attributes){var actual_length,length,max,min;this.logger.info("LengthValidator: start validate '"+value+"'",this.logger.validation);if(value!=null){max=attributes.max||Number.POSITIVE_INFINITY;min=attributes.min||Number.NEGATIVE_INFINITY;length=attributes.length;actual_length=value.length;if(length){if(actual_length===length){return true}else{this.msg="Required length: "+length+", given: "+actual_length;return false}}else{if((actual_length>=min)&&(actual_length<=max)){return true}else{this.msg="Required length in range [0.."+max+"], given: "+actual_length;return false}}}else{this.msg="Given null for LengthValidator";return false}};return LengthValidator})(Sirius.Validator);Sirius.ExclusionValidator=(function(superClass){extend(ExclusionValidator,superClass);function ExclusionValidator(){return ExclusionValidator.__super__.constructor.apply(this,arguments)}ExclusionValidator.prototype.validate=function(value,attributes){var range;this.logger.info("ExclusionValidator: start validate '"+value+"'",this.logger.validation);range=attributes.within||[];if(range.indexOf(value)===-1){return true}else{this.msg="Value "+value+" reserved";return false}};return ExclusionValidator})(Sirius.Validator);Sirius.InclusionValidator=(function(superClass){extend(InclusionValidator,superClass);function InclusionValidator(){return InclusionValidator.__super__.constructor.apply(this,arguments)}InclusionValidator.prototype.validate=function(value,attributes){var range;this.logger.info("InclusionValidator: start validate '"+value+"'",this.logger.validation);range=attributes.within||[];if(range.indexOf(value)>-1){return true}else{this.msg="Value "+value+" should be in range "+range;return false}};return InclusionValidator})(Sirius.Validator);Sirius.FormatValidator=(function(superClass){extend(FormatValidator,superClass);function FormatValidator(){return FormatValidator.__super__.constructor.apply(this,arguments)}FormatValidator.prototype.validate=function(value,attributes){var format;this.logger.info("FormatValidator: start validate '"+value+"'",this.logger.validation);format=attributes["with"]||(function(){throw new Error("format attribute required")})();if(value!=null){if(format.test(value)){return true}else{this.msg="Value "+value+" not for current format";return false}}else{this.msg="Given null for Format";return false}};return FormatValidator})(Sirius.Validator);Sirius.NumericalityValidator=(function(superClass){extend(NumericalityValidator,superClass);function NumericalityValidator(){return NumericalityValidator.__super__.constructor.apply(this,arguments)}NumericalityValidator.prototype.validate=function(value,attributes){if(attributes==null){attributes={}}this.logger.info("NumericalityValidator: start validate '"+value+"'",this.logger.validation);if(attributes.only_integers){if(/^\d+$/.test(value)){return true}else{this.msg="Only allows integer numbers";return false}}else{if(/^\d+(?:\.\d{1,})?$/.test(value)){return true}else{this.msg="Only allows numbers";return false}}};return NumericalityValidator})(Sirius.Validator);Sirius.PresenceValidator=(function(superClass){extend(PresenceValidator,superClass);function PresenceValidator(){return PresenceValidator.__super__.constructor.apply(this,arguments)}PresenceValidator.prototype.validate=function(value,attributes){if(attributes==null){attributes=true}this.logger.info("PresenceValidator: start validate '"+value+"'",this.logger.validation);if(value){return true}else{this.msg="Value required";return false}};return PresenceValidator})(Sirius.Validator);Sirius.Internal.CacheHandlerProperty=(function(){function CacheHandlerProperty(from_element1,watch_for1,event1,handler1,observer1,config1){this.from_element=from_element1;this.watch_for=watch_for1;this.event=event1;this.handler=handler1;this.observer=observer1;this.config=config1}CacheHandlerProperty.prototype.is_observer=function(){return this.observer!==null};CacheHandlerProperty.prototype.is_listener=function(){return !this.is_observer};return CacheHandlerProperty})();Sirius.Internal.CacheObserverHandlers={_handlers:[],add_new_observer:function(from_element,watch_for,handler,observer,config){var p;p=new Sirius.Internal.CacheHandlerProperty(from_element,watch_for,null,handler,observer,config);return this._handlers.push(p)},add_new_bind_event:function(from_element,watch_for,event,handler){var p;p=new Sirius.Internal.CacheHandlerProperty(from_element,watch_for,event,handler,null);return this._handlers.push(p)},find_by_element:function(e){return this._handlers.filter(function(h){return h.from_element===e})},find_by_element_and_watch_for:function(e,w){return this._handlers.filter(function(h){return h.from_element===e&&h.watch_for===w})},find_by_element_watch_for_and_event:function(e,w,ev){return this._handlers.filter(function(h){return h.from_element===e&&h.watch_for===w&&h.event===ev})}};Sirius.Internal.Observer=(function(){var BOOL_TYPES,MO,ONCHANGE_TAGS,OPTION;MO=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver||null;ONCHANGE_TAGS=["INPUT","TEXTAREA","SELECT"];BOOL_TYPES=["checkbox","radio"];OPTION="OPTION";Observer.Ev={input:"input",selectionchange:"selectionchange",childList:"childList",change:"change",DOMNodeInserted:"DOMNodeInserted",focusout:"focusout",focusin:"focusin",DOMAttrModified:"DOMAttrModified"};Observer.TextEvents=[Observer.Ev.input,Observer.Ev.childList,Observer.Ev.change,Observer.Ev.DOMNodeInserted,Observer.Ev.selectionchange];Observer.is_text_event=function(e){return this.TextEvents.indexOf(e.type)!==-1};Observer.is_focus_event=function(e){return[this.Ev.focusin,this.Ev.focusout].indexOf(e.type)!==-1};function Observer(from_element1,original1,watch_for1,clb1){var adapter;this.from_element=from_element1;this.original=original1;this.watch_for=watch_for1;this.clb=clb1!=null?clb1:function(){};this._create=bind(this._create,this);adapter=Sirius.Application.get_adapter();adapter.and_then(this._create)}Observer.prototype._create=function(adapter){var O,clb,cnf,current_value,element,from,handler,logger,observer,original,tag,type,watch_for;logger=Sirius.Application.get_logger();clb=this.clb;from=this.from_element;original=this.original;current_value=null;watch_for=this.watch_for;tag=adapter.get_attr(from,"tagName");type=adapter.get_attr(from,"type");logger.debug("Create binding for "+from,logger.binding);O=Sirius.Internal.Observer;handler=function(e){var attr_name,new_attr,old_attr,result,txt;logger.debug("Handler Function: given "+e.type+" event",logger.binding);result={text:null,attribute:null,from:from,original:original};if(O.is_focus_event(e)){return}txt=adapter.text(from);if([O.Ev.input,O.Ev.selectionchange].indexOf(e.type)!==-1&&txt===current_value){return}if(O.is_text_event(e)){result.text=txt;current_value=txt}if(e.type===O.Ev.change){result.state=adapter.get_state(from)}if(e.type==="attributes"){attr_name=e.attributeName;old_attr=e.oldValue||[];new_attr=adapter.get_attr(from,attr_name);result.text=new_attr;result.attribute=attr_name;result.previous=old_attr}if(e.type===O.Ev.DOMAttrModified){attr_name=e.originalEvent.attrName;old_attr=e.originalEvent.prevValue;new_attr=adapter.get_attr(from,attr_name);result.text=new_attr;result.attribute=attr_name;result.previous=old_attr}return clb(result)};if(watch_for==="text"){if(ONCHANGE_TAGS.indexOf(tag)!==-1){logger.debug("It is not a "+ONCHANGE_TAGS,logger.binding);if(BOOL_TYPES.indexOf(type)!==-1||tag===OPTION){logger.debug("Get a "+type+" & "+tag+" element for bool elements",logger.binding);adapter.bind(document,from,O.Ev.change,handler);return Sirius.Internal.CacheObserverHandlers.add_new_bind_event(from,watch_for,O.Ev.change,handler)}else{current_value=adapter.text(from);adapter.bind(document,from,O.Ev.input,handler);Sirius.Internal.CacheObserverHandlers.add_new_bind_event(from,watch_for,O.Ev.input,handler);if(Sirius.Utils.is_ie9()){logger.warn("Hook for work with IE9 browser",logger.binding);adapter.bind(document,from,O.Ev.selectionchange,handler);return Sirius.Internal.CacheObserverHandlers.add_new_bind_event(from,watch_for,O.Ev.selectionchange,handler)}}}else{return logger.warn("Seems you try to bind for "+tag+" of "+type+" for 'text' which is not supported")}}else{if(MO){logger.debug("MutationObserver support",logger.binding);observer=new MO(function(mutations){return mutations.forEach(handler)});cnf={childList:true,attributes:true,characterData:true,attributeOldValue:true,characterDataOldValue:true,subtree:false};element=adapter.get(from);observer.observe(element,cnf);return Sirius.Internal.CacheObserverHandlers.add_new_observer(from,watch_for,handler,observer,cnf)}else{logger.warn("MutationObserver not supported",logger.binding);logger.warn("Use Deprecated events for observe",logger.binding);adapter.bind(document,from,O.Ev.DOMNodeInserted,handler);adapter.bind(document,from,O.Ev.DOMAttrModified,handler);Sirius.Internal.CacheObserverHandlers.add_new_bind_event(from,watch_for,O.Ev.DOMNodeInserted,handler);return Sirius.Internal.CacheObserverHandlers.add_new_bind_event(from,watch_for,O.Ev.DOMAttrModified,handler)}}};return Observer})();Sirius.View=(function(){var EventHandlerParams;View.prototype.name=function(){return"View"};View._Strategies=[];View._Cache=[];EventHandlerParams=(function(){function EventHandlerParams(selector1,event_name1,custom_event_name1){this.selector=selector1;this.event_name=event_name1;this.custom_event_name=custom_event_name1}EventHandlerParams.prototype.eq=function(another){return this.selector===another.selector&&this.event_name===another.event_name&&this.custom_event_name.toString===another.custom_event_name.toString};return EventHandlerParams})();function View(element1,clb1){var clb,element,fn1,len,n,ref,strategy,view;this.element=element1;this.clb=clb1!=null?clb1:function(txt){return txt};element=this.element;clb=this.clb;view=Sirius.View._Cache.filter(function(v){return v.element===element&&(""+v.clb)===(""+clb)});if(view.length!==0){return view[0]}this._listeners=[];this._cache_event_handlers=[];this.logger=Sirius.Application.get_logger();this._result_fn=function(){var args;args=1<=arguments.length?slice.call(arguments,0):[];return clb.apply.apply(clb,[null].concat(slice.call(args)))};this.logger.debug("Create a new View for "+this.element,this.logger.view);ref=this.constructor._Strategies;fn1=(function(_this){return function(strategy){var name,render,transform;name=strategy[0];_this.logger.debug("Define "+name+" strategy",_this.logger.view);transform=strategy[1];render=strategy[2];return _this[name]=function(attribute){var result;if(attribute==null){attribute="text"}result=_this._result;element=_this.element;_this.logger.debug("Start processing strategy for "+element,_this.logger.view);return Sirius.Application.get_adapter().and_then(function(adapter){var oldvalue,res;oldvalue=attribute==="text"?adapter.text(element):adapter.get_attr(element,attribute);res=transform(oldvalue,result);return render(adapter,element,res,attribute)})}}})(this);for(n=0,len=ref.length;n<len;n++){strategy=ref[n];fn1(strategy)}Sirius.View._Cache.push(this);this}View.prototype.get_element=function(){return this.element};View.prototype._register_state_listener=function(clb){this.logger.debug("Register new listener for element: "+this.get_element,this.logger.view);return this._listeners.push(clb)};View.prototype.render=function(){var args;args=1<=arguments.length?slice.call(arguments,0):[];this.logger.debug("Call render for "+args,this.logger.view);this._result=this._result_fn(args);return this};View.prototype.zoom=function(selector){var v;v=selector===this.element?this:new Sirius.View(this.element+" "+selector);v._result=this._result;return v};View.prototype.on=function(){var current,custom_event_name,event_name,f,handler,idx,is_present,params,selector,tmp,type;selector=arguments[0],event_name=arguments[1],custom_event_name=arguments[2],params=4<=arguments.length?slice.call(arguments,3):[];selector=selector===this.element?selector:this.element+" "+selector;type=(function(){if(Sirius.Utils.is_string(custom_event_name)){return 0}else{if(Sirius.Utils.is_function(custom_event_name)){return 1}else{throw new Error("View: 'custom_event_name' must be string or function, "+(typeof custom_event_name)+" given")}}})();current=new EventHandlerParams(selector,event_name,custom_event_name);is_present=this._cache_event_handlers.filter(function(x){return x.eq(current)});if(is_present.length===0){this.logger.info("Bind event for "+selector+", event name: "+event_name+", will be called : "+custom_event_name,this.logger.view);if(type===0){handler=function(e){return Sirius.Application.get_adapter().and_then(function(adapter){var ref;return(ref=adapter.fire).call.apply(ref,[null,document,custom_event_name,e].concat(slice.call(params)))})};Sirius.Application.get_adapter().and_then(function(adapter){return adapter.bind(document,selector,event_name,handler)});tmp=new EventHandlerParams(selector,event_name,handler);this._cache_event_handlers.push(tmp)}else{Sirius.Application.get_adapter().and_then(function(adapter){return adapter.bind(document,selector,event_name,custom_event_name)});this._cache_event_handlers.push(current)}}else{f=is_present.shift();idx=this._cache_event_handlers.indexOf(f);if(idx>-1){this._cache_event_handlers.splice(idx,1)}this._cache_event_handlers.push(current);Sirius.Application.get_adapter().and_then(function(adapter){adapter.off(document,selector,event_name,f.custom_event_name);f=null;return adapter.bind(document,selector,event_name,custom_event_name)})}};View.is_valid_strategy=function(s){return this._Strategies.filter(function(arr){return arr[0]===s}).length!==0};View.prototype.bind=function(output,via){return this.pipe(output,via)};View.prototype.pipe=function(output,via){var t;t=new Sirius.Transformer(this,output);t.run(via)};View.register_strategy=function(name,object){var logger,msg,render,transform;if(object==null){object={}}logger=Sirius.Application.get_logger();logger.info("View: Register new Strategy "+name,logger.view);transform=object.transform;render=object.render;if(!Sirius.Utils.is_function(transform)){msg="Strategy must be Function, but "+(typeof transform)+" given.";logger.error("View: "+msg,logger.view);throw new Error(msg)}if(!Sirius.Utils.is_function(render)){msg="Strategy must be Function, but "+(typeof render)+" given.";logger.error("View: "+msg,logger.view);throw new Error(msg)}if(!Sirius.Utils.is_string(name)){msg="Strategy name must be String, but "+(typeof name)+" given.";logger.error("View: "+msg,logger.view);throw new Error(msg)}this._Strategies.push([name,transform,render]);return null};return View})();Sirius.View.register_strategy("swap",{transform:function(oldvalue,newvalue){return""+newvalue},render:function(adapter,element,result,attribute){var r;if(attribute==="text"){return adapter.swap(element,result)}else{if(attribute==="checked"){r=Sirius.Utils.is_string(result)?result==="true"?true:false:!!result;return adapter.set_prop(element,"checked",r)}else{return adapter.set_attr(element,attribute,result)}}}});Sirius.View.register_strategy("append",{transform:function(oldvalue,newvalue){return newvalue},render:function(adapter,element,result,attribute){var tag;tag=adapter.get_attr(element,"tagName");if(tag==="INPUT"||tag==="TEXTAREA"||tag==="SELECT"){throw new Error("'append' strategy not work for `input` or `textarea` or `select` elements")}if(attribute==="text"){return adapter.append(element,result)}else{throw new Error("Strategy 'append' only work for 'text' content, not for '"+attribute+"'")}}});Sirius.View.register_strategy("prepend",{transform:function(oldvalue,newvalue){return newvalue},render:function(adapter,element,result,attribute){var tag;tag=adapter.get_attr(element,"tagName");if(tag==="INPUT"||tag==="TEXTAREA"||tag==="SELECT"){throw new Error("'prepend' strategy not work for `input` or `textarea` or `select` elements")}if(attribute==="text"){return adapter.prepend(element,result)}else{throw new Error("Strategy 'prepend' only work for 'text' content, not for '"+attribute+"'")}}});Sirius.View.register_strategy("clear",{transform:function(oldvalue,newvalue){return""},render:function(adapter,element,result,attribute){return adapter.clear(element)}});ComputedField=(function(){function ComputedField(main,fields1,fn1){this.main=main;this.fields=fields1;this.fn=fn1!=null?fn1:null;this._count=this.fields.length;this._values=[]}ComputedField.prototype.get_fields=function(){return this.fields};ComputedField.prototype.complete=function(field,value){var o,v;o={};o[field]=value;v=this._values.map(function(f){return Object.keys(f)[0]});if(v.indexOf(field)===-1){this._values.push(o);if(this.is_full()){return this._result()}else{return null}}else{return null}};ComputedField.prototype.field_name=function(){return this.main};ComputedField.prototype.remove=function(field){return delete this._values[field]};ComputedField.prototype._result=function(){var args,v;v=this._values;args=this.fields.map(function(f){return(v.filter(function(vv){return vv[f]}))[0][f]});if(this.fn===null){return args.join(" ")}else{return this.fn.apply(null,args)}};ComputedField.prototype.is_full=function(){return this._values.length===this._count};return ComputedField})();Sirius.BaseModel=(function(){BaseModel._Validators=[];BaseModel.attrs=[];BaseModel.skip=false;BaseModel.guid_for=null;BaseModel.validate={};BaseModel.prototype._listeners=[];BaseModel.comp=function(){var _tmp,args,base,base1,base2,deps,field,fn,full,length,r,ref,uniq,xs;args=1<=arguments.length?slice.call(arguments,0):[];(base=this.prototype)._cmp||(base._cmp=[]);(base1=this.prototype)._cmp_fields||(base1._cmp_fields=[]);(base2=this.prototype)._cmp_refs||(base2._cmp_refs={});if(args.length===0){throw new Exception("Compute field is empty")}if(args.length===2){throw new Exception("For computed fields need more fields")}field=args[0];length=args.length;ref=Sirius.Utils.is_function(args[length-1])?(fn=args[length-1],[args.slice(1,length-1),args.slice(1,length-1),fn]):[args.slice(1),args.slice(1),null],deps=ref[0],xs=ref[1],fn=ref[2];full=[field].concat(deps);uniq=full.filter(function(e,i,a){return a.indexOf(e)===i});if(uniq.length!==full.length){throw new Error("Seems your calculated fields are not unique: ["+full+"]")}_tmp=this.attrs.concat(this.prototype._cmp_fields);deps.forEach(function(f){if(_tmp.indexOf(f)===-1){throw new Error("Field is '"+f+"' not found, for '"+field+"'")}});if(this.prototype._cmp_fields.length>0){r=deps.filter((function(_this){return function(f){return _this.prototype._cmp_refs[f]&&_this.prototype._cmp_refs[f].indexOf(field)!==-1}})(this));if(r.length>0){throw new Error("Cyclic references detected in '"+field+"' field")}}Sirius.Application.get_logger().info("Define compute field '"+field+"' <- '["+deps+"]'",Sirius.Application.get_logger().base_model);this.prototype._cmp_refs[field]=deps;this.prototype._cmp_fields.push(field);return this.prototype._cmp.push(new ComputedField(field,xs,fn))};BaseModel.prototype.attrs=function(){return(this.constructor.attrs||[]).concat(this.constructor.prototype._cmp_fields)};BaseModel.prototype.__name="BaseModel";BaseModel.prototype.normal_name=function(){return Sirius.Utils.underscore(this.constructor.name)};BaseModel.prototype.validators=function(){return this.constructor.validate};BaseModel.prototype.guid_for=function(){return this.constructor.guid_for};BaseModel.prototype._compute=function(field,value){var self;self=this;return this.constructor.prototype._cmp.forEach(function(cf){var r;if(cf.get_fields().indexOf(field)!==-1){r=cf.complete(field,value);if(cf.is_full()){return self._set(cf.field_name(),r)}}})};BaseModel.prototype.normalize_attrs=function(){var a,len,n,ref,results;ref=this.attrs();results=[];for(n=0,len=ref.length;n<len;n++){a=ref[n];results.push((function(a){if(Sirius.Utils.is_object(a)){return Object.keys(a)[0]}else{return a}})(a))}return results};function BaseModel(obj){var attr,attributes,attrs0,base,base1,g,key,len,len1,msg,n,name,oldvalue,ref,ref1,ref2,skip,u,validator,validator_name,value;if(obj==null){obj={}}(base=this.constructor.prototype)._cmp||(base._cmp=[]);(base1=this.constructor.prototype)._cmp_fields||(base1._cmp_fields=[]);this.logger=Sirius.Application.get_logger();this.errors={};this.attributes=this.normalize_attrs();name=Sirius.Utils.fn_name(this.constructor);this.errors={};this._is_valid_attr={};attrs0=this.attrs();for(n=0,len=attrs0.length;n<len;n++){attr=attrs0[n];this.logger.info("define '"+(JSON.stringify(attr))+"' attribute for '"+name+"'",this.logger.base_model);if(Sirius.Utils.is_object(attr)){ref=Object.keys(attr),key=ref[0];if(!key){msg="Attributes should have a key and value";this.logger.error(""+msg,this.logger.base_model);throw new Error(msg)}this["_"+key]=attr[key];this._gen_method_name_for_attribute(key)}else{this._gen_method_name_for_attribute(attr);this["_"+attr]=null}}skip=this.constructor.skip;attributes=this.attributes;if(Object.keys(obj).length!==0){ref1=Object.keys(obj);for(u=0,len1=ref1.length;u<len1;u++){attr=ref1[u];if(!(attributes.indexOf(attr)===-1&&skip)){this._attribute_present(attr);oldvalue=this["_"+attr];this["_"+attr]=obj[attr];this._call_callbacks(attr,obj[attr],oldvalue)}}}if(g=this.guid_for()){this.set(g,this._generate_guid())}this._registered_validators=this.constructor._Validators;this._registered_validators_keys=this._registered_validators.map(function(arr){return arr[0]});this._model_validators=this.validators();ref2=this._model_validators;for(key in ref2){value=ref2[key];this.errors[key]={};this._is_valid_attr[key]=false;for(validator_name in value){validator=value[validator_name];if(this._registered_validators_keys.indexOf(validator_name)===-1&&validator_name!=="validate_with"){throw new Error("Unregistered validator: "+validator_name)}this.errors[key][validator_name]=""}}this.after_create()}BaseModel.prototype._gen_method_name_for_attribute=function(attribute){var normalize_name;normalize_name=Sirius.Utils.underscore(attribute);if(Object.keys(this).indexOf(normalize_name)!==-1){throw new Error("Method "+normalize_name+" already exist")}return this[normalize_name]=(function(_this){return function(value){if(value!=null){return _this.set(attribute,value)}else{return _this.get(attribute)}}})(this)};BaseModel.prototype._generate_guid=function(){var s4;s4=function(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)};return""+(s4())+(s4())+"-"+(s4())+"-"+(s4())+"-"+(s4())+"-"+(s4())+(s4())+(s4())};BaseModel.prototype.get_attributes=function(){return this.attributes};BaseModel.prototype._is_computed_attribute=function(attr){if(this.constructor.prototype._cmp_fields.indexOf(attr)!==-1){return true}else{return false}};BaseModel.prototype._attribute_present=function(attr){if(this.attributes.indexOf(attr)===-1){throw new Error("Attribute '"+attr+"' not found for "+(this.normal_name().toUpperCase())+" model")}};BaseModel.prototype._call_callbacks=function(attr,value,oldvalue){var clb,len,n,ref;ref=this._listeners;for(n=0,len=ref.length;n<len;n++){clb=ref[n];clb.apply(null,[attr,value])}return this.after_update(attr,value,oldvalue)};BaseModel.prototype.set=function(attr,value){if(this._is_computed_attribute(attr)){throw new Error("Impossible set computed attribute "+attr+" for "+(this.normal_name().toUpperCase()))}return this._set(attr,value)};BaseModel.prototype._set=function(attr,value){var k,oldvalue,v;this._attribute_present(attr);oldvalue=this["_"+attr];if(Sirius.Utils.is_object(oldvalue)){if(!Sirius.Utils.is_object(value)){throw new Error("Attribute '"+attr+"' is object, but value '"+value+"' not object.")}for(k in value){v=value[k];oldvalue[k]=v}}else{this["_"+attr]=value}this.validate(attr);this._compute(attr,value);return this._call_callbacks(attr,value,oldvalue)};BaseModel.prototype.get=function(attr){this._attribute_present(attr);return this["_"+attr]};BaseModel.prototype.reset=function(){var args,attr,attrs,key,len,n;args=1<=arguments.length?slice.call(arguments,0):[];attrs=this.attributes;for(n=0,len=args.length;n<len;n++){attr=args[n];if(attrs.indexOf(attr)===-1){throw new Error("Attribute '"+attr+"' not found for "+(this.normal_name().toUpperCase())+" model")}key="_"+attr;if(typeof this[key]==="number"){this[key]=0}if(Sirius.Utils.is_string(this[key])){this[key]=""}if(Sirius.Utils.is_array(this[key])){this[key]=[]}if(this.errors[key]!=null){this.errors[key]={}}}};BaseModel.prototype.is_valid=function(){return Object.keys(this._is_valid_attr).filter((function(_this){return function(key){return !_this._is_valid_attr[key]}})(this)).length===0};BaseModel.prototype.validate=function(field){if(field==null){field=null}Object.keys(this._model_validators||{}).filter(function(key){if(field!=null){return key===field}else{return true}}).map((function(_this){return function(key){var current_value,klass,result,results,validator_key,validator_value,value,z;current_value=_this.get(key);value=_this._model_validators[key];results=[];for(validator_key in value){validator_value=value[validator_key];klass=validator_key==="validate_with"?(z=new Sirius.Validator(),z.validate=validator_value,z.msg=null,z):(z=_this._registered_validators.filter(function(arr){return arr[0]===validator_key})[0][1],new z());result=klass.validate(current_value,validator_value);if(!result){_this.errors[key][validator_key]=klass.error_message();results.push(_this._is_valid_attr[key]=false)}else{_this.errors[key][validator_key]="";results.push(_this._is_valid_attr[key]=true)}}return results}})(this))};BaseModel.prototype.get_errors=function(attr){var key,ref,result,value;if(attr==null){attr=null}if(this.attributes.indexOf(attr)===-1&&attr!==null){throw new Error("Attribute '"+attr+"' not found for "+(this.normal_name().toUpperCase())+" model")}if(attr!=null){result=[];ref=this.errors[attr];for(key in ref){value=ref[key];if(value!==""){result.push(value)}}return result}else{return this.errors}};BaseModel.prototype.set_error=function(error,txt){var keys;keys=error.split(".");if(keys.length!==2){throw new Error("Error must be pass as 'attr.validator' like 'name.length'")}this.errors[keys[0]][keys[1]]=txt;return this._is_valid_attr[keys[0]]=false};BaseModel.prototype.save=function(exception){var name;if(exception==null){exception=false}this.validate();name=this.constructor.name;if(exception&&!this.is_valid()){throw new Error(name+" model not valid!")}if(this.is_valid()){return false}return true};BaseModel.prototype.to_json=function(){var args,attr,len,n,ref,value,z;args=1<=arguments.length?slice.call(arguments,0):[];z={};ref=this.attributes;for(n=0,len=ref.length;n<len;n++){attr=ref[n];if(!(args.indexOf(attr)===-1)){continue}value=this.get(""+attr);z[""+attr]=value}return JSON.stringify(z)};BaseModel.from_json=function(json,models){var attr,attrs,key,len,m,n,ref,value;if(models==null){models={}}m=new this;json=JSON.parse(json);attrs=[].concat(m.attrs());for(n=0,len=attrs.length;n<len;n++){attr=attrs[n];if(typeof attr==="object"){ref=Object.keys(attr),key=ref[0];m.set(key,json[key]||attr[key])}else{value=json[attr];m.set(attr,value||m.get(attr))}}return m};BaseModel.prototype.compare=function(other){throw new Error("`compare` method must be overridden")};BaseModel.prototype.after_create=function(){};BaseModel.prototype.after_update=function(attribute,newvalue,oldvalue){};BaseModel.prototype.clone=function(){return this.constructor.from_json(this.to_json())};BaseModel.prototype._register_state_listener=function(transformer){this.logger.debug("Register new listener for "+this.constructor.name,this.logger.base_model);return this._listeners.push(transformer)};BaseModel.prototype._clear_state_listener=function(transformer){};BaseModel.prototype.pipe=function(func,via){var t;if(via==null){via={}}t=new Sirius.Transformer(this,func);t.run(via)};BaseModel.prototype.bind=function(func,via){if(via==null){via={}}return this.pipe(func,via)};BaseModel.define_model=function(setting){var Tmp,k,predefined_attributes,v;predefined_attributes=["attrs","guid_for","validate"];Tmp=(function(superClass){extend(Tmp,superClass);function Tmp(){return Tmp.__super__.constructor.apply(this,arguments)}Tmp.attrs=setting.attrs||[];Tmp.guid_for=setting.guid_for||null;Tmp.validate=setting.validate||{};return Tmp})(Sirius.BaseModel);for(k in setting){v=setting[k];if(predefined_attributes.indexOf(k)===-1){Tmp.prototype[k]=v}}return Tmp};BaseModel.register_validator=function(name,klass){var logger;logger=Sirius.Application.get_logger();logger.info("register validator: "+name,logger.base_model);this._Validators.push([name,klass]);return null};return BaseModel})();Sirius.BaseModel.register_validator("length",Sirius.LengthValidator);Sirius.BaseModel.register_validator("exclusion",Sirius.ExclusionValidator);Sirius.BaseModel.register_validator("inclusion",Sirius.InclusionValidator);Sirius.BaseModel.register_validator("format",Sirius.FormatValidator);Sirius.BaseModel.register_validator("numericality",Sirius.NumericalityValidator);Sirius.BaseModel.register_validator("presence",Sirius.PresenceValidator);Sirius.Internal.AbstractTransformer=(function(){function AbstractTransformer(_path,_from,_to){this._path=_path;this._from=_from;this._to=_to;this.logger=Sirius.Application.get_logger();this._ln=this.logger.transformer;this._register()}AbstractTransformer.prototype._register=function(){};return AbstractTransformer})();Sirius.Internal.ToFunctionTransformer=(function(superClass){extend(ToFunctionTransformer,superClass);function ToFunctionTransformer(){return ToFunctionTransformer.__super__.constructor.apply(this,arguments)}ToFunctionTransformer.prototype._register=function(){var clb,k,ref,results,top,v,w;if(this._from instanceof Sirius.BaseModel){return this._from._register_state_listener(this._to)}else{this._from._register_state_listener(this);clb=this._fire_generator();top=this._from.get_element();ref=this._path;results=[];for(k in ref){v=ref[k];w=this._path.from||"text";results.push(new Sirius.Internal.Observer(top+" "+k,k,w,clb))}return results}};ToFunctionTransformer.prototype._fire_generator=function(){var callback,f,logger,view;view=this._from;logger=this.logger;f=this._to;callback=function(result){return f(result,view,logger)};return callback};return ToFunctionTransformer})(Sirius.Internal.AbstractTransformer);Sirius.Internal.ToViewTransformer=(function(superClass){extend(ToViewTransformer,superClass);function ToViewTransformer(){return ToViewTransformer.__super__.constructor.apply(this,arguments)}ToViewTransformer.prototype._register=function(){var clb;clb=this._fire_generator();return this._from._register_state_listener(clb)};ToViewTransformer._default_via_method=function(){return function(value,selector,view,attribute){if(attribute==null){attribute="text"}return view.zoom(selector).render(value).swap(attribute)}};ToViewTransformer.prototype._fire_generator=function(){var callback,ln,logger,model,path,view;view=this._to;path=this._path;logger=this.logger;ln=this._ln;if(this._from instanceof Sirius.View){callback=function(attribute,value){var attr,len,n,o,results,selector,to,via;to=path.to;results=[];for(n=0,len=to.length;n<len;n++){o=to[n];if(Sirius.Utils.is_string(o)){via=Sirius.Internal.ToViewTransformer._default_via_method();results.push(via(value,o,view,attribute))}else{selector=o.selector;attr=o.attribute||"text";via=o.via||Sirius.Internal.ToViewTransformer._default_via_method();results.push(via(value,selector,view,attr))}}return results};return callback}else{model=this._from;callback=function(attribute,value){var attr,obj,to,via;obj=path[attribute];if(obj){logger.debug("Apply new value for '"+attribute+"' for '"+(view.get_element())+"', value: "+value+" from "+(model.normal_name()),ln);to=obj.to;attr=obj.attr||"text";via=obj.via||Sirius.Internal.ToViewTransformer._default_via_method();return via(value,to,view,attr)}};return callback}};return ToViewTransformer})(Sirius.Internal.AbstractTransformer);Sirius.Internal.ToModelTransformer=(function(superClass){extend(ToModelTransformer,superClass);function ToModelTransformer(){return ToModelTransformer.__super__.constructor.apply(this,arguments)}ToModelTransformer.prototype._register=function(){var clb,k,ref,results,top,v,w;this._from._register_state_listener(this);clb=this._fire_generator();top=this._from.get_element();ref=this._path;results=[];for(k in ref){v=ref[k];w=this._path.from||"text";results.push(new Sirius.Internal.Observer(top+" "+k,k,w,clb))}return results};ToModelTransformer.prototype._default_via_method=function(){return function(value){return value}};ToModelTransformer.prototype._fire_generator=function(){var callback,ln,logger,model,path,view;view=this._from;path=this._path;model=this._to;logger=this.logger;ln=this._ln;callback=function(result){var from,to,value,via;value=path[result.original];if(value){to=value.to;from=value.from||"text";via=value.via||(function(value){return value});logger.debug("Apply new value from "+result.from+" ("+result.original+") to "+(model.normal_name())+"."+to,ln);return model.set(to,via(result.text))}};return callback};return ToModelTransformer})(Sirius.Internal.AbstractTransformer);Sirius.Transformer=(function(){Transformer._Model=0;Transformer._View=1;Transformer._Function=2;Transformer.prototype._from=null;Transformer.prototype._to=null;Transformer.prototype._path=null;function Transformer(from,to){this.logger=Sirius.Application.get_logger();this.ln=this.logger.transformer;if(from instanceof Sirius.BaseModel){this._from=from}else{if(from instanceof Sirius.View){this._from=from}else{throw new Error("Bad argument for Transformer, Model or View required, given "+from)}}if(to instanceof Sirius.BaseModel){if(!(this._from instanceof Sirius.BaseModel)){this._to=to}else{throw new Error("Impossible bind model and model")}}else{if(to instanceof Sirius.View){this._to=to}else{if(Sirius.Utils.is_function(to)){this._to=to}else{throw new Error("Bind works only with BaseModel, BaseView or Function, given: "+to)}}}}Transformer.prototype.run=function(object){var _d,_e,_e1,_e2,attr,attrs,error,k,len,n,name,o,t,to,v;if(this._from&&this._to){if(this._from instanceof Sirius.BaseModel){for(k in object){v=object[k];if(this._from.get_attributes().indexOf(k)===-1){name=this._from.normal_name();attrs=this._from.get_attributes();this.logger.warn("Attribute '"+k+"' not found in model attributes: '"+name+"', available: ["+attrs+"]",this.ln)}}}if(this._to instanceof Sirius.BaseModel){name=this._to.normal_name();for(k in object){v=object[k];attr=v.to;if(!attr){o=JSON.stringify(object);throw new Error("Impossible create transformer for "+name+", because in object: "+o+", 'to' key not defined")}else{attrs=this._to.get_attributes();if(attrs.indexOf(attr)===-1){this.logger.warn("Attribute '"+attr+"' not found in model attributes: '"+name+"', available: ["+attrs+"]",this.ln)}}}}if(this._from instanceof Sirius.View&&this._to instanceof Sirius.View){to=object.to;if(!to){error='{"to": "selector"}';throw new Error("Define View to View binding with: 'view1.bind(view2, "+error+")', but 'to' key not found")}else{if(Sirius.Utils.is_array(to)){for(n=0,len=to.length;n<len;n++){t=to[n];if(!t.selector){_d='{to: [{"selector": "#my-id", "attribute": "data-attr"}]}';_e1="You define binding with 'to' as array of objects, but 'selector', but 'selector' property was not found.";_e2="Correct definition: "+_d;throw new Error(_e1+" "+_e2)}}this._path=object}else{if(Sirius.Utils.is_string(to)){object.to=[to];this._path=object}else{throw new Error("For binding 'to' must be array or string, but "+(typeof to)+" given")}}}}else{if(this._from instanceof Sirius.View&&Sirius.Utils.is_function(this._to)){if(Object.keys(object).length===0){throw new Error("Binding with empty object forbidden")}for(k in object){v=object[k];if(!v.from){_e='{"selector": {"from": "text"}}';throw new Error("For binding View and Function, you need to define object like: "+_e)}}this._path=object}else{this._path=object}}if(this._to instanceof Sirius.BaseModel){return new Sirius.Internal.ToModelTransformer(object,this._from,this._to)}else{if(this._to instanceof Sirius.View){return new Sirius.Internal.ToViewTransformer(object,this._from,this._to)}else{if(Sirius.Utils.is_function(this._to)){return new Sirius.Internal.ToFunctionTransformer(object,this._from,this._to)}}}}else{throw new Error("Not all parameters defined for transformer: from: "+this._from+", to: "+this._to)}};Transformer.draw=function(object){var logger;logger=Sirius.Application.get_logger();logger.debug("Draw Transformer",logger.transformer);return object};return Transformer})();Sirius.Collection=(function(){Collection._EVENTS=["add","remove"];function Collection(){var args,attrs,e,klass,klasses,len,n,options,ref;klass=arguments[0],args=2<=arguments.length?slice.call(arguments,1):[];if(klass.__super__.__name!=="BaseModel"){throw new Error("Collection must be used only with `BaseModel` inheritor")}this._array=[];this.logger=Sirius.Application.get_logger();klasses=[];options={};if(args.length===1){if(Sirius.Utils.is_array(args[0])){klasses=args[0]}else{options=args[0]}}if(args.length===2){klasses=args[0];options=args[1]}this._klasses=klasses;this._klass=klass;this._type=Sirius.Utils.fn_name(klass);this._indexes=options.index||[];if(this._indexes.length>0){attrs=klass.prototype.attrs().map(function(attr){if(Sirius.Utils.is_object(attr)){return Object.keys(attr)[0]}else{return attr}});this._indexes.forEach(function(field){if(attrs.indexOf(field)===-1){throw new Error("Collection: field "+field+" from indexes: ["+this._indexes+"] not exist in "+this._type)}});this._indexes.forEach((function(_this){return function(field){_this.logger.info("create index for "+field+" field in "+_this._type,_this.logger.collection);return _this["index_"+field]={}}})(this))}this._subscribers={};ref=this.constructor._EVENTS;for(n=0,len=ref.length;n<len;n++){e=ref[n];this._subscribers[e]=[]}this.length=0}Collection.prototype.push=function(model){return this.add(model)};Collection.prototype.add=function(model){this._add(model)};Collection.prototype._add=function(model){var msg,type;type=Sirius.Utils.fn_name(model.constructor);if(this._type!==type){msg="Require `"+this._type+"`, but given `"+type+"`";this.logger.error("Collection: "+msg,this.logger.collection);throw new Error(msg)}this._array.push(model);if(this._indexes.length>0){this._indexes.forEach((function(_this){return function(field){return _this["index_"+field][model.get(field)]=_this.length}})(this))}this.length++;return this._gen("add",model)};Collection.prototype.remove=function(other){var inx;inx=this.index(other);if(inx!==null){this._array.splice(inx,1);this._gen("remove",other);this.length--;if(this._indexes.length>0){this._indexes.forEach((function(_this){return function(field){var fields;delete _this["index_"+field][other.get(field)];fields=Object.keys(_this["index_"+field]);return fields.filter(function(x){return _this["index_"+field][x]>inx}).map(function(x){var z;z=_this["index_"+field][x];return _this["index_"+field][x]=z-1})}})(this))}}};Collection.prototype.index=function(other){var i,inx,len,model,n,ref;inx=null;ref=this._array;for(i=n=0,len=ref.length;n<len;i=++n){model=ref[i];if(model.compare(other)){inx=i}}return inx};Collection.prototype.find=function(key,value){return this.find_all(key,value)[0]||null};Collection.prototype.find_all=function(key,value){var len,model,n,ref,results;if(this._indexes.length>0&&this._indexes.indexOf(key)!==-1){return[this._array[this["index_"+key][value]]]}else{ref=this._array;results=[];for(n=0,len=ref.length;n<len;n++){model=ref[n];if(model.get(key)===value){results.push(model)}}return results}};Collection.prototype.filter=function(fn){var len,model,n,ref,results;if(fn==null){fn=function(){}}ref=this._array;results=[];for(n=0,len=ref.length;n<len;n++){model=ref[n];if(fn.call(null,model)){results.push(model)}}return results};Collection.prototype.each=function(fn){var len,model,n,ref,results;if(fn==null){fn=function(){}}ref=this._array;results=[];for(n=0,len=ref.length;n<len;n++){model=ref[n];results.push(fn.call(model))}return results};Collection.prototype.first=function(){return this._array[0]};Collection.prototype.last=function(){return this._array[this._array.length-1]};Collection.prototype.all=function(){return this._array};Collection.prototype.clear=function(){this.length=0;this._array=[];if(this._indexes.length>0){return this._indexes.forEach((function(_this){return function(field){return _this["index_"+field]={}}})(this))}};Collection.prototype.map=function(f){return this.collect(f)};Collection.prototype.collect=function(f){return this._array.map(f)};Collection.prototype.takeFirst=function(f){var e,len,n,ref,result;result=null;ref=this._array;for(n=0,len=ref.length;n<len;n++){e=ref[n];if(f(e)){result=e;break}}return result};Collection.prototype.size=function(){return this._array.length};Collection.prototype.from_json=function(json){var j,jj,len,n;j=JSON.stringify(json);if(Sirius.Utils.is_array(j)){for(n=0,len=j.length;n<len;n++){jj=j[n];this._array.push(this._klass.from_json(jj));this.length++}}else{this._array.push(this._klass.from_json(json));this.length++}return this};Collection.prototype.to_json=function(){var e,z;z=(function(){var len,n,ref,results;ref=this._array;results=[];for(n=0,len=ref.length;n<len;n++){e=ref[n];results.push(e.to_json())}return results}).call(this);return JSON.parse(JSON.stringify(z))};Collection.prototype.subscribe=function(event,fn_or_event){if(this.constructor._EVENTS.indexOf(event)===-1){throw new Error("For 'subscribe' method available only ["+this.constructor._EVENTS+"], but given '"+event+"'")}if(Sirius.Utils.is_string(fn_or_event)||Sirius.Utils.is_function(fn_or_event)){this.logger.info("Collection: Add new subscriber for '"+event+"' event",this.logger.collection);this._subscribers[event].push(fn_or_event)}else{throw new Error("Second parameter for 'subscribe' method must be Function or String, but '"+(typeof fn_or_event)+"' given")}};Collection.prototype._gen=function(){var args,event,subscribers;event=arguments[0],args=2<=arguments.length?slice.call(arguments,1):[];subscribers=this._subscribers[event];return Sirius.Application.get_adapter().and_then(function(adapter){var len,n,results,subsriber;results=[];for(n=0,len=subscribers.length;n<len;n++){subsriber=subscribers[n];if(Sirius.Utils.is_string(subsriber)){results.push(adapter.fire.apply(adapter,[document,subsriber].concat(slice.call(args))))}else{results.push(subsriber.apply(null,args))}}return results})};return Collection})();