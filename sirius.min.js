/*!
 *  Sirius.js v0.1.3
 *  (c) 2014 fntzr
 *  license: MIT
 */
;var Sirius,__slice=[].slice,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key)){child[key]=parent[key]}}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child};Sirius={VERSION:"0.1.3"};Sirius.redirect=function(url){return location.replace(url)};Sirius.Utils=(function(){function Utils(){}Utils.is_function=function(a){return Object.prototype.toString.call(a)==="[object Function]"};Utils.is_string=function(a){return Object.prototype.toString.call(a)==="[object String]"};Utils.is_array=function(a){return Object.prototype.toString.call(a)==="[object Array]"};Utils.camelize=function(str){return str.charAt(0).toUpperCase()+str.slice(1)};Utils.underscore=function(str){return str.replace(/([A-Z])/g,"_$1").replace(/^_/,"").toLowerCase()};return Utils})();Sirius.RoutePart=(function(){function RoutePart(route){var parts;this.end=true;this.start=null;this.parts=[];this.args=[];parts=route.replace(/\/$/,"").split("/");if(parts[parts.length-1]==="*"){this.end=false}this.parts=parts.slice(0)}RoutePart.prototype.match=function(url){var args,cp,gp,i,is_end_part,is_named_part,is_regexp_part,parts,r,_ref;this.args=[];parts=url.replace(/\/$/,"").split("/");if((parts.length!==this.parts.length)&&this.end){return false}if((this.parts.length>1)&&parts.length<this.parts.length){return false}is_named_part=function(part){return part.indexOf(":")===0};is_regexp_part=function(part){return part.indexOf("[")===0};is_end_part=function(part){return part.indexOf("*")===0};i=-1;args=[];while(i<10){i++;_ref=[this.parts[i],parts[i]],cp=_ref[0],gp=_ref[1];if(!cp||!gp){break}if(is_named_part(cp)){args.push(parts[i]);continue}if(is_regexp_part(cp)){r=new RegExp("^"+cp+"$");if(!r.test(gp)){return false}args.push(r.exec(gp)[0]);continue}if(is_end_part(cp)){args=args.concat(parts.slice(i));break}if(cp!==gp){return false}}this.args=args;return true};return RoutePart})();Sirius.ControlFlow=(function(){function ControlFlow(params){var act,controller,extract;controller=params.controller||(function(){throw new Error("Params must contain a Controller")})();act=params.action;this.action=(function(){if(Sirius.Utils.is_string(act)){return controller[act]}else{if(Sirius.Utils.is_function(act)){return act}else{throw new Error("Action must be string or function")}}})();if(!Sirius.Utils.is_function(this.action)&&!Sirius.Utils.is_string(this.action)){throw new Error("Action must be string or function")}extract=(function(_this){return function(property,is_guard){var err,k,p,t;if(is_guard==null){is_guard=false}p=params[property];k=controller[""+property+"_"+act];err=function(a){return new Error(""+a+" action must be string or function")};if(Sirius.Utils.is_string(p)){t=controller[p];if(!Sirius.Utils.is_function(t)){throw err(Sirius.Utils.camelize(property))}return t}else{if(Sirius.Utils.is_function(p)){return p}else{if(p){throw err(Sirius.Utils.camelize(property))}else{if(k){if(!Sirius.Utils.is_function(k)){throw err(Sirius.Utils.camelize(property))}return k}else{if(!is_guard){return function(){}}else{return null}}}}}}})(this);this.before=extract("before");this.after=extract("after");this.guard=extract("guard",true);this.data=params.data||null}ControlFlow.prototype.handle_event=function(){var args,data,e,merge;e=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];if(e){data=Sirius.Utils.is_array(this.data)?this.data:this.data?[this.data]:[];data=Sirius.Application.adapter.get_property(e,data);merge=[].concat([],[e],data);if(this.guard){if(this.guard.apply(null,merge)){this.before();this.action.apply(null,merge);return this.after()}}else{this.before();this.action.apply(null,merge);return this.after()}}else{if(this.guard){if(this.guard.apply(null,args)){this.before();this.action.apply(null,args);return this.after()}}else{this.before();this.action.apply(null,args);return this.after()}}};return ControlFlow})();Sirius.RouteSystem={create:function(routes,fn){var action,array_of_routes,current,prev,url;if(fn==null){fn=function(){}}current=prev=window.location.hash;for(url in routes){action=routes[url];if(url.indexOf("#")!==0&&url.toString()!=="404"){(function(_this){return(function(url,action){var event_name,handler,selector,z;handler=Sirius.Utils.is_function(action)?action:function(e){return(new Sirius.ControlFlow(action)).handle_event(e)};z=url.match(/^([a-zA-Z:]+)(\s+)?(.*)?/);event_name=z[1];selector=z[3]||document;return Sirius.Application.adapter.bind(selector,event_name,handler)})})(this)(url,action)}}array_of_routes=(function(){var _results;_results=[];for(url in routes){action=routes[url];if(url.toString()!=="404"){_results.push((function(url,action){url=new Sirius.RoutePart(url);action=Sirius.Utils.is_function(action)?action:new Sirius.ControlFlow(action);return[url,action]})(url,action))}}return _results})();window.onhashchange=(function(_this){return function(e){var part,r404,result,z,_fn,_i,_len;prev=current;current=window.location.hash;result=false;Sirius.Application.logger("Url change to: "+current);Sirius.Application.adapter.fire(document,"application:hashchange",current,prev);_fn=function(part){var f,r,z;f=part[0];r=f.match(current);if(r&&!result){result=true;z=part[1];if(z.handle_event){z.handle_event(null,f.args)}else{z.apply(null,f.args)}}};for(_i=0,_len=array_of_routes.length;_i<_len;_i++){part=array_of_routes[_i];_fn(part)}if(!result){Sirius.Application.adapter.fire(document,"application:404",current,prev);r404=routes["404"];if(r404){z=new Sirius.ControlFlow(r404);return z.handle_event(null,current)}}}})(this);return fn()}};Sirius.Application={log:false,adapter:null,running:false,route:{},start:"#",logger:function(msg){if(!this.log){return}if(window.console){return console.log(msg)}else{return alert("Not supported `console`")}},run:function(options){var n;if(options==null){options={}}this.running=true;this.log=options.log||this.log;this.adapter=options.adapter||(function(){throw new Error("Specify adapter")})();this.route=options.route||this.route;this.logger=options.logger||this.logger;this.start=options.start||this.start;this.logger("Logger enabled? "+this.log);n=this.adapter.constructor.name;this.logger("Adapter: "+n);Sirius.RouteSystem.create(this.route,(function(_this){return function(){return _this.adapter.fire(document,"application:run",new Date())}})(this));if(this.start){return Sirius.redirect(this.start)}}};Sirius.BaseModel=(function(){BaseModel.attrs=[];BaseModel.has_many=[];BaseModel.has_one=[];BaseModel.belongs_to=[];BaseModel.to={};BaseModel.form_name=null;BaseModel.guid_for=null;BaseModel.validate={};BaseModel.prototype.attrs=function(){return this.constructor.attrs||[]};BaseModel.prototype.normal_name=function(){return Sirius.Utils.underscore(this.constructor.name)};BaseModel.prototype.has_many=function(){return this.constructor.has_many||[]};BaseModel.prototype.has_one=function(){return this.constructor.has_one||[]};BaseModel.prototype.belongs_to=function(){return this.constructor.belongs_to||[]};BaseModel.prototype.validators=function(){return this.constructor.validate};BaseModel.prototype.guid_for=function(){return this.constructor.guid_for};BaseModel.prototype.normalize_attrs=function(){var a,_i,_len,_ref,_results;_ref=this.constructor.attrs;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){a=_ref[_i];_results.push((function(a){if(typeof a==="object"){return Object.keys(a)[0]}else{return a}})(a))}return _results};function BaseModel(obj){var attr,g,key,klass,_i,_j,_k,_l,_len,_len1,_len2,_len3,_ref,_ref1,_ref2,_ref3,_ref4;if(obj==null){obj={}}this._isValid=false;this.errors={};this.attributes=this.normalize_attrs();_ref=this.attrs();for(_i=0,_len=_ref.length;_i<_len;_i++){attr=_ref[_i];if(typeof attr==="object"){_ref1=Object.keys(attr),key=_ref1[0];if(!key){throw new Error("Attributes should have a key and value")}this["_"+key]=attr[key]}else{this["_"+attr]=null}}_ref2=this.has_many();for(_j=0,_len1=_ref2.length;_j<_len1;_j++){klass=_ref2[_j];this["_"+klass]=[];this.attributes.push(""+klass);this._has_create(klass)}_ref3=this.has_one();for(_k=0,_len2=_ref3.length;_k<_len2;_k++){klass=_ref3[_k];this["_"+klass]=null;this.attributes.push(""+klass);this._has_create(klass,true)}if(Object.keys(obj).length!==0){_ref4=Object.keys(obj);for(_l=0,_len3=_ref4.length;_l<_len3;_l++){attr=_ref4[_l];this.set(attr,obj[attr])}}if(g=this.guid_for()){this.set(g,this._generate_guid())}this.after_create()||function(){}}BaseModel.prototype._generate_guid=function(){var s4;s4=function(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)};return""+(s4())+(s4())+"-"+(s4())+"-"+(s4())+"-"+(s4())+"-"+(s4())+(s4())+(s4())};BaseModel.prototype._has_create=function(klass,is_one){if(is_one==null){is_one=false}return this["add_"+klass]=(function(_this){return function(z){var b_model,back,expected,i,key,m_name,me,name;name=z.constructor.name;me=_this.normal_name();m_name=_this.constructor.name;expected=klass.charAt(0).toUpperCase()+klass.slice(1);if(name!==expected){throw new Error("Expected "+expected+", but given: "+name)}if(is_one){if(_this.get(""+klass)){throw new Error("Model "+expected+" already exist for "+m_name)}_this.set(""+klass,z)}else{_this.get(""+klass).push(z)}b_model=((function(){var _i,_len,_ref,_results;_ref=z.belongs_to();_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){i=_ref[_i];if(i.model===me){_results.push(i)}}return _results})())[0];if(!b_model){throw new Error("Model "+name+" must contain '@belongs_to: [{model: "+me+", back: "+me+"_id]'")}if(!(back=b_model.back)){throw new Error("Define 'back' property for @belongs_to")}if(_this.attributes.indexOf(back)===-1){throw new Error("Foreign key: '"+back+"' not contain in a '"+m_name+"' model")}key=""+me+"_"+back;if(z.attributes.indexOf(key)===-1){throw new Error("Define "+key+" in @attrs for '"+expected+"' model")}return z.set(""+key,_this.get(back))}})(this)};BaseModel.prototype.set=function(attr,value){if(this.attributes.indexOf(attr)===-1){throw new Error("Attribute '"+attr+"' not found for "+(this.normal_name().toUpperCase())+" model")}return this["_"+attr]=value};BaseModel.prototype.get=function(attr){if(this.attributes.indexOf(attr)===-1){throw new Error("Attribute '"+attr+"' not found for "+(this.normal_name().toUpperCase())+" model")}return this["_"+attr]};BaseModel.prototype.valid=function(){return this._isValid};BaseModel.prototype.validate=function(){var current_value,e,key,klass,r,v,validator,value,vv,z,_base,_name,_ref;this.errors={};vv=this.validators();for(key in vv){value=vv[key];current_value=this.get(key);for(validator in value){v=value[validator];klass=(function(){switch(validator){case"length":return new Sirius.LengthValidator();case"exclusion":return new Sirius.ExclusionValidator();case"inclusion":return new Sirius.InclusionValidator();case"format":return new Sirius.FormatValidator();case"numericality":return new Sirius.NumericalityValidator();case"presence":return new Sirius.PresenceValidator();case"validate_with":z=new Sirius.Validator();z.validate=v;z.msg=null;return z}})();r=klass.validate(current_value,v);if(!r){e=typeof v==="object"?v.error||klass.error_message():klass.error_message();((_base=this.errors)[_name=""+key]!=null?_base[_name]:_base[_name]=[]).push(""+e)}}}return this._isValid=(_ref=Object.keys(this.errors).length===0)!=null?_ref:{"true":false}};BaseModel.prototype.save=function(exception){var name;if(exception==null){exception=false}this.validate();name=this.constructor.name;if(exception&&!this._isValid){throw new Error(""+name+" model not valid!")}if(this._isValid){return false}return true};BaseModel.prototype.to_json=function(root){var attr,name,o,v,value,z,_i,_len,_ref;if(root==null){root=false}z={};_ref=this.attributes;for(_i=0,_len=_ref.length;_i<_len;_i++){attr=_ref[_i];value=this.get(""+attr);z[""+attr]=(function(){var _j,_len1,_results;if(this.has_many().indexOf(attr)>-1){_results=[];for(_j=0,_len1=value.length;_j<_len1;_j++){v=value[_j];_results.push(JSON.parse(v.to_json()))}return _results}else{if(this.has_one().indexOf(attr)>-1){return JSON.parse(value.to_json())}else{return value}}}).call(this)}if(root){o={};name=this.normal_name();o[name]=z;return JSON.stringify(o)}else{return JSON.stringify(z)}};BaseModel.prototype.to_html=function(){var attr,k,key,obj,result,tag,to,v,value;to=this.constructor.to||{};result=(function(){var _i,_len,_ref,_results;_ref=this.attributes;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){key=_ref[_i];value=this.get(key);obj=to[key]||{};tag=obj.tag||"div";attr=(function(){var _results1;_results1=[];for(k in obj){v=obj[k];if(k!=="tag"){_results1.push(""+k+" = '"+v+"'")}}return _results1})();attr=attr.length===0?"":" "+(attr.join(" "));value=(function(){var _j,_len1,_results1;if(this.has_many().indexOf(key)>-1){_results1=[];for(_j=0,_len1=value.length;_j<_len1;_j++){v=value[_j];_results1.push(v.to_html())}return _results1}else{if(this.has_one().indexOf(key)>-1){return value.to_html()}else{return value}}}).call(this);_results.push("<"+tag+attr+">"+value+"</"+tag+">")}return _results}).call(this);return result.join("")};BaseModel.from_json=function(json,models){var attr,attrs,key,m,model,value,z,_i,_len,_ref;if(models==null){models={}}m=new this;json=JSON.parse(json);attrs=[].concat(m.attrs(),m.has_many(),m.has_one());for(_i=0,_len=attrs.length;_i<_len;_i++){attr=attrs[_i];if(typeof attr==="object"){_ref=Object.keys(attr),key=_ref[0];m.set(key,json[key]||attr[key])}else{value=(function(){var _j,_len1,_ref1,_results;if(m.has_many().indexOf(attr)>-1){model=models[attr];if(model){_ref1=json[attr];_results=[];for(_j=0,_len1=_ref1.length;_j<_len1;_j++){z=_ref1[_j];_results.push(model.from_json(JSON.stringify(z),models))}return _results}else{return json[attr]}}else{if(m.has_one().indexOf(attr)>-1){model=models[attr];if(model){return model.from_json(JSON.stringify(json[attr]),models)}else{return json[attr]}}else{return json[attr]}}})();m.set(attr,value||m.get(attr))}}return m};BaseModel.from_html=function(selector){var form_name;form_name=selector||this.form_name||Sirius.Utils.underscore(this.name);return this.from_json(Sirius.Application.adapter.form_to_json(form_name))};BaseModel.prototype.compare=function(other){throw new Error("`compare` method must be overridden")};BaseModel.prototype.after_create=function(){};return BaseModel})();Sirius.Collection=(function(){function Collection(klass,klasses,options){if(klasses==null){klasses=[]}if(options==null){options={every:0,on_add:this.on_add,on_remove:this.on_remove,remote:null,on_push:this.on_push}}if(klass.__super__.constructor.name!=="BaseModel"){throw new Error("Collection must be used only with `BaseModel` inheritor")}this._array=[];this._klasses=klasses;this._type=klass.name;this.on_add=options.on_add||this.on_add;this.on_push=options.on_push||this.on_push;this.on_remove=options.on_push||this.on_remove;if(options.remote){this.remote=(function(_this){return function(){var json,model,result,_i,_len,_results;result=options.remote();json=JSON.parse(result);if(Sirius.Utils.is_array(json)){if(json.length!==0){_results=[];for(_i=0,_len=json.length;_i<_len;_i++){model=json[_i];_results.push(_this.push(klass.from_json(JSON.stringify(model),_this._klasses)))}return _results}}else{return _this.push(klass.from_json(result,_this._klasses))}}})(this)}this._timer=null;this._start_sync(options.every||0)}Collection.prototype._start_sync=function(every){if(every!==0){return this._timer=setInterval(this.remote,every)}};Collection.prototype.unsync=function(){if(this._timer){return clearInterval(this._timer)}};Collection.prototype.sync=function(every){return this._start_sync(every)};Collection.prototype.push=function(model){this._add(model);return this.on_push(model)};Collection.prototype.add=function(model){this._add(model);return this.on_add(model)};Collection.prototype._add=function(model){var type;type=model.constructor.name;if(this._type!==type){throw new Error("Require `"+this._type+"`, but given `"+model.constructor.name+"`")}return this._array.push(model)};Collection.prototype.remove=function(other){var inx;inx=this.index(other);if(inx!==null){this._array.splice(inx,1);return this.on_remove(other)}};Collection.prototype.index=function(other){var i,inx,model,_i,_len,_ref;inx=null;_ref=this._array;for(i=_i=0,_len=_ref.length;_i<_len;i=++_i){model=_ref[i];if(model.compare(other)){inx=i}}return inx};Collection.prototype.find=function(key,value){return this.find_all(key,value)[0]||null};Collection.prototype.find_all=function(key,value){var model,_i,_len,_ref,_results;_ref=this._array;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){model=_ref[_i];if(model.get(key)===value){_results.push(model)}}return _results};Collection.prototype.filter=function(fn){var model,_i,_len,_ref,_results;if(fn==null){fn=function(){}}_ref=this._array;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){model=_ref[_i];if(fn.call(null,model)){_results.push(model)}}return _results};Collection.prototype.each=function(fn){var model,_i,_len,_ref,_results;if(fn==null){fn=function(){}}_ref=this._array;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){model=_ref[_i];_results.push(fn.call(model))}return _results};Collection.prototype.first=function(){return this._array[0]};Collection.prototype.last=function(){return this._array[this._array.length-1]};Collection.prototype.all=function(){return this._array};Collection.prototype.size=function(){return this._array.length};Collection.prototype.on_remove=function(model){};Collection.prototype.on_add=function(model){};Collection.prototype.on_push=function(model){};return Collection})();Sirius.Validator=(function(){function Validator(){this.msg=null}Validator.prototype.error_message=function(){return this.msg};return Validator})();Sirius.LengthValidator=(function(_super){__extends(LengthValidator,_super);function LengthValidator(){return LengthValidator.__super__.constructor.apply(this,arguments)}LengthValidator.prototype.validate=function(value,attributes){var actual_length,length,max,min;max=attributes.max||Number.POSITIVE_INFINITY;min=attributes.min||Number.NEGATIVE_INFINITY;length=attributes.length;actual_length=value.length;if(length){if(actual_length===length){return true}else{this.msg="Required length: "+length+", given: "+actual_length;return false}}else{if((actual_length>=min)&&(actual_length<=max)){return true}else{this.msg="Required length in range ["+min+".."+max+"], given: "+actual_length;return false}}};return LengthValidator})(Sirius.Validator);Sirius.ExclusionValidator=(function(_super){__extends(ExclusionValidator,_super);function ExclusionValidator(){return ExclusionValidator.__super__.constructor.apply(this,arguments)}ExclusionValidator.prototype.validate=function(value,attributes){var range;range=attributes.within||[];if(range.indexOf(value)===-1){return true}else{this.msg="Value "+value+" reserved";return false}};return ExclusionValidator})(Sirius.Validator);Sirius.InclusionValidator=(function(_super){__extends(InclusionValidator,_super);function InclusionValidator(){return InclusionValidator.__super__.constructor.apply(this,arguments)}InclusionValidator.prototype.validate=function(value,attributes){var range;range=attributes.within||[];if(range.indexOf(value)>-1){return true}else{this.msg="Value "+value+" should be in range "+range;return false}};return InclusionValidator})(Sirius.Validator);Sirius.FormatValidator=(function(_super){__extends(FormatValidator,_super);function FormatValidator(){return FormatValidator.__super__.constructor.apply(this,arguments)}FormatValidator.prototype.validate=function(value,attributes){var format;format=attributes["with"]||(function(){throw new Error("format attribute required")})();if(format.test(value)){return true}else{this.msg="Value "+value+" not for current format";return false}};return FormatValidator})(Sirius.Validator);Sirius.NumericalityValidator=(function(_super){__extends(NumericalityValidator,_super);function NumericalityValidator(){return NumericalityValidator.__super__.constructor.apply(this,arguments)}NumericalityValidator.prototype.validate=function(value,attributes){if(attributes==null){attributes={}}if(attributes.only_integers){if(/^\d+$/.test(value)){return true}else{this.msg="Only allows integer numbers";return false}}else{if(/^\d+(?:\.\d{1,})?$/.test(value)){return true}else{this.msg="Only allows numbers";return false}}};return NumericalityValidator})(Sirius.Validator);Sirius.PresenceValidator=(function(_super){__extends(PresenceValidator,_super);function PresenceValidator(){return PresenceValidator.__super__.constructor.apply(this,arguments)}PresenceValidator.prototype.validate=function(value,attributes){if(attributes==null){attributes=true}if(value){return true}else{this.msg="Value required";return false}};return PresenceValidator})(Sirius.Validator);